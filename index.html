<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Admin - La Revue</title>
    
    <!-- Tailwind CSS -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js';
        import { getFirestore, collection, getDocs, doc, updateDoc, addDoc, deleteDoc, query, orderBy, where } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js';
        import { getStorage, ref, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-storage.js';

        // Configuration Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBjHNzW6i_d7HCZx_2K9Pv5JXIvafo1XNo",
            authDomain: "larevueapp-1f205.firebaseapp.com",
            projectId: "larevueapp-1f205",
            storageBucket: "larevueapp-1f205.firebasestorage.app",
            messagingSenderId: "248256257582",
            appId: "1:248256257582:web:a7b9281d0143e7ed35c9bf"
        };

        // Initialiser Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // Collections
        const COLLECTIONS = {
            ESTABLISHMENTS: 'establishments',
            USERS: 'users',
            REVIEWS: 'reviews',
            DEALS: 'deals',
            NEWS: 'news'
        };

        // Variables globales
        window.firebaseApp = { db, storage, COLLECTIONS };
        window.firebaseModules = { updateDoc, doc, addDoc, deleteDoc, ref, uploadBytes, getDownloadURL, getDocs, collection, query, where, orderBy };
        window.currentEstablishments = [];
        window.currentNews = [];
        window.currentReviews = [];
        window.currentStats = { hotels: 0, restaurants: 0, spas: 0, totalReviews: 0 };

        // ✅ NOUVELLE FONCTION DE GÉOCODAGE AUTOMATIQUE
        window.forceGeocodeAllHotels = async function() {
            console.log('🗺️ Début du géocodage automatique...');
            
            // Afficher message de démarrage
            showMessage('🔄 Démarrage du géocodage automatique...', 'info');
            
            try {
                // Récupérer tous les établissements
                const snapshot = await getDocs(collection(db, COLLECTIONS.ESTABLISHMENTS));
                let processedCount = 0;
                let successCount = 0;
                let errorCount = 0;
                let alreadyHaveCoords = 0;
                
                console.log(`📊 ${snapshot.docs.length} établissements trouvés`);
                showMessage(`📊 ${snapshot.docs.length} établissements à traiter...`, 'info');
                
                for (const docSnap of snapshot.docs) {
                    const establishment = docSnap.data();
                    processedCount++;
                    
                    console.log(`🏨 Traitement ${processedCount}/${snapshot.docs.length}: ${establishment.name}`);
                    
                    // Vérifier si les coordonnées existent déjà
                    if (establishment.coordinates && establishment.coordinates.latitude && establishment.coordinates.longitude) {
                        console.log(`✅ ${establishment.name} a déjà des coordonnées`);
                        alreadyHaveCoords++;
                        continue;
                    }
                    
                    if (!establishment.address) {
                        console.log(`⚠️ ${establishment.name} n'a pas d'adresse`);
                        errorCount++;
                        continue;
                    }
                    
                    try {
                        // Géocoder l'adresse
                        const coordinates = await geocodeAddress(establishment.address);
                        
                        if (coordinates) {
                            // Mettre à jour dans Firebase
                            const docRef = doc(db, COLLECTIONS.ESTABLISHMENTS, docSnap.id);
                            await updateDoc(docRef, {
                                coordinates: coordinates
                            });
                            
                            console.log(`✅ ${establishment.name} géocodé avec succès:`, coordinates);
                            successCount++;
                            
                            // Afficher progression
                            showMessage(`🗺️ ${establishment.name} géocodé avec succès! (${successCount + alreadyHaveCoords}/${snapshot.docs.length})`, 'success');
                        } else {
                            console.log(`❌ Échec du géocodage pour ${establishment.name}`);
                            errorCount++;
                        }
                        
                        // Attendre un peu pour éviter de surcharger l'API
                        await new Promise(resolve => setTimeout(resolve, 1000));
                        
                    } catch (error) {
                        console.error(`❌ Erreur lors du géocodage de ${establishment.name}:`, error);
                        errorCount++;
                    }
                }
                
                const finalMessage = `🎉 Géocodage terminé!\n✅ ${successCount} nouveaux géocodages\n💡 ${alreadyHaveCoords} déjà géocodés\n❌ ${errorCount} erreurs\n📊 Total: ${processedCount} établissements`;
                
                console.log(finalMessage);
                showMessage(finalMessage, 'success');
                
                // Recharger les données
                await loadDashboard();
                
            } catch (error) {
                console.error('❌ Erreur générale lors du géocodage:', error);
                showMessage('❌ Erreur lors du géocodage: ' + error.message, 'error');
            }
        };

        // ✅ FONCTION DE GÉOCODAGE AVEC L'API NOMINATIM
        async function geocodeAddress(address) {
            try {
                const encodedAddress = encodeURIComponent(address + ', France');
                const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodedAddress}&limit=1&addressdetails=1`;
                
                console.log(`🔍 Géocodage de: ${address}`);
                console.log(`🌐 URL API: ${url}`);
                
                const response = await fetch(url, {
                    headers: {
                        'User-Agent': 'La Revue Dashboard (admin@larevue.app)'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data && data.length > 0) {
                    const result = data[0];
                    const coordinates = {
                        latitude: parseFloat(result.lat),
                        longitude: parseFloat(result.lon)
                    };
                    
                    console.log(`✅ Coordonnées trouvées:`, coordinates);
                    console.log(`📍 Détails:`, result.display_name);
                    
                    return coordinates;
                } else {
                    console.log(`❌ Aucun résultat trouvé pour: ${address}`);
                    return null;
                }
            } catch (error) {
                console.error(`❌ Erreur de géocodage pour ${address}:`, error);
                return null;
            }
        }

        // ✅ FONCTION DE CALCUL DE LA NOTE GÉNÉRALE
        function calculateOverallRating(laRevueRating, usersRating) {
            const laRevue = parseFloat(laRevueRating) || 0;
            const users = parseFloat(usersRating) || 0;
            
            if (laRevue === 0 && users === 0) return 0;
            if (laRevue === 0) return users;
            if (users === 0) return laRevue;
            
            return parseFloat(((laRevue + users) / 2).toFixed(1));
        }
        window.calculateOverallRating = calculateOverallRating;

        // ✅ FONCTION UPLOAD IMAGES
        window.uploadImages = async (files) => {
            const urls = [];
            const uploadPromises = [];
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const timestamp = Date.now();
                const fileName = `${timestamp}_${i}_${file.name}`;
                const storageRef = ref(storage, `establishments/${fileName}`);
                
                uploadPromises.push(
                    uploadBytes(storageRef, file).then(async (snapshot) => {
                        const url = await getDownloadURL(snapshot.ref);
                        return url;
                    })
                );
            }
            
            try {
                const uploadedUrls = await Promise.all(uploadPromises);
                console.log('✅ Images uploadées:', uploadedUrls);
                return uploadedUrls;
            } catch (error) {
                console.error('❌ Erreur upload:', error);
                return [];
            }
        };

        // ✅ NOUVELLE FONCTION CORRECTION CATÉGORIES
        window.fixCategories = async () => {
            try {
                console.log('🔧 Correction des catégories en cours...');
                const establishmentsRef = collection(db, COLLECTIONS.ESTABLISHMENTS);
                const snapshot = await getDocs(establishmentsRef);
                
                const corrections = [];
                const categoryMap = {
                    'hotels': 'hotel',
                    'restaurants': 'restaurant',
                    'spas': 'spa'
                };
                
                snapshot.forEach((docSnap) => {
                    const data = docSnap.data();
                    const currentCategory = data.category;
                    
                    if (categoryMap[currentCategory]) {
                        corrections.push({
                            id: docSnap.id,
                            from: currentCategory,
                            to: categoryMap[currentCategory]
                        });
                    }
                });
                
                if (corrections.length === 0) {
                    showSuccess('✅ Aucune correction nécessaire !');
                    return;
                }
                
                const updatePromises = corrections.map(correction => {
                    const docRef = doc(db, COLLECTIONS.ESTABLISHMENTS, correction.id);
                    return updateDoc(docRef, { category: correction.to });
                });
                
                await Promise.all(updatePromises);
                
                showSuccess(`✅ ${corrections.length} catégories corrigées !`);
                console.log('✅ Corrections appliquées:', corrections);
                
                loadDashboard();
                
            } catch (error) {
                console.error('❌ Erreur correction catégories:', error);
                showError('Erreur lors de la correction des catégories');
            }
        };

        // ✅ FONCTION RECALCUL GLOBAL DES NOTES GÉNÉRALES AVEC TRI AUTOMATIQUE
        window.recalculateAllRatings = async () => {
            if (!confirm('Voulez-vous vraiment recalculer toutes les notes générales ? Cette action mettra à jour Firebase.')) {
                return;
            }
            
            showMessage('Recalcul en cours...', 'info');
            
            try {
                const establishmentsRef = collection(db, COLLECTIONS.ESTABLISHMENTS);
                const snapshot = await getDocs(establishmentsRef);
                let updated = 0;
                
                const updatePromises = [];
                
                snapshot.forEach((docSnap) => {
                    const data = docSnap.data();
                    const laRevueRating = data.laRevueRating || data.rating || 0;
                    const usersRating = data.usersRating || data.userRating || 0;
                    
                    const newOverallRating = calculateOverallRating(laRevueRating, usersRating);
                    
                    if (newOverallRating !== (data.overallRating || 0)) {
                        const docRef = doc(db, COLLECTIONS.ESTABLISHMENTS, docSnap.id);
                        updatePromises.push(
                            updateDoc(docRef, { overallRating: newOverallRating })
                        );
                        updated++;
                    }
                });
                
                await Promise.all(updatePromises);
                
                showMessage(`✅ ${updated} notes générales recalculées !`, 'success');
                
                await loadDashboard();
                
                if (updated > 0) {
                    setTimeout(() => {
                        if (confirm(`🏆 ${updated} notes ont été mises à jour !\n\nVoulez-vous trier automatiquement le classement par notes générales ?`)) {
                            window.sortByRating();
                        }
                    }, 1000);
                }
                
            } catch (error) {
                console.error('Erreur lors du recalcul:', error);
                showMessage('❌ Erreur lors du recalcul des notes', 'danger');
            }
        };

        // ✅ NOUVELLE FONCTION COMBO : RECALCULER + TRIER AUTOMATIQUEMENT
        window.recalculateAndSort = async () => {
            if (!confirm('🎯 Action combinée : Recalculer toutes les notes générales ET trier le classement.\n\nCette action mettra à jour Firebase et réorganisera complètement le classement.\n\nContinuer ?')) {
                return;
            }
            
            try {
                showMessage('🔄 Étape 1/2 : Recalcul des notes générales...', 'info');
                
                const establishmentsRef = collection(db, COLLECTIONS.ESTABLISHMENTS);
                const snapshot = await getDocs(establishmentsRef);
                let updated = 0;
                
                const updatePromises = [];
                
                snapshot.forEach((docSnap) => {
                    const data = docSnap.data();
                    const laRevueRating = data.laRevueRating || data.rating || 0;
                    const usersRating = data.usersRating || data.userRating || 0;
                    
                    const newOverallRating = calculateOverallRating(laRevueRating, usersRating);
                    
                    if (newOverallRating !== (data.overallRating || 0)) {
                        const docRef = doc(db, COLLECTIONS.ESTABLISHMENTS, docSnap.id);
                        updatePromises.push(
                            updateDoc(docRef, { overallRating: newOverallRating })
                        );
                        updated++;
                    }
                });
                
                await Promise.all(updatePromises);
                
                showMessage(`✅ Étape 1/2 terminée : ${updated} notes recalculées !`, 'success');
                
                showMessage('🔄 Étape 2/2 : Tri par notes générales...', 'info');
                
                await loadDashboard();
                
                setTimeout(async () => {
                    await window.sortByRating();
                    showMessage('🎉 Action terminée : Notes recalculées et classement trié !', 'success');
                }, 1000);
                
            } catch (error) {
                console.error('Erreur action combinée:', error);
                showMessage('❌ Erreur lors de l\'action combinée', 'danger');
            }
        };

        // ✅ FONCTION TRI PAR NOTES AMÉLIORÉE AVEC MEILLEUR FEEDBACK
        window.sortByRating = async () => {
            try {
                if (!window.currentEstablishments || window.currentEstablishments.length === 0) {
                    showError('Aucun établissement à trier');
                    return;
                }

                console.log('📊 Tri par note générale en cours...');
                showMessage('🔄 Tri du classement par notes générales...', 'info');
                showLoading(true);

                const sortedEstablishments = [...window.currentEstablishments].sort((a, b) => {
                    const ratingA = calculateOverallRating(a.laRevueRating, a.usersRating);
                    const ratingB = calculateOverallRating(b.laRevueRating, b.usersRating);
                    
                    console.log(`Comparaison: ${a.name} (${ratingA}) vs ${b.name} (${ratingB})`);
                    
                    return ratingB - ratingA;
                });

                const top3 = sortedEstablishments.slice(0, 3).map((est, index) => {
                    const rating = calculateOverallRating(est.laRevueRating, est.usersRating);
                    const medal = index === 0 ? '🏆' : index === 1 ? '🥈' : '🥉';
                    return `${medal} ${est.name} (${rating}/10)`;
                }).join('\n');

                const updatePromises = sortedEstablishments.map(async (establishment, index) => {
                    const newRank = index + 1;
                    
                    if (establishment.rank !== newRank) {
                        try {
                            await window.updateEstablishmentRank(establishment.id, newRank);
                            console.log(`✅ Rang mis à jour pour ${establishment.name}: #${newRank}`);
                        } catch (error) {
                            console.error(`❌ Erreur rang pour ${establishment.name}:`, error);
                        }
                    }
                });

                await Promise.all(updatePromises);
                
                const topEstablishment = sortedEstablishments[0];
                const topRating = calculateOverallRating(topEstablishment.laRevueRating, topEstablishment.usersRating);

                setTimeout(() => {
                    showMessage(`🏆 Classement mis à jour !\n\nNouveau podium :\n${top3}`, 'success');
                    
                    setTimeout(() => {
                        if (confirm(`🎯 Tri terminé avec succès !\n\n${top3}\n\nVoulez-vous voir le classement complet ?`)) {
                        }
                    }, 2000);
                }, 500);
                
                await loadDashboard();
                
            } catch (error) {
                console.error('❌ Erreur tri par notes:', error);
                showError('Erreur lors du tri par notes');
            } finally {
                showLoading(false);
            }
        };

        // ✅ NOUVELLE FONCTION IMPORT JSON EN LOT
        window.importEstablishments = async (jsonData) => {
            try {
                console.log('📦 Import en lot en cours...', jsonData);
                
                if (!Array.isArray(jsonData)) {
                    jsonData = [jsonData];
                }

                let successCount = 0;
                let errorCount = 0;
                const errors = [];

                for (const establishment of jsonData) {
                    try {
                        if (!establishment.name || !establishment.category) {
                            errors.push(`Établissement sans nom ou catégorie : ${JSON.stringify(establishment)}`);
                            errorCount++;
                            continue;
                        }

                        const laRevueRating = parseFloat(establishment.rating || establishment.laRevueRating || 7);
                        const usersRating = parseFloat(establishment.userRating || establishment.usersRating || 7);
                        const overallRating = calculateOverallRating(laRevueRating, usersRating);

                        const normalizedData = {
                            name: establishment.name,
                            category: establishment.category,
                            address: establishment.address || 'Adresse non renseignée',
                            region: establishment.region || 'ile-de-france',
                            laRevueRating: laRevueRating,
                            usersRating: usersRating,
                            overallRating: overallRating,
                            priceLevel: parseInt(establishment.priceLevel || 3),
                            description: establishment.description || '',
                            longDescription: establishment.longDescription || establishment.description || '',
                            shortDescription: establishment.shortDescription || establishment.description || '',
                            isFeatured: establishment.isFeatured || false,
                            reservationUrl: establishment.reservationUrl || '',
                            positiveReviews: establishment.positiveReviews || '89%',
                            negativeReviews: establishment.negativeReviews || '11%',
                            positiveReviewExample: establishment.positiveReviewExample || '',
                            negativeReviewExample: establishment.negativeReviewExample || '',
                            promoCode: establishment.promoCode || '',
                            promoDiscount: establishment.promoDiscount || '',
                            images: establishment.images || [],
                            // ✅ NOUVEAU : Champs d'évaluation détaillée
                            detailedEvaluation: establishment.detailedEvaluation || {
                                criteriaRatings: {},
                                strengths: [],
                                weaknesses: [],
                                summary: ''
                            },
                            topPosition: establishment.rank || establishment.topPosition || (window.currentEstablishments.length + successCount + 1),
                            createdAt: new Date(),
                            isActive: true
                        };

                        const docRef = await addDoc(collection(db, COLLECTIONS.ESTABLISHMENTS), normalizedData);
                        console.log(`✅ Établissement créé: ${normalizedData.name} (${docRef.id})`);
                        successCount++;

                    } catch (error) {
                        console.error(`❌ Erreur pour ${establishment.name}:`, error);
                        errors.push(`${establishment.name}: ${error.message}`);
                        errorCount++;
                    }
                }

                if (successCount > 0) {
                    showSuccess(`✅ ${successCount} établissement${successCount > 1 ? 's' : ''} importé${successCount > 1 ? 's' : ''} avec succès !`);
                }

                if (errorCount > 0) {
                    console.error('❌ Erreurs d\'import:', errors);
                    showError(`❌ ${errorCount} erreur${errorCount > 1 ? 's' : ''} lors de l'import. Voir la console pour les détails.`);
                }

                await loadDashboard();

            } catch (error) {
                console.error('❌ Erreur import général:', error);
                showError('Erreur lors de l\'import: ' + error.message);
            }
        };

        // ✅ FONCTIONS GESTION ACTUALITÉS
        window.loadNews = async () => {
            try {
                console.log('🔥 Chargement des actualités...');
                const newsRef = collection(db, COLLECTIONS.NEWS);
                const q = query(newsRef, orderBy('publishedAt', 'desc'));
                const snapshot = await getDocs(q);
                
                const newsData = [];
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    console.log('📰 Actualité trouvée:', data);
                    
                    newsData.push({
                        id: doc.id,
                        title: data.title || 'Sans titre',
                        summary: data.summary || '',
                        imageUrl: data.imageUrl || 'https://images.unsplash.com/photo-1566073771259-6a8506099945?w=400',
                        articleUrl: data.articleUrl || '',
                        author: data.author || 'La Revue',
                        publishedAt: data.publishedAt || new Date(),
                        category: data.category || 'Actualités',
                        establishmentType: data.establishmentType || 'hotels',
                        isFeatured: data.isFeatured || false,
                        isActive: data.isActive || true,
                        city: data.city || '',        
                        region: data.region || ''     
                    });
                });
                
                console.log(`✅ ${newsData.length} actualités chargées`);
                window.currentNews = newsData;
                return newsData;
            } catch (error) {
                console.error('❌ Erreur chargement actualités:', error);
                return [];
            }
        };

        // ✅ FONCTIONS GESTION AVIS
        window.loadReviews = async () => {
            try {
                console.log('🔥 Chargement des avis...');
                const reviewsRef = collection(db, COLLECTIONS.REVIEWS);
                const q = query(reviewsRef, orderBy('createdAt', 'desc'));
                const snapshot = await getDocs(q);
                
                const reviewsData = [];
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    reviewsData.push({
                        id: doc.id,
                        ...data,
                        createdAt: data.createdAt?.toDate ? data.createdAt.toDate() : new Date(data.createdAt),
                        status: data.status || 'pending'
                    });
                });
                
                console.log(`✅ ${reviewsData.length} avis chargés`);
                window.currentReviews = reviewsData;
                return reviewsData;
            } catch (error) {
                console.error('❌ Erreur chargement avis:', error);
                return [];
            }
        };

        window.updateReview = async (id, data) => {
            try {
                const docRef = doc(db, COLLECTIONS.REVIEWS, id);
                await updateDoc(docRef, data);
                console.log(`✅ Avis mis à jour: ${id}`);
                return true;
            } catch (error) {
                console.error('❌ Erreur mise à jour avis:', error);
                return false;
            }
        };

        // ✅ FONCTION MODIFIÉE POUR GÉRER MULTIPLE FEATURED PAR TYPE D'ÉTABLISSEMENT
        window.addNewNews = async (data) => {
            try {
                console.log('🔥 Création nouvelle actualité:', data);
                
                if (data.isFeatured) {
                    const featuredNewsQuery = await getDocs(
                        query(
                            collection(db, COLLECTIONS.NEWS),
                            where('isFeatured', '==', true),
                            where('establishmentType', '==', data.establishmentType)
                        )
                    );
                    
                    const updatePromises = [];
                    featuredNewsQuery.forEach((doc) => {
                        const docRef = window.firebaseModules.doc(db, COLLECTIONS.NEWS, doc.id);
                        updatePromises.push(window.firebaseModules.updateDoc(docRef, { isFeatured: false }));
                    });
                    await Promise.all(updatePromises);
                    
                    console.log(`✅ ${updatePromises.length} actualité(s) ${data.establishmentType} désactivée(s) de "à la une"`);
                }
                
                const docRef = await addDoc(collection(db, COLLECTIONS.NEWS), {
                    ...data,
                    createdAt: new Date(),
                    isActive: true
                });
                console.log(`✅ Nouvelle actualité créée: ${docRef.id}`);
                return docRef.id;
            } catch (error) {
                console.error('❌ Erreur création actualité:', error);
                return null;
            }
        };

        window.updateNews = async (id, data) => {
            try {
                if (data.isFeatured) {
                    const featuredNewsQuery = await getDocs(
                        query(
                            collection(db, COLLECTIONS.NEWS),
                            where('isFeatured', '==', true),
                            where('establishmentType', '==', data.establishmentType)
                        )
                    );
                    
                    const updatePromises = [];
                    featuredNewsQuery.forEach((doc) => {
                        if (doc.id !== id) {
                            const docRef = window.firebaseModules.doc(db, COLLECTIONS.NEWS, doc.id);
                            updatePromises.push(window.firebaseModules.updateDoc(docRef, { isFeatured: false }));
                        }
                    });
                    await Promise.all(updatePromises);
                    
                    console.log(`✅ ${updatePromises.length} autre(s) actualité(s) ${data.establishmentType} désactivée(s) de "à la une"`);
                }
                
                const docRef = doc(db, COLLECTIONS.NEWS, id);
                await updateDoc(docRef, {
                    ...data,
                    updatedAt: new Date()
                });
                console.log(`✅ Actualité mise à jour: ${id}`);
                return true;
            } catch (error) {
                console.error('❌ Erreur mise à jour actualité:', error);
                return false;
            }
        };

        window.deleteNews = async (id) => {
            try {
                await deleteDoc(doc(db, COLLECTIONS.NEWS, id));
                console.log(`✅ Actualité supprimée: ${id}`);
                return true;
            } catch (error) {
                console.error('❌ Erreur suppression actualité:', error);
                return false;
            }
        };

        // ✅ FONCTION CHARGEMENT ÉTABLISSEMENTS CORRIGÉE POUR LES SPAS
        window.loadEstablishments = async (type = 'hotels') => {
            try {
                console.log(`🔥 Chargement des ${type}...`);
                const establishmentsRef = collection(db, COLLECTIONS.ESTABLISHMENTS);
                const snapshot = await getDocs(establishmentsRef);
                
                const establishments = [];
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    console.log('🔍 Document trouvé:', doc.id, data);
                    
                    const docType = data.category || data.type;
                    let shouldInclude = false;
                    
                    if (type === 'hotels') {
                        shouldInclude = docType === 'hotels' || docType === 'hotel';
                    } else if (type === 'restaurants') {
                        shouldInclude = docType === 'restaurants' || docType === 'restaurant';
                    } else if (type === 'spas') {
                        shouldInclude = docType === 'spas' || docType === 'spa';
                    } else {
                        shouldInclude = docType === type;
                    }
                    
                    if (shouldInclude) {
                        console.log(`✅ Établissement ${docType} inclus pour la recherche ${type}:`, data.name);
                        
                        const laRevueRating = parseFloat(data.laRevueRating || data.rating || 7);
                        const usersRating = parseFloat(data.usersRating || data.userRating || 7);
                        
                        establishments.push({
                            id: doc.id,
                            name: data.name || 'Sans nom',
                            address: data.address || 'Sans adresse',
                            laRevueRating: laRevueRating,
                            usersRating: usersRating,
                            overallRating: data.overallRating || calculateOverallRating(laRevueRating, usersRating),
                            rank: data.topPosition || data.rank || establishments.length + 1,
                            priceLevel: data.priceLevel || 3,
                            description: data.longDescription || data.shortDescription || data.description || '',
                            category: docType,
                            region: data.region || data.city || 'ile-de-france',
                            city: data.city || data.region || 'Ville non renseignée',
                            promoCode: data.promoCode || '',
                            promoDiscount: data.promoDiscount || '',
                            images: data.images || [],
                            isFeatured: data.isFeatured || false,
                            reservationUrl: data.reservationUrl || '',
                            positiveReviews: data.positiveReviews || '89%',
                            negativeReviews: data.negativeReviews || '11%',
                            positiveReviewExample: data.positiveReviewExample || '',
                            negativeReviewExample: data.negativeReviewExample || '',
                            // ✅ NOUVEAU : Évaluation détaillée
                            detailedEvaluation: data.detailedEvaluation || {
                                criteriaRatings: {},
                                strengths: [],
                                weaknesses: [],
                                summary: ''
                            },
                            // ✅ NOUVEAU : Coordonnées GPS
                            coordinates: data.coordinates || null
                        });
                    } else {
                        console.log(`❌ Établissement ${docType} EXCLU pour la recherche ${type}:`, data.name);
                    }
                });
                
                establishments.sort((a, b) => (a.rank || 999) - (b.rank || 999));
                window.currentEstablishments = establishments;
                console.log(`✅ ${establishments.length} établissements ${type} chargés au final`);
                return establishments;
            } catch (error) {
                console.error('❌ Erreur chargement:', error);
                return [];
            }
        };

        // Autres fonctions Firebase
        window.updateEstablishmentRank = async (id, newRank) => {
            try {
                const docRef = doc(db, COLLECTIONS.ESTABLISHMENTS, id);
                await updateDoc(docRef, { topPosition: newRank });
                console.log(`✅ Rang mis à jour pour ${id}`);
                return true;
            } catch (error) {
                console.error('❌ Erreur mise à jour rang:', error);
                return false;
            }
        };

        // ✅ FONCTION MISE À JOUR NOTE CORRIGÉE AVEC CALCUL AUTO DE LA NOTE GÉNÉRALE
        window.updateEstablishmentRating = async (id, rating, type = 'rating') => {
            try {
                const establishment = window.currentEstablishments.find(e => e.id === id);
                if (!establishment) {
                    console.error('Établissement non trouvé:', id);
                    return false;
                }

                const updates = {};
                
                if (type === 'overallRating') {
                    updates.overallRating = rating;
                } else if (type === 'laRevueRating' || type === 'rating') {
                    updates.laRevueRating = rating;
                    updates.rating = rating;
                    
                    const newOverallRating = calculateOverallRating(rating, establishment.usersRating);
                    updates.overallRating = newOverallRating;
                } else if (type === 'usersRating' || type === 'userRating') {
                    updates.usersRating = rating;
                    updates.userRating = rating;
                    
                    const newOverallRating = calculateOverallRating(establishment.laRevueRating, rating);
                    updates.overallRating = newOverallRating;
                }

                const docRef = doc(db, COLLECTIONS.ESTABLISHMENTS, id);
                await updateDoc(docRef, updates);
                console.log(`✅ Note ${type} mise à jour pour ${id}:`, updates);
                return true;
            } catch (error) {
                console.error('❌ Erreur mise à jour note:', error);
                return false;
            }
        };

        // ✅ NOUVELLE FONCTION MISE À JOUR ÉVALUATION DÉTAILLÉE
        window.updateEstablishmentDetailedEvaluation = async (id, detailedEvaluation) => {
            try {
                const docRef = doc(db, COLLECTIONS.ESTABLISHMENTS, id);
                await updateDoc(docRef, { detailedEvaluation });
                console.log(`✅ Évaluation détaillée mise à jour pour ${id}:`, detailedEvaluation);
                return true;
            } catch (error) {
                console.error('❌ Erreur mise à jour évaluation détaillée:', error);
                return false;
            }
        };

        window.addNewEstablishment = async (data) => {
            try {
                console.log('🔥 Création nouvel établissement:', data);
                
                const overallRating = calculateOverallRating(data.rating || data.laRevueRating, data.userRating || data.usersRating);
                
                const establishmentData = {
                    ...data,
                    laRevueRating: data.rating || data.laRevueRating || 7,
                    usersRating: data.userRating || data.usersRating || 7,
                    overallRating: overallRating,
                    // ✅ NOUVEAU : Initialiser l'évaluation détaillée
                    detailedEvaluation: data.detailedEvaluation || {
                        criteriaRatings: {},
                        strengths: [],
                        weaknesses: [],
                        summary: ''
                    },
                    createdAt: new Date(),
                    topPosition: window.currentEstablishments.length + 1,
                    isActive: true
                };
                
                const docRef = await addDoc(collection(db, COLLECTIONS.ESTABLISHMENTS), establishmentData);
                console.log(`✅ Nouvel établissement créé: ${docRef.id}`);
                return docRef.id;
            } catch (error) {
                console.error('❌ Erreur création:', error);
                return null;
            }
        };

        window.deleteEstablishment = async (id) => {
            try {
                await deleteDoc(doc(db, COLLECTIONS.ESTABLISHMENTS, id));
                console.log(`✅ Établissement supprimé: ${id}`);
                return true;
            } catch (error) {
                console.error('❌ Erreur suppression:', error);
                return false;
            }
        };

        // ✅ FONCTION MESSAGE AMÉLIORÉE POUR MULTI-LIGNES
        window.showMessage = (message, type = 'info') => {
            const colors = {
                success: 'bg-green-600',
                error: 'bg-red-600',
                danger: 'bg-red-600',
                info: 'bg-blue-600'
            };
            
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 ${colors[type]} text-white px-6 py-3 rounded-lg shadow-lg z-50 max-w-md`;
            
            notification.innerHTML = `<pre class="whitespace-pre-wrap font-sans">${message}</pre>`;
            
            document.body.appendChild(notification);
            
            const duration = message.includes('\n') ? 5000 : 3000;
            
            setTimeout(() => {
                notification.remove();
            }, duration);
        };

        // Initialisation
        document.addEventListener('DOMContentLoaded', () => {
            console.log('🔥 Firebase Dashboard initialized');
            loadDashboard();
        });
    </script>

    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
        }
        
        .card-hover {
            transition: all 0.3s ease;
        }
        
        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }

        .ranking-item {
            transition: all 0.3s ease;
        }

        .ranking-item:hover {
            background: linear-gradient(135deg, #374151 0%, #4B5563 100%);
        }
        .upload-tab-btn {
    transition: all 0.2s ease;
    border: 1px solid transparent;
}

.upload-tab-btn.active {
    border-color: #3B82F6;
    box-shadow: 0 0 0 1px #3B82F6;
}

.upload-section {
    transition: all 0.3s ease;
}

.url-image-preview {
    position: relative;
    overflow: hidden;
    border-radius: 8px;
    border: 2px solid #4B5563;
    transition: all 0.2s ease;
}

.url-image-preview.loading {
    border-color: #F59E0B;
    background: linear-gradient(90deg, #374151 25%, #4B5563 50%, #374151 75%);
    background-size: 200% 100%;
    animation: loading-shimmer 2s infinite;
}

.url-image-preview.error {
    border-color: #EF4444;
    background: rgba(239, 68, 68, 0.1);
}

.url-image-preview.success {
    border-color: #10B981;
}

@keyframes loading-shimmer {
    0% { background-position: 200% 0; }
    100% { background-position: -200% 0; }
}

.url-preview-placeholder {
    width: 100%;
    height: 80px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #374151;
    color: #9CA3AF;
    font-size: 12px;
    text-align: center;
}

        .modal {
            backdrop-filter: blur(10px);
        }

        .spinner {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .image-preview {
            position: relative;
            overflow: hidden;
            border-radius: 8px;
        }
        
        .image-preview img {
            width: 100%;
            height: 80px;
            object-fit: cover;
        }
        
        .image-preview .remove-btn {
            position: absolute;
            top: 4px;
            right: 4px;
            background: rgba(239, 68, 68, 0.9);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .featured-badge {
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            border: 2px solid #fbbf24;
            box-shadow: 0 4px 12px rgba(251, 191, 36, 0.4);
        }

        .featured-item {
            border: 2px solid #fbbf24;
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.1), rgba(245, 158, 11, 0.05));
        }

        .news-item {
            transition: all 0.3s ease;
            border: 1px solid #374151;
        }

        .news-item:hover {
            background: linear-gradient(135deg, #374151 0%, #4B5563 100%);
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }

        .news-image {
            width: 200px;
            height: 120px;
            object-fit: cover;
            border-radius: 8px;
            border: 1px solid #4B5563;
        }

        .news-content {
            flex: 1;
            margin-left: 20px;
        }

        .news-badge {
            background: linear-gradient(135deg, #10B981, #059669);
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            display: inline-block;
            margin-bottom: 8px;
        }

        .establishment-type-badge {
            background: linear-gradient(135deg, #3B82F6, #2563EB);
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .news-title {
            font-size: 18px;
            font-weight: bold;
            color: #F8FAFC;
            margin-bottom: 8px;
            line-height: 1.4;
        }

        .news-summary {
            color: #9CA3AF;
            font-size: 14px;
            line-height: 1.6;
            margin-bottom: 12px;
        }

        .news-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .news-date {
            color: #6B7280;
            font-size: 12px;
        }

        .news-author {
            color: #3B82F6;
            font-size: 12px;
            font-weight: 600;
        }

        .news-link {
            background: linear-gradient(135deg, #3B82F6, #2563EB);
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            text-decoration: none;
            font-size: 12px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition: all 0.3s ease;
        }

        .news-link:hover {
            background: linear-gradient(135deg, #2563EB, #1D4ED8);
            transform: translateY(-1px);
        }

        .featured-news {
            border: 2px solid #F59E0B;
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.1), rgba(245, 158, 11, 0.05));
        }

        .featured-news-badge {
            background: linear-gradient(135deg, #F59E0B, #D97706);
            color: black;
            font-weight: bold;
        }

        .review-item {
            transition: all 0.3s ease;
            border: 1px solid #374151;
        }

        .review-item:hover {
            background: linear-gradient(135deg, #374151 0%, #4B5563 100%);
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }

        .review-status {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            display: inline-block;
        }

        .review-status.pending {
            background: linear-gradient(135deg, #F59E0B, #D97706);
            color: black;
        }

        .review-status.approved {
            background: linear-gradient(135deg, #10B981, #059669);
            color: white;
        }

        .review-status.rejected {
            background: linear-gradient(135deg, #EF4444, #DC2626);
            color: white;
        }

        .review-photos {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .review-photo {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 8px;
            border: 1px solid #4B5563;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .review-photo:hover {
            transform: scale(1.1);
            border-color: #3B82F6;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #3B82F6, #2563EB);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 16px;
        }

        .rating-badge {
            background: linear-gradient(135deg, #3B82F6, #2563EB);
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: bold;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .criteria-ratings {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin: 12px 0;
            background: rgba(0,0,0,0.3);
            padding: 12px;
            border-radius: 8px;
        }

        .criteria-item {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
        }

        .criteria-label {
            color: #9CA3AF;
        }

        .criteria-value {
            color: #F8FAFC;
            font-weight: bold;
        }

        .featured-scores-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1.5rem;
            margin-top: 1rem;
        }

        .score-item {
            text-align: center;
            padding: 0.75rem;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            border: 1px solid rgba(251, 191, 36, 0.3);
        }

        .score-label {
            font-size: 0.75rem;
            color: #9CA3AF;
            margin-bottom: 0.25rem;
        }

        .score-value {
            font-size: 1.25rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        /* ✅ NOUVEAUX STYLES OVERLAY VILLE/RÉGION ACTUALITÉS */
.news-image {
    position: relative;
}

.news-location-overlay {
    position: absolute;
    bottom: 8px;
    left: 8px;
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(8px);
    border-radius: 8px;
    padding: 6px 8px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    z-index: 10;
}

.news-establishment-info {
    background: linear-gradient(135deg, rgba(55, 65, 81, 0.95), rgba(75, 85, 99, 0.85));
    backdrop-filter: blur(10px);
    border: 1px solid rgba(59, 130, 246, 0.3);
}

.news-establishment-info:hover {
    background: linear-gradient(135deg, rgba(75, 85, 99, 0.95), rgba(107, 114, 128, 0.85));
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);
}

        .score-edit-btn {
            font-size: 0.75rem;
            color: #6B7280;
            cursor: pointer;
            padding: 0.25rem;
            border-radius: 4px;
            transition: color 0.2s;
        }

        .score-edit-btn:hover {
            color: #FBBF24;
        }

        .drag-drop-zone {
            border: 2px dashed #4B5563;
            border-radius: 12px;
            padding: 40px 20px;
            text-align: center;
            background: rgba(75, 85, 99, 0.1);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .drag-drop-zone:hover,
        .drag-drop-zone.drag-over {
            border-color: #3B82F6;
            background: rgba(59, 130, 246, 0.1);
            transform: scale(1.02);
        }

        .drag-drop-zone.drag-over {
            border-color: #10B981;
            background: rgba(16, 185, 129, 0.1);
        }

        .file-preview {
            background: #374151;
            border-radius: 8px;
            padding: 16px;
            margin-top: 16px;
            border: 1px solid #4B5563;
        }

        .json-preview {
            background: #1F2937;
            border: 1px solid #374151;
            border-radius: 8px;
            padding: 16px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
            color: #E5E7EB;
        }

        /* ✅ NOUVEAUX STYLES POUR ÉVALUATION DÉTAILLÉE */
        .detailed-evaluation-section {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(67, 56, 202, 0.05));
            border: 1px solid rgba(99, 102, 241, 0.3);
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
        }

        .evaluation-criteria-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            margin-bottom: 20px;
        }

        .criteria-input-group {
            display: flex;
            flex-direction: column;
        }

        .criteria-input {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 8px;
        }

        .criteria-input label {
            min-width: 120px;
            font-size: 14px;
            color: #D1D5DB;
        }

        .criteria-input input {
            flex: 1;
            background: #374151;
            border: 1px solid #4B5563;
            border-radius: 6px;
            padding: 8px 12px;
            color: white;
            font-size: 14px;
        }

        .strengths-weaknesses-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .strength-weakness-section {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            padding: 16px;
        }

        .strength-weakness-section h5 {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .strength-weakness-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .strength-weakness-item {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            padding: 8px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 6px;
        }

        .strength-weakness-item input {
            flex: 1;
            background: transparent;
            border: none;
            color: white;
            font-size: 14px;
        }

        .strength-weakness-item input:focus {
            outline: none;
        }

        .strength-weakness-item .remove-btn {
            background: rgba(239, 68, 68, 0.8);
            color: white;
            border: none;
            border-radius: 4px;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 12px;
        }

        .add-item-btn {
            background: rgba(34, 197, 94, 0.8);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px 12px;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            margin-top: 8px;
        }

        .evaluation-summary textarea {
            width: 100%;
            min-height: 100px;
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid #4B5563;
            border-radius: 8px;
            padding: 12px;
            color: white;
            font-size: 14px;
            resize: vertical;
        }

        .evaluation-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid rgba(75, 85, 99, 0.5);
        }

        .evaluation-preview {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 16px;
            margin-top: 16px;
        }

        .evaluation-preview h4 {
            color: #FBBF24;
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .evaluation-preview-content {
            color: #D1D5DB;
            font-size: 14px;
            line-height: 1.6;
        }
    </style>
</head>

<body class="bg-gray-900 text-white min-h-screen">

    <!-- Header et Navigation -->
    <header class="gradient-bg shadow-2xl border-b border-gray-700">
        <div class="max-w-7xl mx-auto px-6 py-8">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <div class="bg-yellow-500 p-3 rounded-xl">
                        <i class="fas fa-trophy text-black text-2xl"></i>
                    </div>
                    <div>
                        <h1 class="text-4xl font-bold text-yellow-400">Dashboard Admin - La Revue</h1>
                        <p class="text-gray-300 text-lg mt-1">Gestion du classement et des établissements avec géocodage automatique</p>
                    </div>
                </div>
                
                <div class="flex items-center space-x-4">
                    <div class="bg-green-500 w-3 h-3 rounded-full animate-pulse"></div>
                    <span class="text-green-400 font-medium">En ligne</span>
                </div>
            </div>
        </div>
    </header>

    <nav class="bg-gray-800 border-b border-gray-700">
        <div class="max-w-7xl mx-auto px-6 py-4">
            <div class="flex space-x-8">
                <button onclick="switchTab('hotels')" id="tab-hotels" class="nav-tab px-6 py-3 rounded-lg font-medium transition-all duration-300 bg-blue-600 text-white">
                    <i class="fas fa-bed mr-2"></i>Hôtels
                </button>
                <button onclick="switchTab('restaurants')" id="tab-restaurants" class="nav-tab px-6 py-3 rounded-lg font-medium transition-all duration-300 bg-gray-700 text-gray-300 hover:bg-gray-600">
                    <i class="fas fa-utensils mr-2"></i>Restaurants
                </button>
                <button onclick="switchTab('spas')" id="tab-spas" class="nav-tab px-6 py-3 rounded-lg font-medium transition-all duration-300 bg-gray-700 text-gray-300 hover:bg-gray-600">
                    <i class="fas fa-spa mr-2"></i>Spas
                </button>
                <button onclick="switchTab('news')" id="tab-news" class="nav-tab px-6 py-3 rounded-lg font-medium transition-all duration-300 bg-gray-700 text-gray-300 hover:bg-gray-600">
                    <i class="fas fa-newspaper mr-2"></i>Actualités
                </button>
                <button onclick="switchTab('reviews')" id="tab-reviews" class="nav-tab px-6 py-3 rounded-lg font-medium transition-all duration-300 bg-gray-700 text-gray-300 hover:bg-gray-600">
                    <i class="fas fa-comments mr-2"></i>Avis
                </button>
            </div>
        </div>
    </nav>

    <!-- Contenu Principal -->
    <main class="max-w-7xl mx-auto px-6 py-8">
        
        <!-- Statistiques -->
        <section class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-12">
            <div class="bg-gray-800 p-6 rounded-xl border border-gray-700 card-hover">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-lg font-semibold text-yellow-400">Total</h3>
                        <p class="text-3xl font-bold" id="stat-total">0</p>
                    </div>
                    <div class="bg-yellow-500 p-3 rounded-lg">
                        <i class="fas fa-building text-black text-xl"></i>
                    </div>
                </div>
            </div>

            <div class="bg-gray-800 p-6 rounded-xl border border-gray-700 card-hover">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-lg font-semibold text-blue-400">Note Moyenne</h3>
                        <p class="text-3xl font-bold" id="stat-average">0.0</p>
                    </div>
                    <div class="bg-blue-500 p-3 rounded-lg">
                        <i class="fas fa-star text-white text-xl"></i>
                    </div>
                </div>
            </div>

            <div class="bg-gray-800 p-6 rounded-xl border border-gray-700 card-hover">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-lg font-semibold text-green-400" id="stat-third-title">Top 3</h3>
                        <p class="text-3xl font-bold" id="stat-third-value">🏆🥈🥉</p>
                    </div>
                    <div class="bg-green-500 p-3 rounded-lg">
                        <i class="fas fa-medal text-white text-xl" id="stat-third-icon"></i>
                    </div>
                </div>
            </div>

            <div class="bg-gray-800 p-6 rounded-xl border border-gray-700 card-hover">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-lg font-semibold text-purple-400">Firebase</h3>
                        <p class="text-2xl font-bold text-green-400">🟢 Connecté</p>
                    </div>
                    <div class="bg-purple-500 p-3 rounded-lg">
                        <i class="fas fa-database text-white text-xl"></i>
                    </div>
                </div>
            </div>
        </section>

        <!-- Actions rapides -->
        <section class="mb-8">
            <div class="flex flex-wrap gap-4" id="actions-container">
                <button onclick="openAddModal()" class="bg-green-600 hover:bg-green-700 px-6 py-3 rounded-lg font-medium transition-colors">
                    <i class="fas fa-plus mr-2"></i>Ajouter un établissement
                </button>
                <button onclick="window.sortByRating()" class="bg-blue-600 hover:bg-blue-700 px-6 py-3 rounded-lg font-medium transition-colors">
                    <i class="fas fa-sort-numeric-down mr-2"></i>Trier par notes
                </button>
                <button onclick="recalculateRankings()" class="bg-blue-600 hover:bg-blue-700 px-6 py-3 rounded-lg font-medium transition-colors">
                    <i class="fas fa-calculator mr-2"></i>Recalculer le classement
                </button>
                <button onclick="openImportModal()" class="bg-purple-600 hover:bg-purple-700 px-6 py-3 rounded-lg font-medium transition-colors">
                    <i class="fas fa-upload mr-2"></i>Importer des établissements
                </button>
                <button onclick="window.fixCategories()" class="bg-orange-600 hover:bg-orange-700 px-6 py-3 rounded-lg font-medium transition-colors">
                    <i class="fas fa-wrench mr-2"></i>Corriger Catégories
                </button>
                <button onclick="window.recalculateAllRatings()" class="bg-green-600 hover:bg-green-700 px-6 py-3 rounded-lg font-medium transition-colors">
                    <i class="fas fa-calculator mr-2"></i>Recalculer Notes Générales
                </button>
                <button onclick="window.recalculateAndSort()" class="bg-gradient-to-r from-green-600 to-blue-600 hover:from-green-700 hover:to-blue-700 px-6 py-3 rounded-lg font-medium transition-colors">
                    <i class="fas fa-magic mr-2"></i>Recalculer + Trier
                </button>
                <!-- ✅ NOUVEAU BOUTON GÉOCODAGE AUTOMATIQUE -->
                <button onclick="window.forceGeocodeAllHotels()" class="bg-yellow-600 hover:bg-yellow-700 px-6 py-3 rounded-lg font-medium transition-colors">
                    <i class="fas fa-map-marker-alt mr-2"></i>🗺️ Géocoder tous les établissements
                </button>
                <button onclick="exportData()" class="bg-purple-600 hover:bg-purple-700 px-6 py-3 rounded-lg font-medium transition-colors">
                    <i class="fas fa-download mr-2"></i>Exporter les données
                </button>
            </div>
        </section>

        <!-- Liste des établissements -->
        <section class="bg-gray-800 rounded-xl border border-gray-700">
            <div class="p-6 border-b border-gray-700">
                <div class="flex items-center justify-between">
                    <h2 class="text-2xl font-bold" id="section-title">🏨 Classement des Hôtels</h2>
                    <div class="flex items-center space-x-4">
                        <input type="text" id="search-input" placeholder="Rechercher..." class="bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white" onkeyup="filterEstablishments()">
                        <button onclick="forceRefresh()" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg font-medium transition-colors">
                            <i class="fas fa-sync-alt mr-2"></i>Rafraîchir
                        </button>
                    </div>
                </div>
                <p class="text-gray-400 mt-2" id="section-description">Glissez-déposez pour modifier le classement • Cliquez pour modifier • 🗺️ Géocodage automatique disponible</p>
            </div>
            
            <!-- Loading -->
            <div id="loading" class="p-12 text-center">
                <div class="spinner w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full mx-auto mb-4"></div>
                <p class="text-gray-400">Chargement des données Firebase...</p>
            </div>

            <!-- Liste -->
            <div id="establishments-list" class="hidden">
                <!-- Les établissements seront injectés ici par JavaScript -->
            </div>
        </section>
    </main>

    <!-- ✅ MODAL IMPORT -->
    <div id="import-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 modal z-50 flex items-center justify-center p-4">
        <div class="bg-gray-800 rounded-xl border border-gray-700 max-w-4xl w-full max-h-screen overflow-y-auto">
            <div class="p-6 border-b border-gray-700">
                <div class="flex items-center justify-between">
                    <h3 class="text-xl font-bold">📦 Importer des établissements</h3>
                    <button onclick="closeImportModal()" class="text-gray-400 hover:text-white">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>
            
            <div class="p-6 space-y-6">
                <!-- Zone de drag & drop -->
                <div class="drag-drop-zone" id="drag-drop-zone">
                    <div class="text-4xl mb-4">📄</div>
                    <h4 class="text-lg font-semibold mb-2">Glissez-déposez votre fichier JSON ici</h4>
                    <p class="text-gray-400 mb-4">ou cliquez pour sélectionner un fichier</p>
                    <input type="file" id="import-file-input" accept=".json" class="hidden">
                    <button type="button" onclick="document.getElementById('import-file-input').click()" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg text-sm font-medium">
                        <i class="fas fa-folder-open mr-2"></i>Choisir un fichier
                    </button>
                </div>

                <!-- Ou saisie manuelle -->
                <div>
                    <h4 class="text-lg font-semibold mb-4">Ou collez votre JSON directement :</h4>
                    <textarea id="import-json-textarea" rows="10" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white font-mono text-sm" placeholder='[
  {
    "name": "Hôtel Example",
    "category": "hotel",
    "address": "123 Rue Example, Paris",
    "region": "ile-de-france",
    "rating": 8.5,
    "userRating": 8.2,
    "priceLevel": 3,
    "description": "Un magnifique hôtel au cœur de Paris"
  }
]'></textarea>
                </div>

                <!-- Prévisualisation -->
                <div id="import-preview" class="hidden">
                    <h4 class="text-lg font-semibold mb-2">📋 Prévisualisation :</h4>
                    <div id="import-preview-content" class="file-preview">
                        <p class="text-green-400 mb-2">✅ Fichier JSON valide !</p>
                        <div id="import-stats" class="text-sm text-gray-400 mb-4"></div>
                        <div id="import-json-display" class="json-preview"></div>
                    </div>
                </div>

                <!-- Actions -->
                <div class="flex justify-between items-center">
                    <div class="flex space-x-4">
                        <button type="button" onclick="previewImport()" class="bg-yellow-600 hover:bg-yellow-700 px-6 py-2 rounded-lg font-medium">
                            <i class="fas fa-eye mr-2"></i>Prévisualiser
                        </button>
                        <button type="button" onclick="clearImport()" class="bg-gray-600 hover:bg-gray-700 px-6 py-2 rounded-lg font-medium">
                            <i class="fas fa-eraser mr-2"></i>Effacer
                        </button>
                    </div>
                    
                    <div class="flex space-x-4">
                        <button type="button" onclick="closeImportModal()" class="px-6 py-2 border border-gray-600 rounded-lg text-gray-300 hover:bg-gray-700">
                            Annuler
                        </button>
                        <button type="button" onclick="executeImport()" id="import-submit-btn" class="px-6 py-2 bg-green-600 hover:bg-green-700 rounded-lg text-white font-medium" disabled>
                            <i class="fas fa-upload mr-2"></i>Importer
                        </button>
                    </div>
                </div>

                <!-- ✅ NOUVELLE AIDE AVEC GÉOCODAGE -->
                <div class="bg-blue-900 bg-opacity-30 border border-blue-500 rounded-lg p-4">
                    <h5 class="text-blue-400 font-semibold mb-2">💡 Format JSON attendu :</h5>
                    <div class="text-sm text-gray-300 space-y-1">
                        <p><strong>Champs obligatoires :</strong> name, category</p>
                        <p><strong>Catégories acceptées :</strong> "hotel", "restaurant", "spa"</p>
                        <p><strong>Régions supportées :</strong> ile-de-france, provence-alpes-cote-azur, etc.</p>
                        <p><strong>Format :</strong> Tableau JSON avec objets établissements</p>
                        <p><strong>🗺️ Géocodage :</strong> Les adresses seront automatiquement converties en coordonnées GPS après l'import</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ✅ MODAL ÉTABLISSEMENT AVEC ÉVALUATION DÉTAILLÉE -->
    <div id="edit-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 modal z-50 flex items-center justify-center p-4">
        <div class="bg-gray-800 rounded-xl border border-gray-700 max-w-6xl w-full max-h-screen overflow-y-auto">
            <div class="p-6 border-b border-gray-700">
                <div class="flex items-center justify-between">
                    <h3 class="text-xl font-bold" id="modal-title">Ajouter un établissement</h3>
                    <button onclick="closeModal()" class="text-gray-400 hover:text-white">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>
            
            <form id="establishment-form" class="p-6 space-y-6">
                <!-- Informations de base -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Nom *</label>
                        <input type="text" id="form-name" required class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Type *</label>
                        <select id="form-type" required class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white" onchange="updateFeaturedLabels()">
                            <option value="hotel">Hôtel</option>
                            <option value="restaurant">Restaurant</option>
                            <option value="spa">Spa</option>
                        </select>
                    </div>
                </div>

                <!-- Adresse, ville et région -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Adresse complète * <span class="text-yellow-400">🗺️</span></label>
                        <input type="text" id="form-address" required class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white" placeholder="Adresse complète pour géocodage automatique">
                        <p class="text-xs text-yellow-400 mt-1">📍 Cette adresse sera automatiquement convertie en coordonnées GPS</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Ville *</label>
                        <input type="text" id="form-city" required class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white" placeholder="Ex: Paris, Lyon, Marseille...">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Région *</label>
                        <select id="form-region" required class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white">
                            <option value="auvergne-rhone-alpes">Auvergne-Rhône-Alpes</option>
                            <option value="bourgogne-franche-comte">Bourgogne-Franche-Comté</option>
                            <option value="bretagne">Bretagne</option>
                            <option value="centre-val-de-loire">Centre-Val de Loire</option>
                            <option value="corse">Corse</option>
                            <option value="grand-est">Grand Est</option>
                            <option value="guadeloupe">Guadeloupe</option>
                            <option value="guyane">Guyane</option>
                            <option value="hauts-de-france">Hauts-de-France</option>
                            <option value="ile-de-france">Île-de-France</option>
                            <option value="la-reunion">La Réunion</option>
                            <option value="martinique">Martinique</option>
                            <option value="mayotte">Mayotte</option>
                            <option value="normandie">Normandie</option>
                            <option value="nouvelle-aquitaine">Nouvelle-Aquitaine</option>
                            <option value="occitanie">Occitanie</option>
                            <option value="pays-de-la-loire">Pays de la Loire</option>
                            <option value="provence-alpes-cote-azur">Provence-Alpes-Côte d'Azur</option>
                        </select>
                    </div>
                </div>

                <!-- Notes et prix -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Note La Revue (/10)</label>
                        <input type="number" id="form-larevue-rating" min="1" max="10" step="0.1" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Note Utilisateurs (/10)</label>
                        <input type="number" id="form-user-rating" min="1" max="10" step="0.1" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Niveau de prix</label>
                        <select id="form-price-level" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white">
                            <option value="1">€ (Économique)</option>
                            <option value="2">€€ (Modéré)</option>
                            <option value="3">€€€ (Cher)</option>
                            <option value="4">€€€€ (Très cher)</option>
                        </select>
                    </div>
                </div>

                <!-- ✅ NOUVELLE SECTION : ÉVALUATION DÉTAILLÉE -->
                <div class="detailed-evaluation-section">
                    <h4 class="text-xl font-bold text-indigo-400 mb-6 flex items-center">
                        <i class="fas fa-chart-line mr-3"></i>Évaluation Détaillée
                    </h4>
                    
                    <!-- Notes par critères -->
                    <div class="evaluation-criteria-grid" id="criteria-ratings-container">
                        <div class="criteria-input-group">
                            <h5 class="text-lg font-semibold text-gray-300 mb-3">Notes par Critères (/10)</h5>
                            <!-- Les critères seront générés dynamiquement selon le type d'établissement -->
                        </div>
                    </div>
                    
                    <!-- Points forts et faibles -->
                    <div class="strengths-weaknesses-container">
                        <div class="strength-weakness-section">
                            <h5 class="text-green-400">
                                <i class="fas fa-plus-circle"></i>
                                Points Forts
                            </h5>
                            <ul class="strength-weakness-list" id="strengths-list">
                                <!-- Les points forts seront ajoutés dynamiquement -->
                            </ul>
                            <button type="button" class="add-item-btn" onclick="addStrength()">
                                <i class="fas fa-plus"></i>
                                Ajouter un point fort
                            </button>
                        </div>
                        
                        <div class="strength-weakness-section">
                            <h5 class="text-red-400">
                                <i class="fas fa-minus-circle"></i>
                                Points Faibles
                            </h5>
                            <ul class="strength-weakness-list" id="weaknesses-list">
                                <!-- Les points faibles seront ajoutés dynamiquement -->
                            </ul>
                            <button type="button" class="add-item-btn" onclick="addWeakness()">
                                <i class="fas fa-plus"></i>
                                Ajouter un point faible
                            </button>
                        </div>
                    </div>
                    
                    <!-- Résumé de l'évaluation -->
                    <div class="evaluation-summary">
                        <h5 class="text-lg font-semibold text-gray-300 mb-3">Résumé de l'Évaluation</h5>
                        <textarea id="evaluation-summary-text" placeholder="Résumé détaillé de votre évaluation de cet établissement..." class="evaluation-summary textarea"></textarea>
                    </div>
                    
                    <!-- Actions évaluation -->
                    <div class="evaluation-actions">
                        <button type="button" onclick="previewEvaluation()" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg text-sm font-medium">
                            <i class="fas fa-eye mr-2"></i>Prévisualiser
                        </button>
                        <button type="button" onclick="resetEvaluation()" class="bg-gray-600 hover:bg-gray-700 px-4 py-2 rounded-lg text-sm font-medium">
                            <i class="fas fa-undo mr-2"></i>Réinitialiser
                        </button>
                    </div>
                    
                    <!-- Prévisualisation -->
                    <div id="evaluation-preview" class="evaluation-preview hidden">
                        <h4><i class="fas fa-preview"></i>Aperçu de l'Évaluation</h4>
                        <div id="evaluation-preview-content" class="evaluation-preview-content">
                            <!-- Le contenu sera généré dynamiquement -->
                        </div>
                    </div>
                </div>

                <!-- Section featured -->
                <div class="bg-yellow-500 bg-opacity-20 p-4 rounded-lg border-l-4 border-yellow-500">
                    <h4 class="text-lg font-semibold text-yellow-400 mb-4">
                        <i class="fas fa-star mr-2"></i><span id="featured-title">Notre Établissement Favori du Moment</span>
                    </h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">
                                <input type="checkbox" id="form-is-featured" class="mr-2">
                                <span id="featured-checkbox-label">Marquer comme "Notre Établissement Favori du Moment"</span>
                            </label>
                            <p class="text-xs text-gray-400">Cet établissement apparaîtra en premier dans l'app</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Lien de réservation</label>
                            <input type="url" id="form-reservation-url" class="w-full bg-gray-600 border border-gray-500 rounded-lg px-4 py-2 text-white" placeholder="https://...">
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Avis positifs (%)</label>
                            <input type="text" id="form-positive-reviews" class="w-full bg-gray-600 border border-gray-500 rounded-lg px-4 py-2 text-white" placeholder="89%">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Avis négatifs (%)</label>
                            <input type="text" id="form-negative-reviews" class="w-full bg-gray-600 border border-gray-500 rounded-lg px-4 py-2 text-white" placeholder="11%">
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Exemple d'avis positif</label>
                            <input type="text" id="form-positive-example" class="w-full bg-gray-600 border border-gray-500 rounded-lg px-4 py-2 text-white" placeholder="Service exceptionnel et vue magnifique">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Exemple d'avis négatif</label>
                            <input type="text" id="form-negative-example" class="w-full bg-gray-600 border border-gray-500 rounded-lg px-4 py-2 text-white" placeholder="Prix un peu élevé">
                        </div>
                    </div>
                </div>

                <!-- Codes promo -->
                <div class="bg-gray-700 p-4 rounded-lg border-l-4 border-yellow-500">
                    <h4 class="text-lg font-semibold text-yellow-400 mb-4">
                        <i class="fas fa-gift mr-2"></i>Codes Promo Premium
                    </h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Code Promo</label>
                            <input type="text" id="form-promo-code" class="w-full bg-gray-600 border border-gray-500 rounded-lg px-4 py-2 text-white" placeholder="HOTEL20">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Réduction</label>
                            <input type="text" id="form-promo-discount" class="w-full bg-gray-600 border border-gray-500 rounded-lg px-4 py-2 text-white" placeholder="20%">
                        </div>
                    </div>
                </div>

                <!-- Upload d'images -->
                <div class="bg-gray-700 p-4 rounded-lg border-l-4 border-blue-500">
                    <h4 class="text-lg font-semibold text-blue-400 mb-4">
                        <i class="fas fa-camera mr-2"></i>Photos de l'établissement
                    </h4>
                    
                    <!-- Onglets pour choisir le mode d'upload -->
                    <div class="flex space-x-4 mb-4">
                        <button type="button" id="upload-tab-files" onclick="switchUploadTab('files')" class="upload-tab-btn active px-4 py-2 rounded-lg bg-blue-600 text-white">
                            <i class="fas fa-upload mr-2"></i>Fichiers locaux
                        </button>
                        <button type="button" id="upload-tab-urls" onclick="switchUploadTab('urls')" class="upload-tab-btn px-4 py-2 rounded-lg bg-gray-600 text-gray-300">
                            <i class="fas fa-link mr-2"></i>URLs d'images
                        </button>
                    </div>
                    
                    <!-- Upload fichiers locaux -->
                    <div id="upload-section-files" class="upload-section">
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Sélectionner des images (max 8)</label>
                            <input type="file" id="form-images" multiple accept="image/*" class="w-full bg-gray-600 border border-gray-500 rounded-lg px-4 py-2 text-white">
                            <p class="text-xs text-gray-400 mt-2">Formats acceptés: JPG, PNG, WebP • Taille max: 5MB par image</p>
                        </div>
                    </div>
                    
                    <!-- Upload URLs d'images -->
                    <div id="upload-section-urls" class="upload-section hidden">
                        <div class="space-y-3">
                            <label class="block text-sm font-medium text-gray-300 mb-2">URLs d'images (une par ligne, max 8)</label>
                            <textarea id="image-urls-input" rows="6" placeholder="https://example.com/image1.jpg&#10;https://example.com/image2.png&#10;https://unsplash.com/photo/abc123" class="w-full bg-gray-600 border border-gray-500 rounded-lg px-4 py-2 text-white text-sm"></textarea>
                            <div class="flex space-x-2">
                                <button type="button" onclick="previewImageUrls()" class="px-4 py-2 bg-yellow-600 hover:bg-yellow-700 rounded-lg text-sm">
                                    <i class="fas fa-eye mr-2"></i>Prévisualiser
                                </button>
                                <button type="button" onclick="clearImageUrls()" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 rounded-lg text-sm">
                                    <i class="fas fa-eraser mr-2"></i>Effacer
                                </button>
                            </div>
                            <p class="text-xs text-gray-400">Formats acceptés: JPG, PNG, WebP, GIF • URLs publiques uniquement</p>
                        </div>
                    </div>
                    
                    <!-- Prévisualisation des images -->
                    <div id="images-preview" class="grid grid-cols-4 gap-4 mt-4"></div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Description</label>
                    <textarea id="form-description" rows="3" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white"></textarea>
                </div>

                <!-- ✅ NOTICE GÉOCODAGE -->
                <div class="bg-yellow-900 bg-opacity-30 border border-yellow-500 rounded-lg p-4 mt-4">
                    <h5 class="text-yellow-400 font-semibold mb-2 flex items-center">
                        <i class="fas fa-map-marker-alt mr-2"></i>🗺️ Géocodage Automatique
                    </h5>
                    <div class="text-sm text-gray-300 space-y-1">
                        <p><strong>✨ Nouveau :</strong> Les coordonnées GPS seront automatiquement calculées à partir de l'adresse</p>
                        <p><strong>📍 Précision :</strong> Plus l'adresse est complète, plus la localisation sera précise</p>
                        <p><strong>⚡ Automatique :</strong> Aucune action supplémentaire requise de votre part</p>
                        <p><strong>🗺️ Résultat :</strong> Vos établissements apparaîtront automatiquement sur la carte de l'app</p>
                    </div>
                </div>

                <div class="flex justify-end space-x-4">
                    <button type="button" onclick="closeModal()" class="px-6 py-2 border border-gray-600 rounded-lg text-gray-300 hover:bg-gray-700">
                        Annuler
                    </button>
                    <button type="submit" class="px-6 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg text-white font-medium">
                        <span id="form-submit-text">Ajouter</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- ✅ MODAL ÉVALUATION DÉTAILLÉE SÉPARÉE -->
    <div id="detailed-evaluation-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 modal z-50 flex items-center justify-center p-4">
        <div class="bg-gray-800 rounded-xl border border-gray-700 max-w-5xl w-full max-h-screen overflow-y-auto">
            <div class="p-6 border-b border-gray-700">
                <div class="flex items-center justify-between">
                    <h3 class="text-xl font-bold flex items-center">
                        <i class="fas fa-chart-line text-indigo-400 mr-3"></i>
                        <span id="detailed-evaluation-title">Évaluation Détaillée</span>
                    </h3>
                    <button onclick="closeDetailedEvaluationModal()" class="text-gray-400 hover:text-white">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>
            
            <div class="p-6" id="detailed-evaluation-content">
                <!-- Le contenu sera généré dynamiquement -->
            </div>
        </div>
    </div>

    <!-- MODAL ACTUALITÉ -->
    <div id="news-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 modal z-50 flex items-center justify-center p-4">
        <div class="bg-gray-800 rounded-xl border border-gray-700 max-w-3xl w-full max-h-screen overflow-y-auto">
            <div class="p-6 border-b border-gray-700">
                <div class="flex items-center justify-between">
                    <h3 class="text-xl font-bold" id="news-modal-title">Ajouter une actualité</h3>
                    <button onclick="closeNewsModal()" class="text-gray-400 hover:text-white">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>
            
            <form id="news-form" class="p-6 space-y-6">
                <!-- Informations de base avec type d'établissement -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Titre *</label>
                        <input type="text" id="news-title" required class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Catégorie *</label>
                        <select id="news-category" required class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white">
                            <option value="Actualités">Actualités</option>
                            <option value="Nouveautés">Nouveautés</option>
                            <option value="Tendances">Tendances</option>
                            <option value="Guide">Guide</option>
                            <option value="Interview">Interview</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Type d'établissement *</label>
                        <select id="news-establishment-type" required class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white" onchange="updateNewsLocationPreview()">
                            <option value="hotels">Hôtels</option>
                            <option value="restaurants">Restaurants</option>
                            <option value="spas">Spas</option>
                            <option value="all">Tous types</option>
                        </select>
                    </div>
                     <!-- ✅ NOUVEAU : Aperçu localisation -->
            <div id="news-location-preview" class="bg-blue-900 bg-opacity-20 p-4 rounded-lg border-l-4 border-blue-400 hidden">
                <h5 class="text-blue-400 font-semibold mb-2 flex items-center">
                    <i class="fas fa-map-marker-alt mr-2"></i>Aperçu localisation
                </h5>
                <div id="news-location-content" class="text-sm text-gray-300">
                    <!-- Le contenu sera généré dynamiquement -->
                </div>
            </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Résumé de l'article *</label>
                    <textarea id="news-summary" rows="4" required class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white" placeholder="Résumé en 2-3 phrases maximum..."></textarea>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">URL de l'image *</label>
                        <input type="url" id="news-image" required class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white" placeholder="https://...">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Lien vers l'article complet *</label>
                        <input type="url" id="news-article-url" required class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white" placeholder="https://...">
                    </div>
                </div>

                <!-- ✅ NOUVEAUX CHAMPS VILLE ET RÉGION -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Ville</label>
                        <input type="text" id="news-city" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white" placeholder="Entrez la ville">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Région</label>
                        <select id="news-region" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white">
                            <option value="">Sélectionner une région</option>
                            <option value="auvergne-rhone-alpes">Auvergne-Rhône-Alpes</option>
                            <option value="bourgogne-franche-comte">Bourgogne-Franche-Comté</option>
                            <option value="bretagne">Bretagne</option>
                            <option value="centre-val-de-loire">Centre-Val de Loire</option>
                            <option value="corse">Corse</option>
                            <option value="grand-est">Grand Est</option>
                            <option value="guadeloupe">Guadeloupe</option>
                            <option value="guyane">Guyane</option>
                            <option value="hauts-de-france">Hauts-de-France</option>
                            <option value="ile-de-france">Île-de-France</option>
                            <option value="la-reunion">La Réunion</option>
                            <option value="martinique">Martinique</option>
                            <option value="mayotte">Mayotte</option>
                            <option value="normandie">Normandie</option>
                            <option value="nouvelle-aquitaine">Nouvelle-Aquitaine</option>
                            <option value="occitanie">Occitanie</option>
                            <option value="pays-de-la-loire">Pays de la Loire</option>
                            <option value="provence-alpes-cote-azur">Provence-Alpes-Côte d'Azur</option>
                        </select>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Auteur</label>
                        <input type="text" id="news-author" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white" value="La Revue">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Date de publication</label>
                        <input type="date" id="news-date" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white">
                    </div>
                </div>

                <!-- Section à la une -->
                <div class="bg-yellow-500 bg-opacity-20 p-4 rounded-lg border-l-4 border-yellow-500">
                    <h4 class="text-lg font-semibold text-yellow-400 mb-4">
                        <i class="fas fa-star mr-2"></i>Actualité à la Une
                    </h4>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">
                            <input type="checkbox" id="news-featured" class="mr-2">
                            Marquer comme "Actualité à la Une"
                        </label>
                        <p class="text-xs text-gray-400">Cette actualité apparaîtra en premier dans l'app pour ce type d'établissement</p>
                    </div>
                </div>

                <div class="flex justify-end space-x-4">
                    <button type="button" onclick="closeNewsModal()" class="px-6 py-2 border border-gray-600 rounded-lg text-gray-300 hover:bg-gray-700">
                        Annuler
                    </button>
                    <button type="submit" class="px-6 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg text-white font-medium">
                        <span id="news-submit-text">Ajouter</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Variables globales
        let currentTab = 'hotels';
        let editingId = null;
        let editingNewsId = null;
        let selectedImages = [];
        let importData = null;

        // ✅ NOUVELLES VARIABLES POUR ÉVALUATION DÉTAILLÉE
        let currentEvaluationData = {
            criteriaRatings: {},
            strengths: [],
            weaknesses: [],
            summary: ''
        };

         // ✅ NOUVELLES VARIABLES POUR GESTION UPLOAD IMAGES
        let uploadMode = 'files'; // 'files' ou 'urls'
        let imageUrls = [];

        // ✅ FONCTIONS GESTION UPLOAD IMAGES PAR URL
        function switchUploadTab(mode) {
            uploadMode = mode;
            
            // Mettre à jour les onglets
            document.querySelectorAll('.upload-tab-btn').forEach(btn => {
                btn.classList.remove('active', 'bg-blue-600', 'text-white');
                btn.classList.add('bg-gray-600', 'text-gray-300');
            });
            
            const activeBtn = document.getElementById(`upload-tab-${mode}`);
            activeBtn.classList.add('active', 'bg-blue-600', 'text-white');
            activeBtn.classList.remove('bg-gray-600', 'text-gray-300');
            
            // Afficher/masquer les sections
            document.querySelectorAll('.upload-section').forEach(section => {
                section.classList.add('hidden');
            });
            document.getElementById(`upload-section-${mode}`).classList.remove('hidden');
            
            // Nettoyer les prévisualisations si on change de mode
            if (mode === 'files') {
                imageUrls = [];
                document.getElementById('image-urls-input').value = '';
            } else {
                selectedImages = [];
                document.getElementById('form-images').value = '';
            }
            
            updateImagesPreview();
        }

        async function previewImageUrls() {
            const input = document.getElementById('image-urls-input').value.trim();
            if (!input) {
                showError('Veuillez saisir au moins une URL d\'image');
                return;
            }
            
            const urls = input.split('\n').map(url => url.trim()).filter(url => url);
            
            if (urls.length > 8) {
                showError('Maximum 8 images autorisées');
                return;
            }
            
            // Vérifier que ce sont des URLs valides
            const validUrls = [];
            const invalidUrls = [];
            
            for (const url of urls) {
                try {
                    new URL(url);
                    // Vérifier que c'est bien une image
                    if (/\.(jpg|jpeg|png|gif|webp)(\?.*)?$/i.test(url) || url.includes('unsplash.com') || url.includes('images.') || url.includes('img.')) {
                        validUrls.push(url);
                    } else {
                        invalidUrls.push(url);
                    }
                } catch (e) {
                    invalidUrls.push(url);
                }
            }
            
            if (invalidUrls.length > 0) {
                console.warn('URLs invalides:', invalidUrls);
                showError(`${invalidUrls.length} URL(s) invalide(s). Vérifiez le format.`);
            }
            
            if (validUrls.length === 0) {
                showError('Aucune URL d\'image valide trouvée');
                return;
            }
            
            imageUrls = validUrls;
            showSuccess(`✅ ${validUrls.length} URL(s) d'image détectée(s) !`);
            updateImagesPreview();
        }

        function clearImageUrls() {
            imageUrls = [];
            document.getElementById('image-urls-input').value = '';
            updateImagesPreview();
            showSuccess('URLs effacées');
        }

        function updateImagesPreview() {
            const previewContainer = document.getElementById('images-preview');
            previewContainer.innerHTML = '';
            
            if (uploadMode === 'files' && selectedImages.length > 0) {
                // Prévisualisation fichiers locaux (code existant)
                selectedImages.forEach((file, index) => {
                    if (index >= 8) return;
                    
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const previewDiv = document.createElement('div');
                        previewDiv.className = 'image-preview';
                        previewDiv.innerHTML = `
                            <img src="${e.target.result}" alt="Preview ${index + 1}">
                            <button type="button" class="remove-btn" onclick="removeImage(${index})">
                                <i class="fas fa-times"></i>
                            </button>
                        `;
                        previewContainer.appendChild(previewDiv);
                    };
                    reader.readAsDataURL(file);
                });
            } else if (uploadMode === 'urls' && imageUrls.length > 0) {
                // Prévisualisation URLs
                imageUrls.forEach((url, index) => {
                    const previewDiv = document.createElement('div');
                    previewDiv.className = 'url-image-preview loading';
                    previewDiv.innerHTML = `
                        <div class="url-preview-placeholder">
                            <i class="fas fa-spinner fa-spin"></i><br>
                            Chargement...
                        </div>
                        <button type="button" class="remove-btn" onclick="removeImageUrl(${index})">
                            <i class="fas fa-times"></i>
                        </button>
                    `;
                    previewContainer.appendChild(previewDiv);
                    
                    // Tester le chargement de l'image
                    const img = new Image();
                    img.onload = function() {
                        previewDiv.className = 'url-image-preview success';
                        previewDiv.innerHTML = `
                            <img src="${url}" alt="URL Preview ${index + 1}" style="width: 100%; height: 80px; object-fit: cover;">
                            <button type="button" class="remove-btn" onclick="removeImageUrl(${index})">
                                <i class="fas fa-times"></i>
                            </button>
                        `;
                    };
                    img.onerror = function() {
                        previewDiv.className = 'url-image-preview error';
                        previewDiv.innerHTML = `
                            <div class="url-preview-placeholder" style="color: #EF4444;">
                                <i class="fas fa-exclamation-triangle"></i><br>
                                Erreur chargement
                            </div>
                            <button type="button" class="remove-btn" onclick="removeImageUrl(${index})">
                                <i class="fas fa-times"></i>
                            </button>
                        `;
                    };
                    img.src = url;
                });
            }
        }

        function removeImageUrl(index) {
            imageUrls.splice(index, 1);
            updateImagesPreview();
        }

        // ✅ CRITÈRES D'ÉVALUATION PAR TYPE D'ÉTABLISSEMENT
        const EVALUATION_CRITERIA = {
            hotel: {
                'localisation': 'Localisation',
                'service': 'Service & Accueil',
                'confort': 'Confort des Chambres',
                'proprete': 'Propreté',
                'equipements': 'Équipements',
                'restauration': 'Restauration',
                'rapport-qualite-prix': 'Rapport Qualité-Prix'
            },
            restaurant: {
                'cuisine': 'Qualité de la Cuisine',
                'service': 'Service & Accueil',
                'ambiance': 'Ambiance & Décor',
                'proprete': 'Propreté',
                'carte': 'Variété de la Carte',
                'rapport-qualite-prix': 'Rapport Qualité-Prix',
                'localisation': 'Localisation'
            },
            spa: {
                'soins': 'Qualité des Soins',
                'service': 'Service & Accueil',
                'equipements': 'Équipements Bien-être',
                'ambiance': 'Ambiance & Détente',
                'proprete': 'Propreté & Hygiène',
                'professionnalisme': 'Professionnalisme Équipe',
                'rapport-qualite-prix': 'Rapport Qualité-Prix'
            }
        };

        // ✅ FONCTIONS UTILITAIRES POUR TYPE D'ÉTABLISSEMENT
        function getEstablishmentIcon(type) {
            const icons = {
                'hotels': '🏨',
                'restaurants': '🍽️',
                'spas': '🧘',
                'all': '🏢'
            };
            return icons[type] || '🏢';
        }

        function getEstablishmentLabel(type) {
            const labels = {
                'hotels': 'Hôtels',
                'restaurants': 'Restaurants',
                'spas': 'Spas',
                'all': 'Tous types'
            };
            return labels[type] || 'Tous types';
        }

        // ✅ NOUVELLES FONCTIONS POUR ÉVALUATION DÉTAILLÉE
        function updateFeaturedLabels() {
            const type = document.getElementById('form-type').value;
            const featuredTitle = document.getElementById('featured-title');
            const featuredCheckboxLabel = document.getElementById('featured-checkbox-label');
            
            const labels = {
                'hotel': {
                    title: 'Notre Hôtel Favori du Moment',
                    checkbox: 'Marquer comme "Notre Hôtel Favori du Moment"'
                },
                'restaurant': {
                    title: 'Notre Restaurant Favori du Moment',
                    checkbox: 'Marquer comme "Notre Restaurant Favori du Moment"'
                },
                'spa': {
                    title: 'Notre Spa Favori du Moment',
                    checkbox: 'Marquer comme "Notre Spa Favori du Moment"'
                }
            };
            
            if (featuredTitle && featuredCheckboxLabel) {
                featuredTitle.textContent = labels[type]?.title || 'Notre Établissement Favori du Moment';
                featuredCheckboxLabel.textContent = labels[type]?.checkbox || 'Marquer comme "Notre Établissement Favori du Moment"';
            }
            
            // ✅ NOUVEAU : Mettre à jour les critères d'évaluation
            updateCriteriaRatings(type);
        }

        // ✅ FONCTION POUR GÉNÉRER LES CRITÈRES D'ÉVALUATION
        function updateCriteriaRatings(type) {
            const container = document.getElementById('criteria-ratings-container');
            if (!container) return;
            
            const criteria = EVALUATION_CRITERIA[type] || {};
            
            let html = `
                <div class="criteria-input-group">
                    <h5 class="text-lg font-semibold text-gray-300 mb-3">Notes par Critères (/10)</h5>
            `;
            
            Object.entries(criteria).forEach(([key, label]) => {
                html += `
                    <div class="criteria-input">
                        <label>${label}</label>
                        <input type="number" 
                               id="criteria-${key}" 
                               min="1" max="10" step="0.1" 
                               class="w-24"
                               value="${currentEvaluationData.criteriaRatings[key] || ''}"
                               onchange="updateCriteriaRating('${key}', this.value)">
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }

        // ✅ FONCTION POUR METTRE À JOUR UNE NOTE DE CRITÈRE
        function updateCriteriaRating(criterion, value) {
            if (value && !isNaN(parseFloat(value))) {
                currentEvaluationData.criteriaRatings[criterion] = parseFloat(value);
            } else {
                delete currentEvaluationData.criteriaRatings[criterion];
            }
        }

        // ✅ FONCTION POUR AJOUTER UN POINT FORT
        function addStrength() {
            const strengthsList = document.getElementById('strengths-list');
            const index = currentEvaluationData.strengths.length;
            
            const li = document.createElement('li');
            li.className = 'strength-weakness-item';
            li.innerHTML = `
                <i class="fas fa-plus text-green-400"></i>
                <input type="text" 
                       placeholder="Saisissez un point fort..." 
                       onchange="updateStrength(${index}, this.value)"
                       onkeydown="handleStrengthWeaknessEnter(event, 'strength')">
                <button type="button" class="remove-btn" onclick="removeStrength(${index})">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            strengthsList.appendChild(li);
            currentEvaluationData.strengths.push('');
            
            // Focus sur le nouvel input
            li.querySelector('input').focus();
        }

         // ✅ FONCTION POUR AJOUTER UN POINT FAIBLE
        function addWeakness() {
            const weaknessesList = document.getElementById('weaknesses-list');
            const index = currentEvaluationData.weaknesses.length;
            
            const li = document.createElement('li');
            li.className = 'strength-weakness-item';
            li.innerHTML = `
                <i class="fas fa-minus text-red-400"></i>
                <input type="text" 
                       placeholder="Saisissez un point faible..." 
                       onchange="updateWeakness(${index}, this.value)"
                       onkeydown="handleStrengthWeaknessEnter(event, 'weakness')">
                <button type="button" class="remove-btn" onclick="removeWeakness(${index})">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            weaknessesList.appendChild(li);
            currentEvaluationData.weaknesses.push('');
            
            // Focus sur le nouvel input
            li.querySelector('input').focus();
        }

        // ✅ FONCTION POUR GÉRER ENTRÉE SUR POINTS FORTS/FAIBLES
        function handleStrengthWeaknessEnter(event, type) {
            if (event.key === 'Enter') {
                event.preventDefault();
                if (type === 'strength') {
                    addStrength();
                } else {
                    addWeakness();
                }
            }
        }

        // ✅ FONCTIONS DE MISE À JOUR ET SUPPRESSION
        function updateStrength(index, value) {
            currentEvaluationData.strengths[index] = value.trim();
        }

        function updateWeakness(index, value) {
            currentEvaluationData.weaknesses[index] = value.trim();
        }

        function removeStrength(index) {
            currentEvaluationData.strengths.splice(index, 1);
            refreshStrengthsWeaknessesList();
        }

        function removeWeakness(index) {
            currentEvaluationData.weaknesses.splice(index, 1);
            refreshStrengthsWeaknessesList();
        }

        // ✅ FONCTION POUR RAFRAÎCHIR LES LISTES
        function refreshStrengthsWeaknessesList() {
            const strengthsList = document.getElementById('strengths-list');
            const weaknessesList = document.getElementById('weaknesses-list');
            
            // Régénérer les points forts
            strengthsList.innerHTML = '';
            currentEvaluationData.strengths.forEach((strength, index) => {
                const li = document.createElement('li');
                li.className = 'strength-weakness-item';
                li.innerHTML = `
                    <i class="fas fa-plus text-green-400"></i>
                    <input type="text" 
                           value="${strength}" 
                           placeholder="Saisissez un point fort..." 
                           onchange="updateStrength(${index}, this.value)"
                           onkeydown="handleStrengthWeaknessEnter(event, 'strength')">
                    <button type="button" class="remove-btn" onclick="removeStrength(${index})">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                strengthsList.appendChild(li);
            });
            
            // Régénérer les points faibles
            weaknessesList.innerHTML = '';
            currentEvaluationData.weaknesses.forEach((weakness, index) => {
                const li = document.createElement('li');
                li.className = 'strength-weakness-item';
                li.innerHTML = `
                    <i class="fas fa-minus text-red-400"></i>
                    <input type="text" 
                           value="${weakness}" 
                           placeholder="Saisissez un point faible..." 
                           onchange="updateWeakness(${index}, this.value)"
                           onkeydown="handleStrengthWeaknessEnter(event, 'weakness')">
                    <button type="button" class="remove-btn" onclick="removeWeakness(${index})">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                weaknessesList.appendChild(li);
            });
        }

        // ✅ FONCTION PRÉVISUALISATION ÉVALUATION
        function previewEvaluation() {
            const type = document.getElementById('form-type').value;
            const criteria = EVALUATION_CRITERIA[type] || {};
            const summary = document.getElementById('evaluation-summary-text').value.trim();
            
            // Mettre à jour le résumé
            currentEvaluationData.summary = summary;
            
            // Filtrer les points forts/faibles vides
            const validStrengths = currentEvaluationData.strengths.filter(s => s.trim());
            const validWeaknesses = currentEvaluationData.weaknesses.filter(w => w.trim());
            
            let previewHTML = '<div class="space-y-4">';
            
            // Notes par critères
            if (Object.keys(currentEvaluationData.criteriaRatings).length > 0) {
                previewHTML += `
                    <div>
                        <h5 class="text-lg font-semibold text-indigo-400 mb-2">📊 Notes par Critères</h5>
                        <div class="grid grid-cols-2 gap-2">
                `;
                
                Object.entries(currentEvaluationData.criteriaRatings).forEach(([key, rating]) => {
                    const label = criteria[key] || key;
                    previewHTML += `
                        <div class="flex justify-between bg-gray-700 p-2 rounded">
                            <span>${label}</span>
                            <span class="font-bold text-blue-400">${rating}/10</span>
                        </div>
                    `;
                });
                
                previewHTML += '</div></div>';
            }
            
            // Points forts
            if (validStrengths.length > 0) {
                previewHTML += `
                    <div>
                        <h5 class="text-lg font-semibold text-green-400 mb-2">✅ Points Forts</h5>
                        <ul class="space-y-1">
                `;
                
                validStrengths.forEach(strength => {
                    previewHTML += `<li class="flex items-center"><i class="fas fa-plus-circle text-green-400 mr-2"></i>${strength}</li>`;
                });
                
                previewHTML += '</ul></div>';
            }
            
            // Points faibles
            if (validWeaknesses.length > 0) {
                previewHTML += `
                    <div>
                        <h5 class="text-lg font-semibold text-red-400 mb-2">❌ Points Faibles</h5>
                        <ul class="space-y-1">
                `;
                
                validWeaknesses.forEach(weakness => {
                    previewHTML += `<li class="flex items-center"><i class="fas fa-minus-circle text-red-400 mr-2"></i>${weakness}</li>`;
                });
                
                previewHTML += '</ul></div>';
            }
            
            // Résumé
            if (summary) {
                previewHTML += `
                    <div>
                        <h5 class="text-lg font-semibold text-blue-400 mb-2">📝 Résumé</h5>
                        <p class="bg-gray-700 p-3 rounded">${summary}</p>
                    </div>
                `;
            }
            
            previewHTML += '</div>';
            
            // Afficher la prévisualisation
            document.getElementById('evaluation-preview-content').innerHTML = previewHTML;
            document.getElementById('evaluation-preview').classList.remove('hidden');
            
            // Scroll vers la prévisualisation
            document.getElementById('evaluation-preview').scrollIntoView({ 
                behavior: 'smooth', 
                block: 'nearest' 
            });
        }

        // ✅ FONCTION RÉINITIALISER ÉVALUATION
        function resetEvaluation() {
            if (!confirm('Êtes-vous sûr de vouloir réinitialiser toute l\'évaluation détaillée ?')) {
                return;
            }
            
            // Réinitialiser les données
            currentEvaluationData = {
                criteriaRatings: {},
                strengths: [],
                weaknesses: [],
                summary: ''
            };
            
            // Réinitialiser l'interface
            const type = document.getElementById('form-type').value;
            updateCriteriaRatings(type);
            refreshStrengthsWeaknessesList();
            document.getElementById('evaluation-summary-text').value = '';
            document.getElementById('evaluation-preview').classList.add('hidden');
            
            showSuccess('Évaluation réinitialisée !');
        }

        // ✅ FONCTIONS MODAL ÉTABLISSEMENT
        function openAddModal() {
            editingId = null;
            document.getElementById('modal-title').textContent = 'Ajouter un établissement';
            document.getElementById('form-submit-text').textContent = 'Ajouter';
            document.getElementById('establishment-form').reset();
            
            const typeMap = {
                'hotels': 'hotel',
                'restaurants': 'restaurant', 
                'spas': 'spa'
            };
            
            document.getElementById('form-type').value = typeMap[currentTab] || 'hotel';
            
            // ✅ NOUVEAU : Réinitialiser l'évaluation détaillée
            currentEvaluationData = {
                criteriaRatings: {},
                strengths: [],
                weaknesses: [],
                summary: ''
            };
            
            updateFeaturedLabels();
            
            document.getElementById('edit-modal').classList.remove('hidden');
            document.getElementById('images-preview').innerHTML = '';
            selectedImages = [];
        }

        function closeModal() {
            document.getElementById('edit-modal').classList.add('hidden');
            editingId = null;
            selectedImages = [];
            imageUrls = [];
            uploadMode = 'files';
            switchUploadTab('files');
            
            // ✅ NOUVEAU : Réinitialiser l'évaluation détaillée
            currentEvaluationData = {
                criteriaRatings: {},
                strengths: [],
                weaknesses: [],
                summary: ''
            };
        }

        // ✅ FONCTIONS PRINCIPALES DE DASHBOARD
        async function loadDashboard() {
            showLoading(true);
            
            try {
                const establishments = await window.loadEstablishments(currentTab);
                updateStats(establishments, currentTab);
                renderEstablishments(establishments);
            } catch (error) {
                console.error('Erreur chargement dashboard:', error);
                showError('Erreur de connexion Firebase');
            } finally {
                showLoading(false);
            }
        }

        function switchTab(tab) {
            currentTab = tab;
            
            document.querySelectorAll('.nav-tab').forEach(btn => {
                btn.className = 'nav-tab px-6 py-3 rounded-lg font-medium transition-all duration-300 bg-gray-700 text-gray-300 hover:bg-gray-600';
            });
            document.getElementById(`tab-${tab}`).className = 'nav-tab px-6 py-3 rounded-lg font-medium transition-all duration-300 bg-blue-600 text-white';
            
            const titles = {
                hotels: '🏨 Classement des Hôtels',
                restaurants: '🍽️ Classement des Restaurants',
                spas: '🧘 Classement des Spas',
                news: '📰 Actualités',
                reviews: '💬 Modération des Avis'
            };
            
            document.getElementById('section-title').textContent = titles[tab];
            updateActionsSection();
            loadDashboard();
        }

        function updateActionsSection() {
            const actionsContainer = document.getElementById('actions-container');
            
            actionsContainer.innerHTML = `
                <button onclick="openAddModal()" class="bg-green-600 hover:bg-green-700 px-6 py-3 rounded-lg font-medium transition-colors">
                    <i class="fas fa-plus mr-2"></i>Ajouter un établissement
                </button>
                <button onclick="window.sortByRating()" class="bg-blue-600 hover:bg-blue-700 px-6 py-3 rounded-lg font-medium transition-colors">
                    <i class="fas fa-sort-numeric-down mr-2"></i>Trier par notes
                </button>
                <button onclick="recalculateRankings()" class="bg-blue-600 hover:bg-blue-700 px-6 py-3 rounded-lg font-medium transition-colors">
                    <i class="fas fa-calculator mr-2"></i>Recalculer le classement
                </button>
                <button onclick="openImportModal()" class="bg-purple-600 hover:bg-purple-700 px-6 py-3 rounded-lg font-medium transition-colors">
                    <i class="fas fa-upload mr-2"></i>Importer des établissements
                </button>
                <button onclick="window.fixCategories()" class="bg-orange-600 hover:bg-orange-700 px-6 py-3 rounded-lg font-medium transition-colors">
                    <i class="fas fa-wrench mr-2"></i>Corriger Catégories
                </button>
                <button onclick="window.recalculateAllRatings()" class="bg-green-600 hover:bg-green-700 px-6 py-3 rounded-lg font-medium transition-colors">
                    <i class="fas fa-calculator mr-2"></i>Recalculer Notes Générales
                </button>
                <button onclick="window.recalculateAndSort()" class="bg-gradient-to-r from-green-600 to-blue-600 hover:from-green-700 hover:to-blue-700 px-6 py-3 rounded-lg font-medium transition-colors">
                    <i class="fas fa-magic mr-2"></i>Recalculer + Trier
                </button>
                <!-- ✅ BOUTON GÉOCODAGE AUTOMATIQUE -->
                <button onclick="window.forceGeocodeAllHotels()" class="bg-yellow-600 hover:bg-yellow-700 px-6 py-3 rounded-lg font-medium transition-colors">
                    <i class="fas fa-map-marker-alt mr-2"></i>🗺️ Géocoder tous les établissements
                </button>
                <button onclick="exportData()" class="bg-purple-600 hover:bg-purple-700 px-6 py-3 rounded-lg font-medium transition-colors">
                    <i class="fas fa-download mr-2"></i>Exporter les données
                </button>
            `;
        }

        // ✅ FONCTIONS UTILITAIRES
        function showLoading(show) {
            const loading = document.getElementById('loading');
            const list = document.getElementById('establishments-list');
            
            if (show) {
                loading.classList.remove('hidden');
                list.classList.add('hidden');
            } else {
                loading.classList.add('hidden');
                list.classList.remove('hidden');
            }
        }

        function showSuccess(message) {
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-green-600 text-white px-6 py-3 rounded-lg shadow-lg z-50';
            notification.innerHTML = `<i class="fas fa-check mr-2"></i>${message}`;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        function showError(message) {
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-red-600 text-white px-6 py-3 rounded-lg shadow-lg z-50';
            notification.innerHTML = `<i class="fas fa-exclamation-triangle mr-2"></i>${message}`;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 5000);
        }

        function updateStats(data, type) {
            document.getElementById('stat-total').textContent = data.length;
            const avgRating = data.length > 0 ? 
                (data.reduce((sum, item) => sum + (window.calculateOverallRating(item.laRevueRating, item.usersRating) || 0), 0) / data.length).toFixed(1) : 
                '0.0';
            document.getElementById('stat-average').textContent = avgRating;
        }

        function renderEstablishments(establishments) {
            const container = document.getElementById('establishments-list');
            
            if (establishments.length === 0) {
                container.innerHTML = `
                    <div class="p-12 text-center">
                        <div class="text-6xl mb-4">
                            ${currentTab === 'hotels' ? '🏨' : currentTab === 'restaurants' ? '🍽️' : '🧘'}
                        </div>
                        <h3 class="text-xl font-bold text-gray-300 mb-2">Aucun établissement trouvé</h3>
                        <p class="text-gray-400 mb-6">Commencez par ajouter votre premier ${currentTab.slice(0, -1)}</p>
                        <button onclick="openAddModal()" class="bg-blue-600 hover:bg-blue-700 px-6 py-3 rounded-lg font-medium">
                            <i class="fas fa-plus mr-2"></i>Ajouter un établissement
                        </button>
                    </div>
                `;
                return;
            }

            container.innerHTML = establishments.map((establishment, index) => {
                const isTop3 = establishment.rank <= 3;
                const trophyIcon = establishment.rank === 1 ? '🏆' : establishment.rank === 2 ? '🥈' : establishment.rank === 3 ? '🥉' : '';
                
                const calculatedOverallRating = window.calculateOverallRating(establishment.laRevueRating, establishment.usersRating);
                
                // ✅ NOUVEAU : Vérifier coordonnées GPS
                const hasCoordinates = establishment.coordinates && establishment.coordinates.latitude && establishment.coordinates.longitude;
                const coordinatesDisplay = hasCoordinates ? 
                    `✅ GPS: ${establishment.coordinates.latitude.toFixed(4)}, ${establishment.coordinates.longitude.toFixed(4)}` : 
                    '❌ Coordonnées manquantes';
                
                return `
                    <div class="ranking-item p-6 border-b border-gray-700 last:border-b-0 ${establishment.isFeatured ? 'featured-item' : ''}" 
                         data-id="${establishment.id}" 
                         data-rank="${establishment.rank}">
                        
                        ${establishment.isFeatured ? `
                            <div class="featured-badge px-4 py-2 rounded-full text-sm font-bold text-black mb-4 inline-flex items-center">
                                <i class="fas fa-star mr-2"></i>Notre ${currentTab === 'hotels' ? 'Hôtel' : currentTab === 'restaurants' ? 'Restaurant' : currentTab === 'spas' ? 'Spa' : 'Établissement'} Favori du Moment
                            </div>
                        ` : ''}
                        
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-6">
                                <!-- Rang -->
                                <div class="flex items-center space-x-2">
                                    <span class="text-3xl font-bold ${isTop3 ? 'text-yellow-400' : 'text-gray-400'}">
                                        #${establishment.rank}
                                    </span>
                                    ${trophyIcon ? `<span class="text-2xl">${trophyIcon}</span>` : ''}
                                </div>
                                
                                <!-- Infos principales -->
                                <div class="flex-1">
                                    <h3 class="text-xl font-bold text-white mb-1">${establishment.name}</h3>
                                    <p class="text-gray-400 mb-2">${establishment.address}</p>
                                    <div class="flex items-center space-x-4 text-sm text-gray-400">
                                        <span><i class="fas fa-map-marker-alt mr-1"></i>${establishment.city || establishment.region}</span>
                                        <span><i class="fas fa-euro-sign mr-1"></i>${'€'.repeat(establishment.priceLevel)}</span>
                                        <!-- ✅ NOUVEAU : Affichage statut GPS -->
                                        <span class="${hasCoordinates ? 'text-green-400' : 'text-red-400'}">
                                            <i class="fas fa-${hasCoordinates ? 'map-marked-alt' : 'map'} mr-1"></i>${coordinatesDisplay}
                                        </span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Notes -->
                            <div class="flex items-center space-x-6">
                                <div class="text-center">
                                    <div class="text-sm text-gray-400 mb-1">Note Générale</div>
                                    <div class="text-3xl font-bold text-green-400">${calculatedOverallRating}/10</div>
                                </div>
                                
                                <div class="text-center">
                                    <div class="text-sm text-gray-400 mb-1">La Revue</div>
                                    <div class="text-2xl font-bold text-yellow-400">${establishment.laRevueRating}/10</div>
                                </div>
                                
                                <div class="text-center">
                                    <div class="text-sm text-gray-400 mb-1">Utilisateurs</div>
                                    <div class="text-2xl font-bold text-blue-400">${establishment.usersRating}/10</div>
                                </div>
                                    
                                <!-- Actions -->
                                <div class="flex space-x-2">
                                    <button onclick="editEstablishment('${establishment.id}')" class="px-4 py-2 bg-yellow-600 hover:bg-yellow-700 rounded-lg text-sm font-medium transition-colors">
                                        <i class="fas fa-edit mr-1"></i>Modifier
                                    </button>
                                    <button onclick="deleteEstablishmentItem('${establishment.id}')" class="px-4 py-2 bg-red-600 hover:bg-red-700 rounded-lg text-sm font-medium transition-colors">
                                        <i class="fas fa-trash mr-1"></i>Supprimer
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ✅ FONCTION RAFRAÎCHISSEMENT FORCÉ
        window.forceRefresh = async () => {
            showMessage('🔄 Actualisation en cours...', 'info');
            await loadDashboard();
            showSuccess('✅ Données actualisées !');
        };

        function filterEstablishments() {
            const query = document.getElementById('search-input').value.toLowerCase();
            const items = document.querySelectorAll('.ranking-item');
            
            items.forEach(item => {
                const text = item.textContent.toLowerCase();
                const visible = text.includes(query);
                item.style.display = visible ? 'block' : 'none';
            });
        }

        function exportData() {
            const data = {
                type: currentTab,
                establishments: window.currentEstablishments,
                exportDate: new Date().toISOString(),
                gpsStatus: window.currentEstablishments.map(est => ({
                    id: est.id,
                    name: est.name,
                    hasCoordinates: !!(est.coordinates && est.coordinates.latitude)
                }))
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `larevue-${currentTab}-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            showSuccess('Données exportées avec statut GPS !');
        }

        // ✅ INITIALISATION
        console.log('🎉 Dashboard La Revue avec géocodage automatique !');
        console.log('✅ Nouvelles fonctionnalités :');
        console.log('🗺️ Géocodage automatique des adresses via API Nominatim');
        console.log('📍 Conversion automatique adresses → coordonnées GPS');
        console.log('🔄 Bouton de géocodage en lot pour tous les établissements');
        console.log('✅ Affichage du statut GPS dans le tableau');
        console.log('🎯 Géocodage automatique lors de l\'ajout d\'établissements');

    </script>

</body>
</html>
