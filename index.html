<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Admin - La Revue</title>
    
    <!-- Tailwind CSS -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js';
        import { getFirestore, collection, getDocs, doc, updateDoc, addDoc, deleteDoc, query, orderBy, where } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js';
        import { getStorage, ref, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-storage.js';

        // Configuration Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBjHNzW6i_d7HCZx_2K9Pv5JXIvafo1XNo",
            authDomain: "larevueapp-1f205.firebaseapp.com",
            projectId: "larevueapp-1f205",
            storageBucket: "larevueapp-1f205.firebasestorage.app",
            messagingSenderId: "248256257582",
            appId: "1:248256257582:web:a7b9281d0143e7ed35c9bf"
        };

        // Initialiser Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // Collections
        const COLLECTIONS = {
            ESTABLISHMENTS: 'establishments',
            USERS: 'users',
            REVIEWS: 'reviews',
            DEALS: 'deals',
            NEWS: 'news'
        };

        // Variables globales
        window.firebaseApp = { db, storage, COLLECTIONS };
        window.firebaseModules = { updateDoc, doc, addDoc, deleteDoc, ref, uploadBytes, getDownloadURL, getDocs, collection, query, where, orderBy };
        window.currentEstablishments = [];
        window.currentNews = [];
        window.currentReviews = [];
        window.currentStats = { hotels: 0, restaurants: 0, spas: 0, totalReviews: 0 };

        // ‚úÖ NOUVELLE FONCTION DE CALCUL DE LA NOTE G√âN√âRALE
        function calculateOverallRating(laRevueRating, usersRating) {
            const laRevue = parseFloat(laRevueRating) || 0;
            const users = parseFloat(usersRating) || 0;
            
            // Si les deux notes sont √† 0, retourner 0
            if (laRevue === 0 && users === 0) return 0;
            
            // Si une seule note est disponible, la retourner
            if (laRevue === 0) return users;
            if (users === 0) return laRevue;
            
            // Calculer la moyenne des deux notes
            return parseFloat(((laRevue + users) / 2).toFixed(1));
        }
        window.calculateOverallRating = calculateOverallRating;

        // ‚úÖ FONCTION UPLOAD IMAGES
        window.uploadImages = async (files) => {
            const urls = [];
            const uploadPromises = [];
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const timestamp = Date.now();
                const fileName = `${timestamp}_${i}_${file.name}`;
                const storageRef = ref(storage, `establishments/${fileName}`);
                
                uploadPromises.push(
                    uploadBytes(storageRef, file).then(async (snapshot) => {
                        const url = await getDownloadURL(snapshot.ref);
                        return url;
                    })
                );
            }
            
            try {
                const uploadedUrls = await Promise.all(uploadPromises);
                console.log('‚úÖ Images upload√©es:', uploadedUrls);
                return uploadedUrls;
            } catch (error) {
                console.error('‚ùå Erreur upload:', error);
                return [];
            }
        };

        // ‚úÖ NOUVELLE FONCTION CORRECTION CAT√âGORIES
        window.fixCategories = async () => {
            try {
                console.log('üîß Correction des cat√©gories en cours...');
                const establishmentsRef = collection(db, COLLECTIONS.ESTABLISHMENTS);
                const snapshot = await getDocs(establishmentsRef);
                
                const corrections = [];
                const categoryMap = {
                    'hotels': 'hotel',
                    'restaurants': 'restaurant',
                    'spas': 'spa'
                };
                
                snapshot.forEach((docSnap) => {
                    const data = docSnap.data();
                    const currentCategory = data.category;
                    
                    if (categoryMap[currentCategory]) {
                        corrections.push({
                            id: docSnap.id,
                            from: currentCategory,
                            to: categoryMap[currentCategory]
                        });
                    }
                });
                
                if (corrections.length === 0) {
                    showSuccess('‚úÖ Aucune correction n√©cessaire !');
                    return;
                }
                
                // Appliquer les corrections
                const updatePromises = corrections.map(correction => {
                    const docRef = doc(db, COLLECTIONS.ESTABLISHMENTS, correction.id);
                    return updateDoc(docRef, { category: correction.to });
                });
                
                await Promise.all(updatePromises);
                
                showSuccess(`‚úÖ ${corrections.length} cat√©gories corrig√©es !`);
                console.log('‚úÖ Corrections appliqu√©es:', corrections);
                
                // Recharger la page
                loadDashboard();
                
            } catch (error) {
                console.error('‚ùå Erreur correction cat√©gories:', error);
                showError('Erreur lors de la correction des cat√©gories');
            }
        };

        // ‚úÖ FONCTION RECALCUL GLOBAL DES NOTES G√âN√âRALES
        window.recalculateAllRatings = async () => {
            if (!confirm('Voulez-vous vraiment recalculer toutes les notes g√©n√©rales ? Cette action mettra √† jour Firebase.')) {
                return;
            }
            
            showMessage('Recalcul en cours...', 'info');
            
            try {
                const establishmentsRef = collection(db, COLLECTIONS.ESTABLISHMENTS);
                const snapshot = await getDocs(establishmentsRef);
                let updated = 0;
                
                const updatePromises = [];
                
                snapshot.forEach((docSnap) => {
                    const data = docSnap.data();
                    const laRevueRating = data.laRevueRating || data.rating || 0;
                    const usersRating = data.usersRating || data.userRating || 0;
                    
                    const newOverallRating = calculateOverallRating(laRevueRating, usersRating);
                    
                    if (newOverallRating !== (data.overallRating || 0)) {
                        const docRef = doc(db, COLLECTIONS.ESTABLISHMENTS, docSnap.id);
                        updatePromises.push(
                            updateDoc(docRef, { overallRating: newOverallRating })
                        );
                        updated++;
                    }
                });
                
                await Promise.all(updatePromises);
                
                showMessage(`‚úÖ ${updated} notes g√©n√©rales recalcul√©es !`, 'success');
                
                // Recharger les donn√©es
                await loadDashboard();
                
            } catch (error) {
                console.error('Erreur lors du recalcul:', error);
                showMessage('‚ùå Erreur lors du recalcul des notes', 'danger');
            }
        };

        // ‚úÖ FONCTION TRI PAR NOTES CORRIG√âE
        window.sortByRating = async () => {
            try {
                if (!window.currentEstablishments || window.currentEstablishments.length === 0) {
                    showError('Aucun √©tablissement √† trier');
                    return;
                }

                console.log('üìä Tri par note g√©n√©rale en cours...');
                showLoading(true);

                // ‚úÖ CORRECTION : Trier par note g√©n√©rale calcul√©e
                const sortedEstablishments = [...window.currentEstablishments].sort((a, b) => {
                    const ratingA = calculateOverallRating(a.laRevueRating, a.usersRating);
                    const ratingB = calculateOverallRating(b.laRevueRating, b.usersRating);
                    
                    console.log(`Comparaison: ${a.name} (${ratingA}) vs ${b.name} (${ratingB})`);
                    
                    return ratingB - ratingA; // Tri d√©croissant
                });

                // Mettre √† jour les rangs dans Firebase
                const updatePromises = sortedEstablishments.map(async (establishment, index) => {
                    const newRank = index + 1;
                    
                    if (establishment.rank !== newRank) {
                        try {
                            await window.updateEstablishmentRank(establishment.id, newRank);
                            console.log(`‚úÖ Rang mis √† jour pour ${establishment.name}: #${newRank}`);
                        } catch (error) {
                            console.error(`‚ùå Erreur rang pour ${establishment.name}:`, error);
                        }
                    }
                });

                await Promise.all(updatePromises);
                
                const topEstablishment = sortedEstablishments[0];
                const topRating = calculateOverallRating(topEstablishment.laRevueRating, topEstablishment.usersRating);

                showSuccess(`‚úÖ Classement tri√© par note g√©n√©rale ! Le meilleur √©tablissement (${topEstablishment.name} - ${topRating}/10) est maintenant #1`);
                
                // Recharger la liste
                await loadDashboard();
                
            } catch (error) {
                console.error('‚ùå Erreur tri par notes:', error);
                showError('Erreur lors du tri par notes');
            } finally {
                showLoading(false);
            }
        };

        // ‚úÖ NOUVELLE FONCTION IMPORT JSON EN LOT
        window.importEstablishments = async (jsonData) => {
            try {
                console.log('üì¶ Import en lot en cours...', jsonData);
                
                if (!Array.isArray(jsonData)) {
                    jsonData = [jsonData];
                }

                let successCount = 0;
                let errorCount = 0;
                const errors = [];

                for (const establishment of jsonData) {
                    try {
                        // Validation des donn√©es requises
                        if (!establishment.name || !establishment.category) {
                            errors.push(`√âtablissement sans nom ou cat√©gorie : ${JSON.stringify(establishment)}`);
                            errorCount++;
                            continue;
                        }

                        // Normaliser les donn√©es
                        const laRevueRating = parseFloat(establishment.rating || establishment.laRevueRating || 7);
                        const usersRating = parseFloat(establishment.userRating || establishment.usersRating || 7);
                        const overallRating = calculateOverallRating(laRevueRating, usersRating);

                        const normalizedData = {
                            name: establishment.name,
                            category: establishment.category,
                            address: establishment.address || 'Adresse non renseign√©e',
                            region: establishment.region || 'ile-de-france',
                            laRevueRating: laRevueRating,
                            usersRating: usersRating,
                            overallRating: overallRating,
                            priceLevel: parseInt(establishment.priceLevel || 3),
                            description: establishment.description || '',
                            longDescription: establishment.longDescription || establishment.description || '',
                            shortDescription: establishment.shortDescription || establishment.description || '',
                            isFeatured: establishment.isFeatured || false,
                            reservationUrl: establishment.reservationUrl || '',
                            positiveReviews: establishment.positiveReviews || '89%',
                            negativeReviews: establishment.negativeReviews || '11%',
                            positiveReviewExample: establishment.positiveReviewExample || '',
                            negativeReviewExample: establishment.negativeReviewExample || '',
                            promoCode: establishment.promoCode || '',
                            promoDiscount: establishment.promoDiscount || '',
                            images: establishment.images || [],
                            topPosition: establishment.rank || establishment.topPosition || (window.currentEstablishments.length + successCount + 1),
                            createdAt: new Date(),
                            isActive: true
                        };

                        // Ajouter √† Firebase
                        const docRef = await addDoc(collection(db, COLLECTIONS.ESTABLISHMENTS), normalizedData);
                        console.log(`‚úÖ √âtablissement cr√©√©: ${normalizedData.name} (${docRef.id})`);
                        successCount++;

                    } catch (error) {
                        console.error(`‚ùå Erreur pour ${establishment.name}:`, error);
                        errors.push(`${establishment.name}: ${error.message}`);
                        errorCount++;
                    }
                }

                // Afficher les r√©sultats
                if (successCount > 0) {
                    showSuccess(`‚úÖ ${successCount} √©tablissement${successCount > 1 ? 's' : ''} import√©${successCount > 1 ? 's' : ''} avec succ√®s !`);
                }

                if (errorCount > 0) {
                    console.error('‚ùå Erreurs d\'import:', errors);
                    showError(`‚ùå ${errorCount} erreur${errorCount > 1 ? 's' : ''} lors de l'import. Voir la console pour les d√©tails.`);
                }

                // Recharger la liste
                await loadDashboard();

            } catch (error) {
                console.error('‚ùå Erreur import g√©n√©ral:', error);
                showError('Erreur lors de l\'import: ' + error.message);
            }
        };

        // ‚úÖ FONCTIONS GESTION ACTUALIT√âS
        window.loadNews = async () => {
            try {
                console.log('üî• Chargement des actualit√©s...');
                const newsRef = collection(db, COLLECTIONS.NEWS);
                const q = query(newsRef, orderBy('publishedAt', 'desc'));
                const snapshot = await getDocs(q);
                
                const newsData = [];
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    console.log('üì∞ Actualit√© trouv√©e:', data);
                    
                    newsData.push({
                        id: doc.id,
                        title: data.title || 'Sans titre',
                        summary: data.summary || '',
                        imageUrl: data.imageUrl || 'https://images.unsplash.com/photo-1566073771259-6a8506099945?w=400',
                        articleUrl: data.articleUrl || '',
                        author: data.author || 'La Revue',
                        publishedAt: data.publishedAt || new Date(),
                        category: data.category || 'Actualit√©s',
                        establishmentType: data.establishmentType || 'hotels',
                        isFeatured: data.isFeatured || false,
                        isActive: data.isActive || true
                    });
                });
                
                console.log(`‚úÖ ${newsData.length} actualit√©s charg√©es`);
                window.currentNews = newsData;
                return newsData;
            } catch (error) {
                console.error('‚ùå Erreur chargement actualit√©s:', error);
                return [];
            }
        };

        // ‚úÖ FONCTIONS GESTION AVIS
        window.loadReviews = async () => {
            try {
                console.log('üî• Chargement des avis...');
                const reviewsRef = collection(db, COLLECTIONS.REVIEWS);
                const q = query(reviewsRef, orderBy('createdAt', 'desc'));
                const snapshot = await getDocs(q);
                
                const reviewsData = [];
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    reviewsData.push({
                        id: doc.id,
                        ...data,
                        createdAt: data.createdAt?.toDate ? data.createdAt.toDate() : new Date(data.createdAt),
                        status: data.status || 'pending'
                    });
                });
                
                console.log(`‚úÖ ${reviewsData.length} avis charg√©s`);
                window.currentReviews = reviewsData;
                return reviewsData;
            } catch (error) {
                console.error('‚ùå Erreur chargement avis:', error);
                return [];
            }
        };

        window.updateReview = async (id, data) => {
            try {
                const docRef = doc(db, COLLECTIONS.REVIEWS, id);
                await updateDoc(docRef, data);
                console.log(`‚úÖ Avis mis √† jour: ${id}`);
                return true;
            } catch (error) {
                console.error('‚ùå Erreur mise √† jour avis:', error);
                return false;
            }
        };

        window.addNewNews = async (data) => {
            try {
                console.log('üî• Cr√©ation nouvelle actualit√©:', data);
                
                // Si featured, d√©sactiver les autres
                if (data.isFeatured) {
                    const allNews = await getDocs(collection(db, COLLECTIONS.NEWS));
                    const updatePromises = [];
                    allNews.forEach((doc) => {
                        const newsData = doc.data();
                        if (newsData.isFeatured === true) {
                            const docRef = window.firebaseModules.doc(db, COLLECTIONS.NEWS, doc.id);
                            updatePromises.push(window.firebaseModules.updateDoc(docRef, { isFeatured: false }));
                        }
                    });
                    await Promise.all(updatePromises);
                }
                
                const docRef = await addDoc(collection(db, COLLECTIONS.NEWS), {
                    ...data,
                    createdAt: new Date(),
                    isActive: true
                });
                console.log(`‚úÖ Nouvelle actualit√© cr√©√©e: ${docRef.id}`);
                return docRef.id;
            } catch (error) {
                console.error('‚ùå Erreur cr√©ation actualit√©:', error);
                return null;
            }
        };

        window.updateNews = async (id, data) => {
            try {
                // Si featured, d√©sactiver les autres
                if (data.isFeatured) {
                    const allNews = await getDocs(collection(db, COLLECTIONS.NEWS));
                    const updatePromises = [];
                    allNews.forEach((doc) => {
                        const newsData = doc.data();
                        if (newsData.isFeatured === true && doc.id !== id) {
                            const docRef = window.firebaseModules.doc(db, COLLECTIONS.NEWS, doc.id);
                            updatePromises.push(window.firebaseModules.updateDoc(docRef, { isFeatured: false }));
                        }
                    });
                    await Promise.all(updatePromises);
                }
                
                const docRef = doc(db, COLLECTIONS.NEWS, id);
                await updateDoc(docRef, {
                    ...data,
                    updatedAt: new Date()
                });
                console.log(`‚úÖ Actualit√© mise √† jour: ${id}`);
                return true;
            } catch (error) {
                console.error('‚ùå Erreur mise √† jour actualit√©:', error);
                return false;
            }
        };

        window.deleteNews = async (id) => {
            try {
                await deleteDoc(doc(db, COLLECTIONS.NEWS, id));
                console.log(`‚úÖ Actualit√© supprim√©e: ${id}`);
                return true;
            } catch (error) {
                console.error('‚ùå Erreur suppression actualit√©:', error);
                return false;
            }
        };

        // ‚úÖ FONCTION CHARGEMENT √âTABLISSEMENTS CORRIG√âE POUR LES SPAS
        window.loadEstablishments = async (type = 'hotels') => {
            try {
                console.log(`üî• Chargement des ${type}...`);
                const establishmentsRef = collection(db, COLLECTIONS.ESTABLISHMENTS);
                const snapshot = await getDocs(establishmentsRef);
                
                const establishments = [];
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    console.log('üîç Document trouv√©:', doc.id, data);
                    
                    // ‚úÖ CORRECTION PRINCIPALE : Support complet des formats pluriels et singuliers
                    const docType = data.category || data.type;
                    let shouldInclude = false;
                    
                    // V√©rification selon le type demand√©
                    if (type === 'hotels') {
                        shouldInclude = docType === 'hotels' || docType === 'hotel';
                    } else if (type === 'restaurants') {
                        shouldInclude = docType === 'restaurants' || docType === 'restaurant';
                    } else if (type === 'spas') {
                        shouldInclude = docType === 'spas' || docType === 'spa';
                    } else {
                        shouldInclude = docType === type;
                    }
                    
                    if (shouldInclude) {
                        console.log(`‚úÖ √âtablissement ${docType} inclus pour la recherche ${type}:`, data.name);
                        
                        const laRevueRating = parseFloat(data.laRevueRating || data.rating || 7);
                        const usersRating = parseFloat(data.usersRating || data.userRating || 7);
                        
                        establishments.push({
                            id: doc.id,
                            name: data.name || 'Sans nom',
                            address: data.address || 'Sans adresse',
                            laRevueRating: laRevueRating,
                            usersRating: usersRating,
                            overallRating: data.overallRating || calculateOverallRating(laRevueRating, usersRating),
                            rank: data.topPosition || data.rank || establishments.length + 1,
                            priceLevel: data.priceLevel || 3,
                            description: data.longDescription || data.shortDescription || data.description || '',
                            category: docType,
                            region: data.region || data.city || 'ile-de-france',
                            promoCode: data.promoCode || '',
                            promoDiscount: data.promoDiscount || '',
                            images: data.images || [],
                            isFeatured: data.isFeatured || false,
                            reservationUrl: data.reservationUrl || '',
                            positiveReviews: data.positiveReviews || '89%',
                            negativeReviews: data.negativeReviews || '11%',
                            positiveReviewExample: data.positiveReviewExample || '',
                            negativeReviewExample: data.negativeReviewExample || ''
                        });
                    } else {
                        console.log(`‚ùå √âtablissement ${docType} EXCLU pour la recherche ${type}:`, data.name);
                    }
                });
                
                establishments.sort((a, b) => (a.rank || 999) - (b.rank || 999));
                window.currentEstablishments = establishments;
                console.log(`‚úÖ ${establishments.length} √©tablissements ${type} charg√©s au final`);
                return establishments;
            } catch (error) {
                console.error('‚ùå Erreur chargement:', error);
                return [];
            }
        };

        // Autres fonctions Firebase
        window.updateEstablishmentRank = async (id, newRank) => {
            try {
                const docRef = doc(db, COLLECTIONS.ESTABLISHMENTS, id);
                await updateDoc(docRef, { topPosition: newRank });
                console.log(`‚úÖ Rang mis √† jour pour ${id}`);
                return true;
            } catch (error) {
                console.error('‚ùå Erreur mise √† jour rang:', error);
                return false;
            }
        };

        // ‚úÖ FONCTION MISE √Ä JOUR NOTE CORRIG√âE AVEC CALCUL AUTO DE LA NOTE G√âN√âRALE
        window.updateEstablishmentRating = async (id, rating, type = 'rating') => {
            try {
                const establishment = window.currentEstablishments.find(e => e.id === id);
                if (!establishment) {
                    console.error('√âtablissement non trouv√©:', id);
                    return false;
                }

                const updates = {};
                
                // Mettre √† jour le champ sp√©cifique
                if (type === 'overallRating') {
                    updates.overallRating = rating;
                } else if (type === 'laRevueRating' || type === 'rating') {
                    updates.laRevueRating = rating;
                    updates.rating = rating; // Pour compatibilit√©
                    
                    // Recalculer la note g√©n√©rale
                    const newOverallRating = calculateOverallRating(rating, establishment.usersRating);
                    updates.overallRating = newOverallRating;
                } else if (type === 'usersRating' || type === 'userRating') {
                    updates.usersRating = rating;
                    updates.userRating = rating; // Pour compatibilit√©
                    
                    // Recalculer la note g√©n√©rale
                    const newOverallRating = calculateOverallRating(establishment.laRevueRating, rating);
                    updates.overallRating = newOverallRating;
                }

                const docRef = doc(db, COLLECTIONS.ESTABLISHMENTS, id);
                await updateDoc(docRef, updates);
                console.log(`‚úÖ Note ${type} mise √† jour pour ${id}:`, updates);
                return true;
            } catch (error) {
                console.error('‚ùå Erreur mise √† jour note:', error);
                return false;
            }
        };

        window.addNewEstablishment = async (data) => {
            try {
                console.log('üî• Cr√©ation nouvel √©tablissement:', data);
                
                // Calculer la note g√©n√©rale
                const overallRating = calculateOverallRating(data.rating || data.laRevueRating, data.userRating || data.usersRating);
                
                const establishmentData = {
                    ...data,
                    laRevueRating: data.rating || data.laRevueRating || 7,
                    usersRating: data.userRating || data.usersRating || 7,
                    overallRating: overallRating,
                    createdAt: new Date(),
                    topPosition: window.currentEstablishments.length + 1,
                    isActive: true
                };
                
                const docRef = await addDoc(collection(db, COLLECTIONS.ESTABLISHMENTS), establishmentData);
                console.log(`‚úÖ Nouvel √©tablissement cr√©√©: ${docRef.id}`);
                return docRef.id;
            } catch (error) {
                console.error('‚ùå Erreur cr√©ation:', error);
                return null;
            }
        };

        window.deleteEstablishment = async (id) => {
            try {
                await deleteDoc(doc(db, COLLECTIONS.ESTABLISHMENTS, id));
                console.log(`‚úÖ √âtablissement supprim√©: ${id}`);
                return true;
            } catch (error) {
                console.error('‚ùå Erreur suppression:', error);
                return false;
            }
        };

        // Fonction utilitaire pour les messages
        window.showMessage = (message, type = 'info') => {
            const colors = {
                success: 'bg-green-600',
                error: 'bg-red-600',
                danger: 'bg-red-600',
                info: 'bg-blue-600'
            };
            
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 ${colors[type]} text-white px-6 py-3 rounded-lg shadow-lg z-50`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        };

        // Initialisation
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üî• Firebase Dashboard initialized');
            loadDashboard();
        });
    </script>

    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
        }
        
        .card-hover {
            transition: all 0.3s ease;
        }
        
        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }

        .ranking-item {
            transition: all 0.3s ease;
        }

        .ranking-item:hover {
            background: linear-gradient(135deg, #374151 0%, #4B5563 100%);
        }

        .modal {
            backdrop-filter: blur(10px);
        }

        .spinner {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ‚úÖ STYLES POUR IMAGES */
        .image-preview {
            position: relative;
            overflow: hidden;
            border-radius: 8px;
        }
        
        .image-preview img {
            width: 100%;
            height: 80px;
            object-fit: cover;
        }
        
        .image-preview .remove-btn {
            position: absolute;
            top: 4px;
            right: 4px;
            background: rgba(239, 68, 68, 0.9);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* ‚úÖ STYLES FEATURED */
        .featured-badge {
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            border: 2px solid #fbbf24;
            box-shadow: 0 4px 12px rgba(251, 191, 36, 0.4);
        }

        .featured-item {
            border: 2px solid #fbbf24;
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.1), rgba(245, 158, 11, 0.05));
        }

        /* ‚úÖ STYLES POUR LES ACTUALIT√âS */
        .news-item {
            transition: all 0.3s ease;
            border: 1px solid #374151;
        }

        .news-item:hover {
            background: linear-gradient(135deg, #374151 0%, #4B5563 100%);
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }

        .news-image {
            width: 200px;
            height: 120px;
            object-fit: cover;
            border-radius: 8px;
            border: 1px solid #4B5563;
        }

        .news-content {
            flex: 1;
            margin-left: 20px;
        }

        .news-badge {
            background: linear-gradient(135deg, #10B981, #059669);
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            display: inline-block;
            margin-bottom: 8px;
        }

        .establishment-type-badge {
            background: linear-gradient(135deg, #3B82F6, #2563EB);
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .news-title {
            font-size: 18px;
            font-weight: bold;
            color: #F8FAFC;
            margin-bottom: 8px;
            line-height: 1.4;
        }

        .news-summary {
            color: #9CA3AF;
            font-size: 14px;
            line-height: 1.6;
            margin-bottom: 12px;
        }

        .news-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .news-date {
            color: #6B7280;
            font-size: 12px;
        }

        .news-author {
            color: #3B82F6;
            font-size: 12px;
            font-weight: 600;
        }

        .news-link {
            background: linear-gradient(135deg, #3B82F6, #2563EB);
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            text-decoration: none;
            font-size: 12px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition: all 0.3s ease;
        }

        .news-link:hover {
            background: linear-gradient(135deg, #2563EB, #1D4ED8);
            transform: translateY(-1px);
        }

        .featured-news {
            border: 2px solid #F59E0B;
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.1), rgba(245, 158, 11, 0.05));
        }

        .featured-news-badge {
            background: linear-gradient(135deg, #F59E0B, #D97706);
            color: black;
            font-weight: bold;
        }

        /* ‚úÖ STYLES POUR LES AVIS */
        .review-item {
            transition: all 0.3s ease;
            border: 1px solid #374151;
        }

        .review-item:hover {
            background: linear-gradient(135deg, #374151 0%, #4B5563 100%);
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }

        .review-status {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            display: inline-block;
        }

        .review-status.pending {
            background: linear-gradient(135deg, #F59E0B, #D97706);
            color: black;
        }

        .review-status.approved {
            background: linear-gradient(135deg, #10B981, #059669);
            color: white;
        }

        .review-status.rejected {
            background: linear-gradient(135deg, #EF4444, #DC2626);
            color: white;
        }

        .review-photos {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .review-photo {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 8px;
            border: 1px solid #4B5563;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .review-photo:hover {
            transform: scale(1.1);
            border-color: #3B82F6;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #3B82F6, #2563EB);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 16px;
        }

        .rating-badge {
            background: linear-gradient(135deg, #3B82F6, #2563EB);
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: bold;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .criteria-ratings {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin: 12px 0;
            background: rgba(0,0,0,0.3);
            padding: 12px;
            border-radius: 8px;
        }

        .criteria-item {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
        }

        .criteria-label {
            color: #9CA3AF;
        }

        .criteria-value {
            color: #F8FAFC;
            font-weight: bold;
        }

        /* ‚úÖ STYLES POUR LAYOUT FEATURED CORRIG√â */
        .featured-scores-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1.5rem;
            margin-top: 1rem;
        }

        .score-item {
            text-align: center;
            padding: 0.75rem;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            border: 1px solid rgba(251, 191, 36, 0.3);
        }

        .score-label {
            font-size: 0.75rem;
            color: #9CA3AF;
            margin-bottom: 0.25rem;
        }

        .score-value {
            font-size: 1.25rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .score-edit-btn {
            font-size: 0.75rem;
            color: #6B7280;
            cursor: pointer;
            padding: 0.25rem;
            border-radius: 4px;
            transition: color 0.2s;
        }

        .score-edit-btn:hover {
            color: #FBBF24;
        }

        /* ‚úÖ STYLES POUR LA ZONE DE DRAG & DROP */
        .drag-drop-zone {
            border: 2px dashed #4B5563;
            border-radius: 12px;
            padding: 40px 20px;
            text-align: center;
            background: rgba(75, 85, 99, 0.1);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .drag-drop-zone:hover,
        .drag-drop-zone.drag-over {
            border-color: #3B82F6;
            background: rgba(59, 130, 246, 0.1);
            transform: scale(1.02);
        }

        .drag-drop-zone.drag-over {
            border-color: #10B981;
            background: rgba(16, 185, 129, 0.1);
        }

        .file-preview {
            background: #374151;
            border-radius: 8px;
            padding: 16px;
            margin-top: 16px;
            border: 1px solid #4B5563;
        }

        .json-preview {
            background: #1F2937;
            border: 1px solid #374151;
            border-radius: 8px;
            padding: 16px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
            color: #E5E7EB;
        }
    </style>
</head>

<body class="bg-gray-900 text-white min-h-screen">

    <!-- Header et Navigation -->
    <header class="gradient-bg shadow-2xl border-b border-gray-700">
        <div class="max-w-7xl mx-auto px-6 py-8">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <div class="bg-yellow-500 p-3 rounded-xl">
                        <i class="fas fa-trophy text-black text-2xl"></i>
                    </div>
                    <div>
                        <h1 class="text-4xl font-bold text-yellow-400">Dashboard Admin - La Revue</h1>
                        <p class="text-gray-300 text-lg mt-1">Gestion du classement et des √©tablissements</p>
                    </div>
                </div>
                
                <div class="flex items-center space-x-4">
                    <div class="bg-green-500 w-3 h-3 rounded-full animate-pulse"></div>
                    <span class="text-green-400 font-medium">En ligne</span>
                </div>
            </div>
        </div>
    </header>

    <nav class="bg-gray-800 border-b border-gray-700">
        <div class="max-w-7xl mx-auto px-6 py-4">
            <div class="flex space-x-8">
                <button onclick="switchTab('hotels')" id="tab-hotels" class="nav-tab px-6 py-3 rounded-lg font-medium transition-all duration-300 bg-blue-600 text-white">
                    <i class="fas fa-bed mr-2"></i>H√¥tels
                </button>
                <button onclick="switchTab('restaurants')" id="tab-restaurants" class="nav-tab px-6 py-3 rounded-lg font-medium transition-all duration-300 bg-gray-700 text-gray-300 hover:bg-gray-600">
                    <i class="fas fa-utensils mr-2"></i>Restaurants
                </button>
                <button onclick="switchTab('spas')" id="tab-spas" class="nav-tab px-6 py-3 rounded-lg font-medium transition-all duration-300 bg-gray-700 text-gray-300 hover:bg-gray-600">
                    <i class="fas fa-spa mr-2"></i>Spas
                </button>
                <button onclick="switchTab('news')" id="tab-news" class="nav-tab px-6 py-3 rounded-lg font-medium transition-all duration-300 bg-gray-700 text-gray-300 hover:bg-gray-600">
                    <i class="fas fa-newspaper mr-2"></i>Actualit√©s
                </button>
                <button onclick="switchTab('reviews')" id="tab-reviews" class="nav-tab px-6 py-3 rounded-lg font-medium transition-all duration-300 bg-gray-700 text-gray-300 hover:bg-gray-600">
                    <i class="fas fa-comments mr-2"></i>Avis
                </button>
            </div>
        </div>
    </nav>

    <!-- Contenu Principal -->
    <main class="max-w-7xl mx-auto px-6 py-8">
        
        <!-- Statistiques -->
        <section class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-12">
            <div class="bg-gray-800 p-6 rounded-xl border border-gray-700 card-hover">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-lg font-semibold text-yellow-400">Total</h3>
                        <p class="text-3xl font-bold" id="stat-total">0</p>
                    </div>
                    <div class="bg-yellow-500 p-3 rounded-lg">
                        <i class="fas fa-building text-black text-xl"></i>
                    </div>
                </div>
            </div>

            <div class="bg-gray-800 p-6 rounded-xl border border-gray-700 card-hover">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-lg font-semibold text-blue-400">Note Moyenne</h3>
                        <p class="text-3xl font-bold" id="stat-average">0.0</p>
                    </div>
                    <div class="bg-blue-500 p-3 rounded-lg">
                        <i class="fas fa-star text-white text-xl"></i>
                    </div>
                </div>
            </div>

            <div class="bg-gray-800 p-6 rounded-xl border border-gray-700 card-hover">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-lg font-semibold text-green-400" id="stat-third-title">Top 3</h3>
                        <p class="text-3xl font-bold" id="stat-third-value">üèÜü•àü•â</p>
                    </div>
                    <div class="bg-green-500 p-3 rounded-lg">
                        <i class="fas fa-medal text-white text-xl" id="stat-third-icon"></i>
                    </div>
                </div>
            </div>

            <div class="bg-gray-800 p-6 rounded-xl border border-gray-700 card-hover">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-lg font-semibold text-purple-400">Firebase</h3>
                        <p class="text-2xl font-bold text-green-400">üü¢ Connect√©</p>
                    </div>
                    <div class="bg-purple-500 p-3 rounded-lg">
                        <i class="fas fa-database text-white text-xl"></i>
                    </div>
                </div>
            </div>
        </section>

        <!-- Actions rapides -->
        <section class="mb-8">
            <div class="flex flex-wrap gap-4" id="actions-container">
                <button onclick="openAddModal()" class="bg-green-600 hover:bg-green-700 px-6 py-3 rounded-lg font-medium transition-colors">
                    <i class="fas fa-plus mr-2"></i>Ajouter un √©tablissement
                </button>
                <button onclick="window.sortByRating()" class="bg-blue-600 hover:bg-blue-700 px-6 py-3 rounded-lg font-medium transition-colors">
                    <i class="fas fa-sort-numeric-down mr-2"></i>Trier par notes
                </button>
                <button onclick="recalculateRankings()" class="bg-blue-600 hover:bg-blue-700 px-6 py-3 rounded-lg font-medium transition-colors">
                    <i class="fas fa-calculator mr-2"></i>Recalculer le classement
                </button>
                <button onclick="openImportModal()" class="bg-purple-600 hover:bg-purple-700 px-6 py-3 rounded-lg font-medium transition-colors">
                    <i class="fas fa-upload mr-2"></i>Importer des √©tablissements
                </button>
                <button onclick="window.fixCategories()" class="bg-orange-600 hover:bg-orange-700 px-6 py-3 rounded-lg font-medium transition-colors">
                    <i class="fas fa-wrench mr-2"></i>Corriger Cat√©gories
                </button>
                <button onclick="window.recalculateAllRatings()" class="bg-green-600 hover:bg-green-700 px-6 py-3 rounded-lg font-medium transition-colors">
                    <i class="fas fa-calculator mr-2"></i>Recalculer Notes G√©n√©rales
                </button>
                <button onclick="exportData()" class="bg-purple-600 hover:bg-purple-700 px-6 py-3 rounded-lg font-medium transition-colors">
                    <i class="fas fa-download mr-2"></i>Exporter les donn√©es
                </button>
            </div>
        </section>

        <!-- Liste des √©tablissements -->
        <section class="bg-gray-800 rounded-xl border border-gray-700">
            <div class="p-6 border-b border-gray-700">
                <div class="flex items-center justify-between">
                    <h2 class="text-2xl font-bold" id="section-title">üè® Classement des H√¥tels</h2>
                    <div class="flex items-center space-x-4">
                        <input type="text" id="search-input" placeholder="Rechercher..." class="bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white" onkeyup="filterEstablishments()">
                        <button onclick="forceRefresh()" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg font-medium transition-colors">
                            <i class="fas fa-sync-alt mr-2"></i>Rafra√Æchir
                        </button>
                    </div>
                </div>
                <p class="text-gray-400 mt-2" id="section-description">Glissez-d√©posez pour modifier le classement ‚Ä¢ Cliquez pour modifier</p>
            </div>
            
            <!-- Loading -->
            <div id="loading" class="p-12 text-center">
                <div class="spinner w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full mx-auto mb-4"></div>
                <p class="text-gray-400">Chargement des donn√©es Firebase...</p>
            </div>

            <!-- Liste -->
            <div id="establishments-list" class="hidden">
                <!-- Les √©tablissements seront inject√©s ici par JavaScript -->
            </div>
        </section>
    </main>

    <!-- ‚úÖ MODAL IMPORT -->
    <div id="import-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 modal z-50 flex items-center justify-center p-4">
        <div class="bg-gray-800 rounded-xl border border-gray-700 max-w-4xl w-full max-h-screen overflow-y-auto">
            <div class="p-6 border-b border-gray-700">
                <div class="flex items-center justify-between">
                    <h3 class="text-xl font-bold">üì¶ Importer des √©tablissements</h3>
                    <button onclick="closeImportModal()" class="text-gray-400 hover:text-white">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>
            
            <div class="p-6 space-y-6">
                <!-- Zone de drag & drop -->
                <div class="drag-drop-zone" id="drag-drop-zone">
                    <div class="text-4xl mb-4">üìÑ</div>
                    <h4 class="text-lg font-semibold mb-2">Glissez-d√©posez votre fichier JSON ici</h4>
                    <p class="text-gray-400 mb-4">ou cliquez pour s√©lectionner un fichier</p>
                    <input type="file" id="import-file-input" accept=".json" class="hidden">
                    <button type="button" onclick="document.getElementById('import-file-input').click()" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg text-sm font-medium">
                        <i class="fas fa-folder-open mr-2"></i>Choisir un fichier
                    </button>
                </div>

                <!-- Ou saisie manuelle -->
                <div>
                    <h4 class="text-lg font-semibold mb-4">Ou collez votre JSON directement :</h4>
                    <textarea id="import-json-textarea" rows="10" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white font-mono text-sm" placeholder='[
  {
    "name": "H√¥tel Example",
    "category": "hotel",
    "address": "123 Rue Example, Paris",
    "region": "ile-de-france",
    "rating": 8.5,
    "userRating": 8.2,
    "priceLevel": 3,
    "description": "Un magnifique h√¥tel au c≈ìur de Paris"
  }
]'></textarea>
                </div>

                <!-- Pr√©visualisation -->
                <div id="import-preview" class="hidden">
                    <h4 class="text-lg font-semibold mb-2">üìã Pr√©visualisation :</h4>
                    <div id="import-preview-content" class="file-preview">
                        <p class="text-green-400 mb-2">‚úÖ Fichier JSON valide !</p>
                        <div id="import-stats" class="text-sm text-gray-400 mb-4"></div>
                        <div id="import-json-display" class="json-preview"></div>
                    </div>
                </div>

                <!-- Actions -->
                <div class="flex justify-between items-center">
                    <div class="flex space-x-4">
                        <button type="button" onclick="previewImport()" class="bg-yellow-600 hover:bg-yellow-700 px-6 py-2 rounded-lg font-medium">
                            <i class="fas fa-eye mr-2"></i>Pr√©visualiser
                        </button>
                        <button type="button" onclick="clearImport()" class="bg-gray-600 hover:bg-gray-700 px-6 py-2 rounded-lg font-medium">
                            <i class="fas fa-eraser mr-2"></i>Effacer
                        </button>
                    </div>
                    
                    <div class="flex space-x-4">
                        <button type="button" onclick="closeImportModal()" class="px-6 py-2 border border-gray-600 rounded-lg text-gray-300 hover:bg-gray-700">
                            Annuler
                        </button>
                        <button type="button" onclick="executeImport()" id="import-submit-btn" class="px-6 py-2 bg-green-600 hover:bg-green-700 rounded-lg text-white font-medium" disabled>
                            <i class="fas fa-upload mr-2"></i>Importer
                        </button>
                    </div>
                </div>

                <!-- Aide -->
                <div class="bg-blue-900 bg-opacity-30 border border-blue-500 rounded-lg p-4">
                    <h5 class="text-blue-400 font-semibold mb-2">üí° Format JSON attendu :</h5>
                    <div class="text-sm text-gray-300 space-y-1">
                        <p><strong>Champs obligatoires :</strong> name, category</p>
                        <p><strong>Cat√©gories accept√©es :</strong> "hotel", "restaurant", "spa"</p>
                        <p><strong>R√©gions support√©es :</strong> ile-de-france, provence-alpes-cote-azur, etc.</p>
                        <p><strong>Format :</strong> Tableau JSON avec objets √©tablissements</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ‚úÖ MODAL √âTABLISSEMENT AVEC TEXTE DYNAMIQUE -->
    <div id="edit-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 modal z-50 flex items-center justify-center p-4">
        <div class="bg-gray-800 rounded-xl border border-gray-700 max-w-4xl w-full max-h-screen overflow-y-auto">
            <div class="p-6 border-b border-gray-700">
                <div class="flex items-center justify-between">
                    <h3 class="text-xl font-bold" id="modal-title">Ajouter un √©tablissement</h3>
                    <button onclick="closeModal()" class="text-gray-400 hover:text-white">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>
            
            <form id="establishment-form" class="p-6 space-y-6">
                <!-- Informations de base -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Nom *</label>
                        <input type="text" id="form-name" required class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Type *</label>
                        <select id="form-type" required class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white" onchange="updateFeaturedLabels()">
                            <option value="hotel">H√¥tel</option>
                            <option value="restaurant">Restaurant</option>
                            <option value="spa">Spa</option>
                        </select>
                    </div>
                </div>

                <!-- ‚úÖ ADRESSE ET R√âGION AVEC 18 R√âGIONS -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Adresse *</label>
                        <input type="text" id="form-address" required class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">R√©gion *</label>
                        <select id="form-region" required class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white">
                            <option value="auvergne-rhone-alpes">Auvergne-Rh√¥ne-Alpes</option>
                            <option value="bourgogne-franche-comte">Bourgogne-Franche-Comt√©</option>
                            <option value="bretagne">Bretagne</option>
                            <option value="centre-val-de-loire">Centre-Val de Loire</option>
                            <option value="corse">Corse</option>
                            <option value="grand-est">Grand Est</option>
                            <option value="guadeloupe">Guadeloupe</option>
                            <option value="guyane">Guyane</option>
                            <option value="hauts-de-france">Hauts-de-France</option>
                            <option value="ile-de-france">√éle-de-France</option>
                            <option value="la-reunion">La R√©union</option>
                            <option value="martinique">Martinique</option>
                            <option value="mayotte">Mayotte</option>
                            <option value="normandie">Normandie</option>
                            <option value="nouvelle-aquitaine">Nouvelle-Aquitaine</option>
                            <option value="occitanie">Occitanie</option>
                            <option value="pays-de-la-loire">Pays de la Loire</option>
                            <option value="provence-alpes-cote-azur">Provence-Alpes-C√¥te d'Azur</option>
                        </select>
                    </div>
                </div>

                <!-- Notes et prix -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Note La Revue (/10)</label>
                        <input type="number" id="form-larevue-rating" min="1" max="10" step="0.1" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Note Utilisateurs (/10)</label>
                        <input type="number" id="form-user-rating" min="1" max="10" step="0.1" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Niveau de prix</label>
                        <select id="form-price-level" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white">
                            <option value="1">‚Ç¨ (√âconomique)</option>
                            <option value="2">‚Ç¨‚Ç¨ (Mod√©r√©)</option>
                            <option value="3">‚Ç¨‚Ç¨‚Ç¨ (Cher)</option>
                            <option value="4">‚Ç¨‚Ç¨‚Ç¨‚Ç¨ (Tr√®s cher)</option>
                        </select>
                    </div>
                </div>

                <!-- ‚úÖ SECTION FEATURED DYNAMIQUE -->
                <div class="bg-yellow-500 bg-opacity-20 p-4 rounded-lg border-l-4 border-yellow-500">
                    <h4 class="text-lg font-semibold text-yellow-400 mb-4">
                        <i class="fas fa-star mr-2"></i><span id="featured-title">Notre √âtablissement Favori du Moment</span>
                    </h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">
                                <input type="checkbox" id="form-is-featured" class="mr-2">
                                <span id="featured-checkbox-label">Marquer comme "Notre √âtablissement Favori du Moment"</span>
                            </label>
                            <p class="text-xs text-gray-400">Cet √©tablissement appara√Ætra en premier dans l'app</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Lien de r√©servation</label>
                            <input type="url" id="form-reservation-url" class="w-full bg-gray-600 border border-gray-500 rounded-lg px-4 py-2 text-white" placeholder="https://...">
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Avis positifs (%)</label>
                            <input type="text" id="form-positive-reviews" class="w-full bg-gray-600 border border-gray-500 rounded-lg px-4 py-2 text-white" placeholder="89%">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Avis n√©gatifs (%)</label>
                            <input type="text" id="form-negative-reviews" class="w-full bg-gray-600 border border-gray-500 rounded-lg px-4 py-2 text-white" placeholder="11%">
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Exemple d'avis positif</label>
                            <input type="text" id="form-positive-example" class="w-full bg-gray-600 border border-gray-500 rounded-lg px-4 py-2 text-white" placeholder="Service exceptionnel et vue magnifique">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Exemple d'avis n√©gatif</label>
                            <input type="text" id="form-negative-example" class="w-full bg-gray-600 border border-gray-500 rounded-lg px-4 py-2 text-white" placeholder="Prix un peu √©lev√©">
                        </div>
                    </div>
                </div>

                <!-- ‚úÖ CODES PROMO PREMIUM -->
                <div class="bg-gray-700 p-4 rounded-lg border-l-4 border-yellow-500">
                    <h4 class="text-lg font-semibold text-yellow-400 mb-4">
                        <i class="fas fa-gift mr-2"></i>Codes Promo Premium
                    </h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Code Promo</label>
                            <input type="text" id="form-promo-code" class="w-full bg-gray-600 border border-gray-500 rounded-lg px-4 py-2 text-white" placeholder="HOTEL20">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">R√©duction</label>
                            <input type="text" id="form-promo-discount" class="w-full bg-gray-600 border border-gray-500 rounded-lg px-4 py-2 text-white" placeholder="20%">
                        </div>
                    </div>
                </div>

                <!-- ‚úÖ UPLOAD D'IMAGES -->
                <div class="bg-gray-700 p-4 rounded-lg border-l-4 border-blue-500">
                    <h4 class="text-lg font-semibold text-blue-400 mb-4">
                        <i class="fas fa-camera mr-2"></i>Photos de l'√©tablissement
                    </h4>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">S√©lectionner des images (max 8)</label>
                        <input type="file" id="form-images" multiple accept="image/*" class="w-full bg-gray-600 border border-gray-500 rounded-lg px-4 py-2 text-white">
                        <p class="text-xs text-gray-400 mt-2">Formats accept√©s: JPG, PNG, WebP ‚Ä¢ Taille max: 5MB par image</p>
                    </div>
                    
                    <!-- Pr√©visualisation des images -->
                    <div id="images-preview" class="grid grid-cols-4 gap-4 mt-4"></div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Description</label>
                    <textarea id="form-description" rows="3" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white"></textarea>
                </div>

                <div class="flex justify-end space-x-4">
                    <button type="button" onclick="closeModal()" class="px-6 py-2 border border-gray-600 rounded-lg text-gray-300 hover:bg-gray-700">
                        Annuler
                    </button>
                    <button type="submit" class="px-6 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg text-white font-medium">
                        <span id="form-submit-text">Ajouter</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- ‚úÖ MODAL ACTUALIT√â AVEC TYPE D'√âTABLISSEMENT -->
    <div id="news-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 modal z-50 flex items-center justify-center p-4">
        <div class="bg-gray-800 rounded-xl border border-gray-700 max-w-3xl w-full max-h-screen overflow-y-auto">
            <div class="p-6 border-b border-gray-700">
                <div class="flex items-center justify-between">
                    <h3 class="text-xl font-bold" id="news-modal-title">Ajouter une actualit√©</h3>
                    <button onclick="closeNewsModal()" class="text-gray-400 hover:text-white">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>
            
            <form id="news-form" class="p-6 space-y-6">
                <!-- ‚úÖ INFORMATIONS DE BASE AVEC TYPE D'√âTABLISSEMENT -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Titre *</label>
                        <input type="text" id="news-title" required class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Cat√©gorie *</label>
                        <select id="news-category" required class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white">
                            <option value="Actualit√©s">Actualit√©s</option>
                            <option value="Nouveaut√©s">Nouveaut√©s</option>
                            <option value="Tendances">Tendances</option>
                            <option value="Guide">Guide</option>
                            <option value="Interview">Interview</option>
                        </select>
                    </div>
                    <!-- ‚úÖ NOUVEAU CHAMP : TYPE D'√âTABLISSEMENT -->
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Type d'√©tablissement *</label>
                        <select id="news-establishment-type" required class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white">
                            <option value="hotels">H√¥tels</option>
                            <option value="restaurants">Restaurants</option>
                            <option value="spas">Spas</option>
                            <option value="all">Tous types</option>
                        </select>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">R√©sum√© de l'article *</label>
                    <textarea id="news-summary" rows="4" required class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white" placeholder="R√©sum√© en 2-3 phrases maximum..."></textarea>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">URL de l'image *</label>
                        <input type="url" id="news-image" required class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white" placeholder="https://...">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Lien vers l'article complet *</label>
                        <input type="url" id="news-article-url" required class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white" placeholder="https://...">
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Auteur</label>
                        <input type="text" id="news-author" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white" value="La Revue">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Date de publication</label>
                        <input type="date" id="news-date" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white">
                    </div>
                </div>

                <!-- ‚úÖ SECTION √Ä LA UNE -->
                <div class="bg-yellow-500 bg-opacity-20 p-4 rounded-lg border-l-4 border-yellow-500">
                    <h4 class="text-lg font-semibold text-yellow-400 mb-4">
                        <i class="fas fa-star mr-2"></i>Actualit√© √† la Une
                    </h4>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">
                            <input type="checkbox" id="news-featured" class="mr-2">
                            Marquer comme "Actualit√© √† la Une"
                        </label>
                        <p class="text-xs text-gray-400">Cette actualit√© appara√Ætra en premier dans l'app</p>
                    </div>
                </div>

                <div class="flex justify-end space-x-4">
                    <button type="button" onclick="closeNewsModal()" class="px-6 py-2 border border-gray-600 rounded-lg text-gray-300 hover:bg-gray-700">
                        Annuler
                    </button>
                    <button type="submit" class="px-6 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg text-white font-medium">
                        <span id="news-submit-text">Ajouter</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Variables globales
        let currentTab = 'hotels';
        let editingId = null;
        let editingNewsId = null;
        let selectedImages = [];
        let importData = null;

        // ‚úÖ FONCTIONS UTILITAIRES POUR TYPE D'√âTABLISSEMENT
        function getEstablishmentIcon(type) {
            const icons = {
                'hotels': 'üè®',
                'restaurants': 'üçΩÔ∏è',
                'spas': 'üßò',
                'all': 'üè¢'
            };
            return icons[type] || 'üè¢';
        }

        function getEstablishmentLabel(type) {
            const labels = {
                'hotels': 'H√¥tels',
                'restaurants': 'Restaurants',
                'spas': 'Spas',
                'all': 'Tous types'
            };
            return labels[type] || 'Tous types';
        }

        // ‚úÖ FONCTION POUR METTRE √Ä JOUR LES TEXTES SELON LE TYPE
        function updateFeaturedLabels() {
            const type = document.getElementById('form-type').value;
            const featuredTitle = document.getElementById('featured-title');
            const featuredCheckboxLabel = document.getElementById('featured-checkbox-label');
            
            const labels = {
                'hotel': {
                    title: 'Notre H√¥tel Favori du Moment',
                    checkbox: 'Marquer comme "Notre H√¥tel Favori du Moment"'
                },
                'restaurant': {
                    title: 'Notre Restaurant Favori du Moment',
                    checkbox: 'Marquer comme "Notre Restaurant Favori du Moment"'
                },
                'spa': {
                    title: 'Notre Spa Favori du Moment',
                    checkbox: 'Marquer comme "Notre Spa Favori du Moment"'
                }
            };
            
            if (featuredTitle && featuredCheckboxLabel) {
                featuredTitle.textContent = labels[type]?.title || 'Notre √âtablissement Favori du Moment';
                featuredCheckboxLabel.textContent = labels[type]?.checkbox || 'Marquer comme "Notre √âtablissement Favori du Moment"';
            }
        }

        // ‚úÖ FONCTIONS MODAL IMPORT
        function openImportModal() {
            document.getElementById('import-modal').classList.remove('hidden');
            clearImport();
        }

        function closeImportModal() {
            document.getElementById('import-modal').classList.add('hidden');
            clearImport();
        }

        function clearImport() {
            document.getElementById('import-file-input').value = '';
            document.getElementById('import-json-textarea').value = '';
            document.getElementById('import-preview').classList.add('hidden');
            document.getElementById('import-submit-btn').disabled = true;
            importData = null;
            
            // R√©initialiser la zone de drag & drop
            const dragZone = document.getElementById('drag-drop-zone');
            dragZone.classList.remove('drag-over');
        }

        function previewImport() {
            const fileInput = document.getElementById('import-file-input');
            const textArea = document.getElementById('import-json-textarea');
            
            let jsonString = '';
            
            if (fileInput.files.length > 0) {
                // Lire le fichier
                const file = fileInput.files[0];
                const reader = new FileReader();
                reader.onload = function(e) {
                    processImportPreview(e.target.result);
                };
                reader.readAsText(file);
                return;
            } else if (textArea.value.trim()) {
                jsonString = textArea.value.trim();
                processImportPreview(jsonString);
            } else {
                showError('Veuillez s√©lectionner un fichier ou coller du JSON');
            }
        }

        function processImportPreview(jsonString) {
            try {
                const parsedData = JSON.parse(jsonString);
                importData = Array.isArray(parsedData) ? parsedData : [parsedData];
                
                // Validation basique
                const validItems = [];
                const invalidItems = [];
                
                importData.forEach((item, index) => {
                    if (item.name && item.category) {
                        validItems.push(item);
                    } else {
                        invalidItems.push({ index, item, reason: 'Nom ou cat√©gorie manquant' });
                    }
                });
                
                // Afficher la pr√©visualisation
                const previewDiv = document.getElementById('import-preview');
                const statsDiv = document.getElementById('import-stats');
                const jsonDisplay = document.getElementById('import-json-display');
                
                let statsHTML = `
                    <p>üìä Total: ${importData.length} √©tablissement${importData.length > 1 ? 's' : ''}</p>
                    <p>‚úÖ Valides: ${validItems.length}</p>
                `;
                
                if (invalidItems.length > 0) {
                    statsHTML += `<p>‚ùå Invalides: ${invalidItems.length}</p>`;
                }
                
                statsDiv.innerHTML = statsHTML;
                jsonDisplay.textContent = JSON.stringify(validItems.slice(0, 3), null, 2) + 
                    (validItems.length > 3 ? '\n... et ' + (validItems.length - 3) + ' autres' : '');
                
                previewDiv.classList.remove('hidden');
                document.getElementById('import-submit-btn').disabled = validItems.length === 0;
                
                if (invalidItems.length > 0) {
                    console.warn('‚ùå √âl√©ments invalides:', invalidItems);
                    showError(`${invalidItems.length} √©l√©ment(s) invalide(s). Voir la console pour les d√©tails.`);
                }
                
                showSuccess(`‚úÖ Pr√©visualisation g√©n√©r√©e ! ${validItems.length} √©tablissement(s) pr√™t(s) √† importer.`);
                
            } catch (error) {
                console.error('‚ùå Erreur parsing JSON:', error);
                showError('JSON invalide: ' + error.message);
            }
        }

        async function executeImport() {
            if (!importData || importData.length === 0) {
                showError('Aucune donn√©e √† importer');
                return;
            }
            
            const submitBtn = document.getElementById('import-submit-btn');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Import en cours...';
            submitBtn.disabled = true;
            
            try {
                await window.importEstablishments(importData);
                closeImportModal();
            } catch (error) {
                console.error('‚ùå Erreur import:', error);
                showError('Erreur lors de l\'import: ' + error.message);
            } finally {
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        }

        // ‚úÖ GESTION DRAG & DROP POUR IMPORT
        document.addEventListener('DOMContentLoaded', () => {
            const dragZone = document.getElementById('drag-drop-zone');
            const fileInput = document.getElementById('import-file-input');
            
            if (dragZone && fileInput) {
                // Gestionnaires drag & drop
                dragZone.addEventListener('click', () => {
                    fileInput.click();
                });
                
                dragZone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    dragZone.classList.add('drag-over');
                });
                
                dragZone.addEventListener('dragleave', (e) => {
                    e.preventDefault();
                    dragZone.classList.remove('drag-over');
                });
                
                dragZone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    dragZone.classList.remove('drag-over');
                    
                    const files = e.dataTransfer.files;
                    if (files.length > 0 && files[0].type === 'application/json') {
                        fileInput.files = files;
                        showSuccess('üìÑ Fichier JSON d√©tect√© !');
                    } else {
                        showError('Veuillez d√©poser un fichier JSON valide');
                    }
                });
                
                fileInput.addEventListener('change', (e) => {
                    if (e.target.files.length > 0) {
                        const file = e.target.files[0];
                        if (file.type === 'application/json') {
                            showSuccess(`üìÑ Fichier s√©lectionn√©: ${file.name}`);
                        } else {
                            showError('Veuillez s√©lectionner un fichier JSON');
                            e.target.value = '';
                        }
                    }
                });
            }
        });

        // ‚úÖ FONCTION POUR METTRE √Ä JOUR LES ACTIONS
        function updateActionsSection() {
            const actionsContainer = document.getElementById('actions-container');
            
            if (currentTab === 'news') {
                actionsContainer.innerHTML = `
                    <button onclick="openNewsModal()" class="bg-green-600 hover:bg-green-700 px-6 py-3 rounded-lg font-medium transition-colors">
                        <i class="fas fa-plus mr-2"></i>Ajouter une actualit√©
                    </button>
                    <button onclick="loadCurrentTab()" class="bg-blue-600 hover:bg-blue-700 px-6 py-3 rounded-lg font-medium transition-colors">
                        <i class="fas fa-refresh mr-2"></i>Actualiser
                    </button>
                    <button onclick="exportNewsData()" class="bg-purple-600 hover:bg-purple-700 px-6 py-3 rounded-lg font-medium transition-colors">
                        <i class="fas fa-download mr-2"></i>Exporter les actualit√©s
                    </button>
                `;
            } else if (currentTab === 'reviews') {
                actionsContainer.innerHTML = `
                    <button onclick="loadCurrentTab()" class="bg-blue-600 hover:bg-blue-700 px-6 py-3 rounded-lg font-medium transition-colors">
                        <i class="fas fa-refresh mr-2"></i>Actualiser
                    </button>
                    <button onclick="exportReviewsData()" class="bg-purple-600 hover:bg-purple-700 px-6 py-3 rounded-lg font-medium transition-colors">
                        <i class="fas fa-download mr-2"></i>Exporter les avis
                    </button>
                    <button onclick="approveAllPendingReviews()" class="bg-green-600 hover:bg-green-700 px-6 py-3 rounded-lg font-medium transition-colors">
                        <i class="fas fa-check-double mr-2"></i>Approuver tous les avis en attente
                    </button>
                `;
            } else {
                // Actions par d√©faut pour les √©tablissements avec nouveaux boutons
                actionsContainer.innerHTML = `
                    <button onclick="openAddModal()" class="bg-green-600 hover:bg-green-700 px-6 py-3 rounded-lg font-medium transition-colors">
                        <i class="fas fa-plus mr-2"></i>Ajouter un √©tablissement
                    </button>
                    <button onclick="window.sortByRating()" class="bg-blue-600 hover:bg-blue-700 px-6 py-3 rounded-lg font-medium transition-colors">
                        <i class="fas fa-sort-numeric-down mr-2"></i>Trier par notes
                    </button>
                    <button onclick="recalculateRankings()" class="bg-blue-600 hover:bg-blue-700 px-6 py-3 rounded-lg font-medium transition-colors">
                        <i class="fas fa-calculator mr-2"></i>Recalculer le classement
                    </button>
                    <button onclick="openImportModal()" class="bg-purple-600 hover:bg-purple-700 px-6 py-3 rounded-lg font-medium transition-colors">
                        <i class="fas fa-upload mr-2"></i>Importer des √©tablissements
                    </button>
                    <button onclick="window.fixCategories()" class="bg-orange-600 hover:bg-orange-700 px-6 py-3 rounded-lg font-medium transition-colors">
                        <i class="fas fa-wrench mr-2"></i>Corriger Cat√©gories
                    </button>
                    <button onclick="window.recalculateAllRatings()" class="bg-green-600 hover:bg-green-700 px-6 py-3 rounded-lg font-medium transition-colors">
                        <i class="fas fa-calculator mr-2"></i>Recalculer Notes G√©n√©rales
                    </button>
                    <button onclick="exportData()" class="bg-purple-600 hover:bg-purple-700 px-6 py-3 rounded-lg font-medium transition-colors">
                        <i class="fas fa-download mr-2"></i>Exporter les donn√©es
                    </button>
                `;
            }
        }

        // ‚úÖ FONCTION UTILITAIRE FORMAT DATE
        function formatDate(date) {
            if (!date) return 'Date inconnue';
            
            const d = date.toDate ? date.toDate() : new Date(date);
            return d.toLocaleDateString('fr-FR', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        }

        // ‚úÖ FONCTION CHARGEMENT ONGLET ACTUALIT√âS
        async function loadNewsTab() {
            showLoading(true);
            
            try {
                const news = await window.loadNews();
                updateStats(news, 'news');
                renderNews(news);
            } catch (error) {
                console.error('Erreur chargement actualit√©s:', error);
                showError('Erreur de connexion Firebase');
            } finally {
                showLoading(false);
            }
        }

        // ‚úÖ FONCTION CHARGEMENT ONGLET AVIS
        async function loadReviewsTab() {
            showLoading(true);
            
            try {
                const reviews = await window.loadReviews();
                
                // Charger aussi les √©tablissements pour les noms
                await Promise.all([
                    window.loadEstablishments('hotels'),
                    window.loadEstablishments('restaurants'),
                    window.loadEstablishments('spas')
                ]);
                
                updateStats(reviews, 'reviews');
                renderReviews(reviews);
            } catch (error) {
                console.error('Erreur chargement avis:', error);
                showError('Erreur de connexion Firebase');
            } finally {
                showLoading(false);
            }
        }

        // ‚úÖ RENDU DES ACTUALIT√âS AVEC TYPE D'√âTABLISSEMENT
        function renderNews(newsData) {
            const container = document.getElementById('establishments-list');
            
            if (newsData.length === 0) {
                container.innerHTML = `
                    <div class="p-12 text-center">
                        <div class="text-6xl mb-4">üì∞</div>
                        <h3 class="text-xl font-bold text-gray-300 mb-2">Aucune actualit√© trouv√©e</h3>
                        <p class="text-gray-400 mb-6">Commencez par ajouter votre premi√®re actualit√©</p>
                        <button onclick="openNewsModal()" class="bg-blue-600 hover:bg-blue-700 px-6 py-3 rounded-lg font-medium">
                            <i class="fas fa-plus mr-2"></i>Ajouter une actualit√©
                        </button>
                    </div>
                `;
                return;
            }

            container.innerHTML = newsData.map((news, index) => `
                <div class="news-item p-6 border-b border-gray-700 last:border-b-0 ${news.isFeatured ? 'featured-news' : ''}" id="news-${news.id}">
                    ${news.isFeatured ? `
                        <div class="featured-news-badge px-4 py-2 rounded-full text-sm font-bold text-black mb-4 inline-flex items-center">
                            <i class="fas fa-star mr-2"></i>Actualit√© √† la Une
                        </div>
                    ` : ''}
                    
                    <div class="flex items-start">
                        <!-- Image -->
                        <div class="flex-shrink-0">
                            <img src="${news.imageUrl}" alt="${news.title}" class="news-image">
                        </div>
                        
                        <!-- Contenu -->
                        <div class="news-content">
                            <div class="flex items-center gap-2 mb-2">
                                <div class="news-badge">${news.category}</div>
                                <!-- ‚úÖ NOUVEAU : BADGE TYPE D'√âTABLISSEMENT -->
                                <div class="establishment-type-badge">
                                    ${getEstablishmentIcon(news.establishmentType)} ${getEstablishmentLabel(news.establishmentType)}
                                </div>
                            </div>
                            
                            <h3 class="news-title">${news.title}</h3>
                            
                            <div class="news-meta">
                                <span class="news-date">
                                    <i class="fas fa-calendar mr-1"></i>
                                    ${formatDate(news.publishedAt)}
                                </span>
                                <span class="news-author">
                                    <i class="fas fa-user mr-1"></i>
                                    ${news.author}
                                </span>
                            </div>
                            
                            <p class="news-summary">${news.summary}</p>
                            
                            <div class="flex items-center justify-between">
                                <a href="${news.articleUrl}" target="_blank" class="news-link">
                                    <i class="fas fa-external-link-alt"></i>
                                    Lire l'article complet
                                </a>
                                
                                <div class="flex space-x-2">
                                    <button onclick="editNews('${news.id}')" class="px-3 py-2 bg-yellow-600 hover:bg-yellow-700 rounded-lg text-sm font-medium transition-colors">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button onclick="deleteNewsItem('${news.id}')" class="px-3 py-2 bg-red-600 hover:bg-red-700 rounded-lg text-sm font-medium transition-colors">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // ‚úÖ RENDU DES AVIS AVEC CORRECTION PHOTOS
        function renderReviews(reviewsData) {
            const container = document.getElementById('establishments-list');
            
            if (reviewsData.length === 0) {
                container.innerHTML = `
                    <div class="p-12 text-center">
                        <div class="text-6xl mb-4">üí¨</div>
                        <h3 class="text-xl font-bold text-gray-300 mb-2">Aucun avis trouv√©</h3>
                        <p class="text-gray-400 mb-6">Les avis des utilisateurs appara√Ætront ici</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = reviewsData.map((review) => {
                const establishmentName = getEstablishmentName(review.establishmentId);
                const statusText = {
                    pending: 'En attente',
                    approved: 'Approuv√©',
                    rejected: 'Rejet√©'
                };
                
                const statusClass = review.status || 'pending';
                
                return `
                    <div class="review-item p-6 border-b border-gray-700 last:border-b-0" id="review-${review.id}">
                        <div class="flex items-start justify-between mb-4">
                            <div class="flex items-center space-x-4">
                                <div class="user-avatar">
                                    ${(review.userName || 'U')[0].toUpperCase()}
                                </div>
                                <div>
                                    <h3 class="text-lg font-bold text-white">${review.userName || 'Utilisateur anonyme'}</h3>
                                    <p class="text-gray-400">${establishmentName}</p>
                                    <p class="text-sm text-gray-500">${formatDate(review.createdAt)}</p>
                                </div>
                            </div>
                            
                            <div class="flex items-center space-x-4">
                                <div class="rating-badge">
                                    ${review.globalRating}/10 ‚≠ê
                                </div>
                                <div class="review-status ${statusClass}">
                                    ${statusText[review.status] || 'En attente'}
                                </div>
                            </div>
                        </div>
                        
                        <!-- Notes d√©taill√©es -->
                        ${review.ratings ? `
                            <div class="criteria-ratings">
                                ${Object.entries(review.ratings).map(([key, rating]) => `
                                    <div class="criteria-item">
                                        <span class="criteria-label">
                                            ${key === 'location' ? 'Localisation' :
                                              key === 'service' ? 'Service' :
                                              key === 'comfort' ? 'Confort' :
                                              key === 'valueForMoney' ? 'Qualit√©/Prix' : key}
                                        </span>
                                        <span class="criteria-value">${rating}/10</span>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                        
                        <!-- Commentaire -->
                        <div class="bg-gray-700 p-4 rounded-lg mt-4 mb-4">
                            <p class="text-gray-200">${review.comment}</p>
                        </div>
                        
                        <!-- ‚úÖ PHOTOS CORRIG√âES -->
                        ${review.photos && review.photos.length > 0 ? `
                            <div class="review-photos">
                                <p class="text-sm text-gray-400 mb-2">üì∏ Photos (${review.photos.length})</p>
                                <div class="flex space-x-2">
                                    ${review.photos.slice(0, 6).map((photo, index) => {
                                        // ‚úÖ CORRECTION : Utiliser 'url' au lieu de 'uploadURL'
                                        const photoUrl = photo.url || photo.uploadURL || photo.downloadURL || photo.uri || '';
                                        
                                        return photoUrl ? `
                                            <img src="${photoUrl}" 
                                                 alt="Photo avis ${index + 1}" 
                                                 class="review-photo"
                                                 onclick="openPhotoModal('${photoUrl}')"
                                                 onerror="console.error('‚ùå Erreur photo:', this.src); this.style.opacity='0.5'; this.title='Erreur de chargement';">
                                        ` : `
                                            <div class="w-16 h-16 bg-gray-600 rounded-lg flex items-center justify-center">
                                                <i class="fas fa-image text-gray-400"></i>
                                            </div>
                                        `;
                                    }).join('')}
                                    ${review.photos.length > 6 ? `
                                        <div class="w-16 h-16 bg-gray-700 rounded-lg flex items-center justify-center">
                                            <span class="text-xs text-gray-400">+${review.photos.length - 6}</span>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        ` : ''}
                        
                        <!-- M√©tadonn√©es -->
                        ${review.typeSpecificData ? `
                            <div class="flex space-x-4 mt-4 text-sm text-gray-400">
                                ${review.typeSpecificData.roomType ? `<span>üõèÔ∏è ${review.typeSpecificData.roomType}</span>` : ''}
                                ${review.typeSpecificData.stayDuration ? `<span>‚è±Ô∏è ${review.typeSpecificData.stayDuration}</span>` : ''}
                                ${review.typeSpecificData.travelType ? `<span>‚úàÔ∏è ${review.typeSpecificData.travelType}</span>` : ''}
                            </div>
                        ` : ''}
                        
                        <!-- Actions -->
                        <div class="flex space-x-2 mt-4">
                            ${review.status === 'pending' ? `
                                <button onclick="moderateReview('${review.id}', 'approved')" class="px-4 py-2 bg-green-600 hover:bg-green-700 rounded-lg text-sm font-medium transition-colors">
                                    <i class="fas fa-check mr-1"></i>Approuver
                                </button>
                                <button onclick="moderateReview('${review.id}', 'rejected')" class="px-4 py-2 bg-red-600 hover:bg-red-700 rounded-lg text-sm font-medium transition-colors">
                                    <i class="fas fa-times mr-1"></i>Rejeter
                                </button>
                            ` : ''}
                            <button onclick="viewReviewDetails('${review.id}')" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 rounded-lg text-sm font-medium transition-colors">
                                <i class="fas fa-eye mr-1"></i>D√©tails
                            </button>
                            <button onclick="deleteReview('${review.id}')" class="px-4 py-2 bg-red-600 hover:bg-red-700 rounded-lg text-sm font-medium transition-colors">
                                <i class="fas fa-trash mr-1"></i>Supprimer
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ‚úÖ FONCTION POUR OBTENIR LE NOM DE L'√âTABLISSEMENT
        function getEstablishmentName(establishmentId) {
            // Chercher dans tous les √©tablissements charg√©s
            const allEstablishments = [
                ...window.currentEstablishments
            ];
            
            const establishment = allEstablishments.find(e => e.id === establishmentId);
            return establishment ? establishment.name : '√âtablissement inconnu';
        }

        // ‚úÖ FONCTIONS MODAL ACTUALIT√âS AVEC TYPE D'√âTABLISSEMENT
        function openNewsModal() {
            editingNewsId = null;
            document.getElementById('news-modal-title').textContent = 'Ajouter une actualit√©';
            document.getElementById('news-submit-text').textContent = 'Ajouter';
            document.getElementById('news-form').reset();
            document.getElementById('news-date').value = new Date().toISOString().split('T')[0];
            // ‚úÖ D√âFINIR LE TYPE D'√âTABLISSEMENT PAR D√âFAUT SELON L'ONGLET ACTUEL
            document.getElementById('news-establishment-type').value = currentTab === 'news' ? 'hotels' : currentTab;
            document.getElementById('news-modal').classList.remove('hidden');
        }

        function editNews(id) {
            const news = window.currentNews.find(n => n.id === id);
            if (!news) return;
            
            editingNewsId = id;
            document.getElementById('news-modal-title').textContent = 'Modifier l\'actualit√©';
            document.getElementById('news-submit-text').textContent = 'Modifier';
            
            // Remplir le formulaire
            document.getElementById('news-title').value = news.title || '';
            document.getElementById('news-category').value = news.category || 'Actualit√©s';
            document.getElementById('news-establishment-type').value = news.establishmentType || 'hotels';
            document.getElementById('news-summary').value = news.summary || '';
            document.getElementById('news-image').value = news.imageUrl || '';
            document.getElementById('news-article-url').value = news.articleUrl || '';
            document.getElementById('news-author').value = news.author || 'La Revue';
            document.getElementById('news-featured').checked = news.isFeatured || false;
            
            const date = news.publishedAt?.toDate ? news.publishedAt.toDate() : new Date(news.publishedAt);
            document.getElementById('news-date').value = date.toISOString().split('T')[0];
            
            document.getElementById('news-modal').classList.remove('hidden');
        }

        function closeNewsModal() {
            document.getElementById('news-modal').classList.add('hidden');
            editingNewsId = null;
        }

        async function deleteNewsItem(id) {
            const news = window.currentNews.find(n => n.id === id);
            if (!news) return;
            
            if (!confirm(`√ätes-vous s√ªr de vouloir supprimer l'actualit√© "${news.title}" ?`)) return;
            
            const success = await window.deleteNews(id);
            if (success) {
                showSuccess('Actualit√© supprim√©e !');
                loadNewsTab();
            } else {
                showError('Erreur lors de la suppression');
            }
        }

        // ‚úÖ FONCTIONS DE MOD√âRATION DES AVIS
        async function moderateReview(reviewId, newStatus) {
            if (!confirm(`√ätes-vous s√ªr de vouloir ${newStatus === 'approved' ? 'approuver' : 'rejeter'} cet avis ?`)) {
                return;
            }
            
            try {
                const success = await window.updateReview(reviewId, {
                    status: newStatus,
                    moderatedAt: new Date(),
                    moderatedBy: 'admin'
                });
                
                if (success) {
                    showSuccess(`Avis ${newStatus === 'approved' ? 'approuv√©' : 'rejet√©'} avec succ√®s`);
                    loadReviewsTab();
                } else {
                    showError('Erreur lors de la mod√©ration');
                }
            } catch (error) {
                console.error('Erreur mod√©ration:', error);
                showError('Erreur lors de la mod√©ration');
            }
        }

        function viewReviewDetails(reviewId) {
            const review = window.currentReviews.find(r => r.id === reviewId);
            if (!review) return;
            
            const establishmentName = getEstablishmentName(review.establishmentId);
            
            alert(`D√©tails de l'avis:

Utilisateur: ${review.userName || 'Anonyme'}
√âtablissement: ${establishmentName}
Note globale: ${review.globalRating}/10
Date: ${formatDate(review.createdAt)}
Statut: ${review.status || 'En attente'}

Commentaire:
${review.comment}

Photos: ${review.photos ? review.photos.length : 0}
Type sp√©cifique: ${review.typeSpecificData ? JSON.stringify(review.typeSpecificData, null, 2) : 'Aucune'}`);
        }

        async function deleteReview(reviewId) {
            if (!confirm('√ätes-vous s√ªr de vouloir supprimer cet avis ?')) return;
            
            try {
                const docRef = window.firebaseModules.doc(window.firebaseApp.db, window.firebaseApp.COLLECTIONS.REVIEWS, reviewId);
                await window.firebaseModules.deleteDoc(docRef);
                showSuccess('Avis supprim√© !');
                loadReviewsTab();
            } catch (error) {
                console.error('Erreur suppression avis:', error);
                showError('Erreur lors de la suppression');
            }
        }

        function openPhotoModal(photoUrl) {
            window.open(photoUrl, '_blank');
        }

        async function approveAllPendingReviews() {
            const pendingReviews = window.currentReviews.filter(r => r.status === 'pending');
            
            if (pendingReviews.length === 0) {
                showError('Aucun avis en attente');
                return;
            }
            
            if (!confirm(`Approuver tous les ${pendingReviews.length} avis en attente ?`)) return;
            
            try {
                const promises = pendingReviews.map(review => 
                    window.updateReview(review.id, {
                        status: 'approved',
                        moderatedAt: new Date(),
                        moderatedBy: 'admin'
                    })
                );
                
                await Promise.all(promises);
                showSuccess(`${pendingReviews.length} avis approuv√©s !`);
                loadReviewsTab();
            } catch (error) {
                console.error('Erreur approbation massive:', error);
                showError('Erreur lors de l\'approbation massive');
            }
        }

        // ‚úÖ GESTION FORMULAIRE ACTUALIT√â AVEC TYPE √âTABLISSEMENT
        document.getElementById('news-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const submitBtn = document.querySelector('#news-form button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Enregistrement...';
            submitBtn.disabled = true;
            
            try {
                const formData = {
                    title: document.getElementById('news-title').value,
                    summary: document.getElementById('news-summary').value,
                    imageUrl: document.getElementById('news-image').value,
                    articleUrl: document.getElementById('news-article-url').value,
                    author: document.getElementById('news-author').value || 'La Revue',
                    category: document.getElementById('news-category').value,
                    establishmentType: document.getElementById('news-establishment-type').value,
                    isFeatured: document.getElementById('news-featured').checked,
                    publishedAt: new Date(document.getElementById('news-date').value || new Date()),
                    isActive: true,
                    createdAt: new Date(),
                    updatedAt: new Date()
                };
                
                console.log('üìù Donn√©es actualit√© √† sauvegarder:', formData);
                
                if (editingNewsId) {
                    // MISE √Ä JOUR
                    const success = await window.updateNews(editingNewsId, formData);
                    if (success) {
                        showSuccess(`Actualit√© ${formData.isFeatured ? '‚≠ê marqu√©e √† la Une' : 'modifi√©e'} avec succ√®s !`);
                    } else {
                        showError('Erreur lors de la modification');
                        return;
                    }
                } else {
                    // CR√âATION
                    const result = await window.addNewNews(formData);
                    if (result) {
                        showSuccess(`Actualit√© ${formData.isFeatured ? '‚≠ê marqu√©e √† la Une' : 'cr√©√©e'} avec succ√®s !`);
                    } else {
                        showError('Erreur lors de la cr√©ation');
                        return;
                    }
                }
                
                closeNewsModal();
                loadNewsTab();
                
            } catch (error) {
                console.error('‚ùå Erreur formulaire actualit√©:', error);
                showError('Erreur lors de la sauvegarde: ' + error.message);
            } finally {
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        });

        // ‚úÖ GESTION AUTOMATIQUE DU FEATURED POUR ACTUALIT√âS
        document.getElementById('news-featured').addEventListener('change', function(e) {
            if (e.target.checked) {
                if (!confirm('‚ö†Ô∏è Attention : Une seule actualit√© peut √™tre "√† la Une" √† la fois.\n\nEn activant cette option, toutes les autres actualit√©s perdront ce statut.\n\nContinuer ?')) {
                    e.target.checked = false;
                    return;
                }
            }
        });

        // ‚úÖ FONCTION EXPORT ACTUALIT√âS
        function exportNewsData() {
            if (!window.currentNews || window.currentNews.length === 0) {
                showError('Aucune actualit√© √† exporter');
                return;
            }
            
            const csvData = [
                ['ID', 'Titre', 'Cat√©gorie', 'Type √âtablissement', 'Auteur', 'Date', '√Ä la Une', 'Lien Article', 'R√©sum√©'],
                ...window.currentNews.map(news => [
                    news.id,
                    news.title,
                    news.category,
                    getEstablishmentLabel(news.establishmentType),
                    news.author,
                    formatDate(news.publishedAt),
                    news.isFeatured ? 'Oui' : 'Non',
                    news.articleUrl,
                    news.summary
                ])
            ];
            
            const csvContent = csvData.map(row => row.join(',')).join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `actualites_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            
            showSuccess('Actualit√©s export√©es avec succ√®s !');
        }

        // ‚úÖ FONCTION EXPORT AVIS
        function exportReviewsData() {
            if (!window.currentReviews || window.currentReviews.length === 0) {
                showError('Aucun avis √† exporter');
                return;
            }
            
            const csvData = [
                ['ID', 'Utilisateur', '√âtablissement', 'Note Globale', 'Statut', 'Date', 'Commentaire', 'Photos'],
                ...window.currentReviews.map(review => [
                    review.id,
                    review.userName || 'Anonyme',
                    getEstablishmentName(review.establishmentId),
                    review.globalRating,
                    review.status || 'pending',
                    formatDate(review.createdAt),
                    review.comment,
                    review.photos ? review.photos.length : 0
                ])
            ];
            
            const csvContent = csvData.map(row => row.join(',')).join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `avis_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            
            showSuccess('Avis export√©s avec succ√®s !');
        }

        // ‚úÖ FONCTION SWITCH TAB AVEC ACTUALIT√âS ET AVIS
        function switchTab(tab) {
            currentTab = tab;
            
            document.querySelectorAll('.nav-tab').forEach(btn => {
                btn.className = 'nav-tab px-6 py-3 rounded-lg font-medium transition-all duration-300 bg-gray-700 text-gray-300 hover:bg-gray-600';
            });
            document.getElementById(`tab-${tab}`).className = 'nav-tab px-6 py-3 rounded-lg font-medium transition-all duration-300 bg-blue-600 text-white';
            
            const titles = {
                hotels: 'üè® Classement des H√¥tels',
                restaurants: 'üçΩÔ∏è Classement des Restaurants',
                spas: 'üßò Classement des Spas',
                news: 'üì∞ Actualit√©s',
                reviews: 'üí¨ Mod√©ration des Avis'
            };
            
            const descriptions = {
                hotels: 'Glissez-d√©posez pour modifier le classement ‚Ä¢ Cliquez pour modifier',
                restaurants: 'Glissez-d√©posez pour modifier le classement ‚Ä¢ Cliquez pour modifier',
                spas: 'Glissez-d√©posez pour modifier le classement ‚Ä¢ Cliquez pour modifier',
                news: 'G√©rez les actualit√©s et articles ‚Ä¢ Cliquez pour modifier',
                reviews: 'Mod√©rez les avis des utilisateurs ‚Ä¢ Approuvez ou rejetez'
            };
            
            document.getElementById('section-title').textContent = titles[tab];
            document.getElementById('section-description').textContent = descriptions[tab];
            
            // ‚úÖ METTRE √Ä JOUR LES ACTIONS
            updateActionsSection();
            
            if (tab === 'news') {
                loadNewsTab();
            } else if (tab === 'reviews') {
                loadReviewsTab();
            } else {
                loadDashboard();
            }
        }

        // ‚úÖ FONCTION POUR CHARGER L'ONGLET ACTUEL
        function loadCurrentTab() {
            if (currentTab === 'news') {
                loadNewsTab();
            } else if (currentTab === 'reviews') {
                loadReviewsTab();
            } else {
                loadDashboard();
            }
        }

        // ‚úÖ FONCTION PRINCIPALE CHARGEMENT DASHBOARD
        async function loadDashboard() {
            showLoading(true);
            
            try {
                const establishments = await window.loadEstablishments(currentTab);
                updateStats(establishments, currentTab);
                renderEstablishments(establishments);
            } catch (error) {
                console.error('Erreur chargement dashboard:', error);
                showError('Erreur de connexion Firebase');
            } finally {
                showLoading(false);
            }
        }

        // ‚úÖ FONCTION MISE √Ä JOUR STATS
        function updateStats(data, type) {
            const statTotal = document.getElementById('stat-total');
            const statAverage = document.getElementById('stat-average');
            const statThirdTitle = document.getElementById('stat-third-title');
            const statThirdValue = document.getElementById('stat-third-value');
            const statThirdIcon = document.getElementById('stat-third-icon');
            
            if (type === 'news') {
                statTotal.textContent = data.length;
                statAverage.textContent = data.filter(n => n.isFeatured).length + ' ‚≠ê';
                statThirdTitle.textContent = '√Ä la Une';
                statThirdValue.textContent = data.filter(n => n.isFeatured).length;
                statThirdIcon.className = 'fas fa-star text-white text-xl';
            } else if (type === 'reviews') {
                const pending = data.filter(r => r.status === 'pending').length;
                const approved = data.filter(r => r.status === 'approved').length;
                const avgRating = data.length > 0 ? 
                    (data.reduce((sum, review) => sum + (review.globalRating || 0), 0) / data.length).toFixed(1) : 
                    '0.0';
                
                statTotal.textContent = data.length;
                statAverage.textContent = avgRating;
                statThirdTitle.textContent = 'En attente';
                statThirdValue.textContent = pending;
                statThirdIcon.className = 'fas fa-clock text-white text-xl';
            } else {
                statTotal.textContent = data.length;
                const avgRating = data.length > 0 ? 
                    (data.reduce((sum, item) => sum + (window.calculateOverallRating(item.laRevueRating, item.usersRating) || 0), 0) / data.length).toFixed(1) : 
                    '0.0';
                statAverage.textContent = avgRating;
                statThirdTitle.textContent = 'Top 3';
                statThirdValue.textContent = 'üèÜü•àü•â';
                statThirdIcon.className = 'fas fa-medal text-white text-xl';
            }
        }

        // ‚úÖ GESTION PR√âVISUALISATION IMAGES
        document.getElementById('form-images').addEventListener('change', function(e) {
            const files = Array.from(e.target.files);
            selectedImages = files;
            
            const previewContainer = document.getElementById('images-preview');
            previewContainer.innerHTML = '';
            
            files.forEach((file, index) => {
                if (index >= 8) return; // Max 8 images
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    const previewDiv = document.createElement('div');
                    previewDiv.className = 'image-preview';
                    previewDiv.innerHTML = `
                        <img src="${e.target.result}" alt="Preview ${index + 1}">
                        <button type="button" class="remove-btn" onclick="removeImage(${index})">
                            <i class="fas fa-times"></i>
                        </button>
                    `;
                    previewContainer.appendChild(previewDiv);
                };
                reader.readAsDataURL(file);
            });
        });

        // ‚úÖ SUPPRIMER UNE IMAGE
        function removeImage(index) {
            selectedImages.splice(index, 1);
            
            // Recr√©er le FileList (simulation)
            const dt = new DataTransfer();
            selectedImages.forEach(file => dt.items.add(file));
            document.getElementById('form-images').files = dt.files;
            
            // Re-trigger l'√©v√©nement change
            document.getElementById('form-images').dispatchEvent(new Event('change'));
        }

        // ‚úÖ FONCTION RENDU √âTABLISSEMENTS AVEC CALCUL AUTOMATIQUE NOTE G√âN√âRALE
        function renderEstablishments(establishments) {
            const container = document.getElementById('establishments-list');
            
            if (establishments.length === 0) {
                container.innerHTML = `
                    <div class="p-12 text-center">
                        <div class="text-6xl mb-4">
                            ${currentTab === 'hotels' ? 'üè®' : currentTab === 'restaurants' ? 'üçΩÔ∏è' : 'üßò'}
                        </div>
                        <h3 class="text-xl font-bold text-gray-300 mb-2">Aucun √©tablissement trouv√©</h3>
                        <p class="text-gray-400 mb-6">Commencez par ajouter votre premier ${currentTab.slice(0, -1)}</p>
                        <button onclick="openAddModal()" class="bg-blue-600 hover:bg-blue-700 px-6 py-3 rounded-lg font-medium">
                            <i class="fas fa-plus mr-2"></i>Ajouter un √©tablissement
                        </button>
                    </div>
                `;
                return;
            }

            container.innerHTML = establishments.map((establishment, index) => {
                const isTop3 = establishment.rank <= 3;
                const trophyIcon = establishment.rank === 1 ? 'üèÜ' : establishment.rank === 2 ? 'ü•à' : establishment.rank === 3 ? 'ü•â' : '';
                
                // ‚úÖ CALCUL AUTOMATIQUE DE LA NOTE G√âN√âRALE
                const calculatedOverallRating = window.calculateOverallRating(establishment.laRevueRating, establishment.usersRating);
                
                return `
                    <div class="ranking-item p-6 border-b border-gray-700 last:border-b-0 ${establishment.isFeatured ? 'featured-item' : ''}" 
                         data-id="${establishment.id}" 
                         data-rank="${establishment.rank}">
                        
                        ${establishment.isFeatured ? `
                            <div class="featured-badge px-4 py-2 rounded-full text-sm font-bold text-black mb-4 inline-flex items-center">
                                <i class="fas fa-star mr-2"></i>Notre ${currentTab === 'hotels' ? 'H√¥tel' : currentTab === 'restaurants' ? 'Restaurant' : currentTab === 'spas' ? 'Spa' : '√âtablissement'} Favori du Moment
                            </div>
                        ` : ''}
                        
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-6">
                                <!-- Rang -->
                                <div class="flex items-center space-x-2">
                                    <span class="text-3xl font-bold ${isTop3 ? 'text-yellow-400' : 'text-gray-400'}">
                                        #${establishment.rank}
                                    </span>
                                    ${trophyIcon ? `<span class="text-2xl">${trophyIcon}</span>` : ''}
                                </div>
                                
                                <!-- Infos principales -->
                                <div class="flex-1">
                                    <h3 class="text-xl font-bold text-white mb-1">${establishment.name}</h3>
                                    <p class="text-gray-400 mb-2">${establishment.address}</p>
                                    <div class="flex items-center space-x-4 text-sm text-gray-400">
                                        <span><i class="fas fa-map-marker-alt mr-1"></i>${establishment.region}</span>
                                        <span><i class="fas fa-euro-sign mr-1"></i>${'‚Ç¨'.repeat(establishment.priceLevel)}</span>
                                        ${establishment.promoCode ? `<span class="text-yellow-400"><i class="fas fa-gift mr-1"></i>Code promo</span>` : ''}
                                    </div>
                                </div>
                            </div>
                            
                            <!-- ‚úÖ AFFICHAGE NOTES AVEC CALCUL AUTOMATIQUE -->
                            <div class="flex items-center space-x-6">
                                <!-- Note G√©n√©rale (CALCUL√âE AUTOMATIQUEMENT) -->
                                <div class="text-center">
                                    <div class="text-sm text-gray-400 mb-1">Note G√©n√©rale</div>
                                    <div class="flex items-center">
                                        <span class="text-3xl font-bold text-green-400" onclick="editRating('${establishment.id}', 'overallRating')">${calculatedOverallRating}/10</span>
                                        <button class="ml-2 text-xs text-gray-500 hover:text-green-400" onclick="editRating('${establishment.id}', 'overallRating')">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Note La Revue -->
                                <div class="text-center">
                                    <div class="text-sm text-gray-400 mb-1">La Revue</div>
                                    <div class="flex items-center">
                                        <span class="text-2xl font-bold text-yellow-400" onclick="editRating('${establishment.id}', 'laRevueRating')">${establishment.laRevueRating}/10</span>
                                        <button class="ml-2 text-xs text-gray-500 hover:text-yellow-400" onclick="editRating('${establishment.id}', 'laRevueRating')">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Note Utilisateurs -->
                                <div class="text-center">
                                    <div class="text-sm text-gray-400 mb-1">Utilisateurs</div>
                                    <div class="flex items-center">
                                        <span class="text-2xl font-bold text-blue-400" onclick="editRating('${establishment.id}', 'usersRating')">${establishment.usersRating}/10</span>
                                        <button class="ml-2 text-xs text-gray-500 hover:text-blue-400" onclick="editRating('${establishment.id}', 'usersRating')">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                    </div>
                                </div>
                                    
                                <!-- Actions -->
                                <div class="flex space-x-2">
                                    <button onclick="editEstablishment('${establishment.id}')" class="px-4 py-2 bg-yellow-600 hover:bg-yellow-700 rounded-lg text-sm font-medium transition-colors">
                                        <i class="fas fa-edit mr-1"></i>Modifier
                                    </button>
                                    <button onclick="deleteEstablishmentItem('${establishment.id}')" class="px-4 py-2 bg-red-600 hover:bg-red-700 rounded-lg text-sm font-medium transition-colors">
                                        <i class="fas fa-trash mr-1"></i>Supprimer
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Images preview -->
                        ${establishment.images && establishment.images.length > 0 ? `
                            <div class="mt-4 flex space-x-2 overflow-x-auto">
                                ${establishment.images.slice(0, 4).map(img => `
                                    <img src="${img}" alt="Preview" class="w-16 h-16 object-cover rounded-lg border border-gray-600">
                                `).join('')}
                                ${establishment.images.length > 4 ? `
                                    <div class="w-16 h-16 bg-gray-700 rounded-lg border border-gray-600 flex items-center justify-center">
                                        <span class="text-xs text-gray-400">+${establishment.images.length - 4}</span>
                                    </div>
                                ` : ''}
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        // ‚úÖ FONCTIONS UTILITAIRES
        function showLoading(show) {
            const loading = document.getElementById('loading');
            const list = document.getElementById('establishments-list');
            
            if (show) {
                loading.classList.remove('hidden');
                list.classList.add('hidden');
            } else {
                loading.classList.add('hidden');
                list.classList.remove('hidden');
            }
        }

        function showSuccess(message) {
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-green-600 text-white px-6 py-3 rounded-lg shadow-lg z-50';
            notification.innerHTML = `<i class="fas fa-check mr-2"></i>${message}`;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        function showError(message) {
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-red-600 text-white px-6 py-3 rounded-lg shadow-lg z-50';
            notification.innerHTML = `<i class="fas fa-exclamation-triangle mr-2"></i>${message}`;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 5000);
        }

        // ‚úÖ FONCTIONS MODAL √âTABLISSEMENT AVEC CALCUL AUTO NOTE G√âN√âRALE
        function openAddModal() {
            editingId = null;
            document.getElementById('modal-title').textContent = 'Ajouter un √©tablissement';
            document.getElementById('form-submit-text').textContent = 'Ajouter';
            document.getElementById('establishment-form').reset();
            
            // ‚úÖ CORRECTION : Utiliser les valeurs singuli√®res pour le formulaire
            const typeMap = {
                'hotels': 'hotel',
                'restaurants': 'restaurant', 
                'spas': 'spa'
            };
            
            document.getElementById('form-type').value = typeMap[currentTab] || 'hotel';
            
            // ‚úÖ NOUVEAU : Mettre √† jour les labels
            updateFeaturedLabels();
            
            document.getElementById('edit-modal').classList.remove('hidden');
            document.getElementById('images-preview').innerHTML = '';
            selectedImages = [];
        }

        function editEstablishment(id) {
            const establishment = window.currentEstablishments.find(e => e.id === id);
            if (!establishment) return;
            
            editingId = id;
            document.getElementById('modal-title').textContent = 'Modifier l\'√©tablissement';
            document.getElementById('form-submit-text').textContent = 'Modifier';
            
            // ‚úÖ CORRECTION : Mapping pour le formulaire
            const categoryToFormType = {
                'hotels': 'hotel',
                'restaurants': 'restaurant',
                'spas': 'spa',
                'hotel': 'hotel',
                'restaurant': 'restaurant', 
                'spa': 'spa'
            };
            
            // Remplir le formulaire
            document.getElementById('form-name').value = establishment.name || '';
            document.getElementById('form-type').value = categoryToFormType[establishment.category] || 'hotel';
            document.getElementById('form-address').value = establishment.address || '';
            document.getElementById('form-region').value = establishment.region || 'ile-de-france';
            document.getElementById('form-larevue-rating').value = establishment.laRevueRating || '';
            document.getElementById('form-user-rating').value = establishment.usersRating || '';
            document.getElementById('form-price-level').value = establishment.priceLevel || 3;
            document.getElementById('form-description').value = establishment.description || '';
            document.getElementById('form-is-featured').checked = establishment.isFeatured || false;
            document.getElementById('form-reservation-url').value = establishment.reservationUrl || '';
            document.getElementById('form-positive-reviews').value = establishment.positiveReviews || '';
            document.getElementById('form-negative-reviews').value = establishment.negativeReviews || '';
            document.getElementById('form-positive-example').value = establishment.positiveReviewExample || '';
            document.getElementById('form-negative-example').value = establishment.negativeReviewExample || '';
            document.getElementById('form-promo-code').value = establishment.promoCode || '';
            document.getElementById('form-promo-discount').value = establishment.promoDiscount || '';
            
            // ‚úÖ NOUVEAU : Mettre √† jour les labels apr√®s remplissage
            updateFeaturedLabels();
            
            document.getElementById('edit-modal').classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('edit-modal').classList.add('hidden');
            editingId = null;
            selectedImages = [];
        }

        // ‚úÖ GESTION FORMULAIRE √âTABLISSEMENT AVEC CALCUL AUTO NOTE G√âN√âRALE
        document.getElementById('establishment-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const submitBtn = document.querySelector('#establishment-form button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Enregistrement...';
            submitBtn.disabled = true;
            
            try {
                // Upload des images si pr√©sentes
                let imageUrls = [];
                if (selectedImages.length > 0) {
                    console.log('üì∏ Upload des images...');
                    imageUrls = await window.uploadImages(selectedImages);
                }
                
                const laRevueRating = parseFloat(document.getElementById('form-larevue-rating').value) || 7;
                const usersRating = parseFloat(document.getElementById('form-user-rating').value) || 7;
                
                const formData = {
                    name: document.getElementById('form-name').value,
                    category: document.getElementById('form-type').value,
                    address: document.getElementById('form-address').value,
                    region: document.getElementById('form-region').value,
                    laRevueRating: laRevueRating,
                    rating: laRevueRating, // Pour compatibilit√©
                    usersRating: usersRating,
                    userRating: usersRating, // Pour compatibilit√©
                    overallRating: window.calculateOverallRating(laRevueRating, usersRating), // ‚úÖ CALCUL AUTO
                    priceLevel: parseInt(document.getElementById('form-price-level').value) || 3,
                    description: document.getElementById('form-description').value,
                    isFeatured: document.getElementById('form-is-featured').checked,
                    reservationUrl: document.getElementById('form-reservation-url').value,
                    positiveReviews: document.getElementById('form-positive-reviews').value,
                    negativeReviews: document.getElementById('form-negative-reviews').value,
                    positiveReviewExample: document.getElementById('form-positive-example').value,
                    negativeReviewExample: document.getElementById('form-negative-example').value,
                    promoCode: document.getElementById('form-promo-code').value,
                    promoDiscount: document.getElementById('form-promo-discount').value,
                    images: imageUrls
                };
                
                console.log('üìù Donn√©es √©tablissement √† sauvegarder:', formData);
                
                if (editingId) {
                    // MISE √Ä JOUR
                    const docRef = window.firebaseModules.doc(window.firebaseApp.db, window.firebaseApp.COLLECTIONS.ESTABLISHMENTS, editingId);
                    await window.firebaseModules.updateDoc(docRef, formData);
                    showSuccess(`√âtablissement ${formData.isFeatured ? '‚≠ê marqu√© comme favori' : 'modifi√©'} avec succ√®s !`);
                } else {
                    // CR√âATION
                    const result = await window.addNewEstablishment(formData);
                    if (result) {
                        showSuccess(`√âtablissement ${formData.isFeatured ? '‚≠ê cr√©√© et marqu√© comme favori' : 'cr√©√©'} avec succ√®s !`);
                    } else {
                        showError('Erreur lors de la cr√©ation');
                        return;
                    }
                }
                
                closeModal();
                loadDashboard();
                
            } catch (error) {
                console.error('‚ùå Erreur formulaire:', error);
                showError('Erreur lors de la sauvegarde: ' + error.message);
            } finally {
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        });

        // ‚úÖ FONCTION EDIT RATING AVEC RECALCUL AUTO NOTE G√âN√âRALE
        async function editRating(id, type) {
            const establishment = window.currentEstablishments.find(e => e.id === id);
            if (!establishment) return;
            
            let currentValue, fieldName, displayName;
            
            switch(type) {
                case 'overallRating':
                    currentValue = window.calculateOverallRating(establishment.laRevueRating, establishment.usersRating);
                    fieldName = 'overallRating';
                    displayName = 'g√©n√©rale';
                    break;
                case 'laRevueRating':
                    currentValue = establishment.laRevueRating || 0;
                    fieldName = 'laRevueRating';
                    displayName = 'La Revue';
                    break;
                case 'usersRating':
                    currentValue = establishment.usersRating || 0;
                    fieldName = 'usersRating';
                    displayName = 'utilisateurs';
                    break;
                default:
                    return;
            }
            
            const newValue = prompt(`Nouvelle note ${displayName} (/10):`, currentValue);
            
            if (newValue === null || newValue === '') return;
            
            const rating = parseFloat(newValue);
            if (isNaN(rating) || rating < 0 || rating > 10) {
                showError('La note doit √™tre entre 0 et 10');
                return;
            }
            
            const success = await window.updateEstablishmentRating(id, rating, fieldName);
            if (success) {
                showSuccess(`Note ${displayName} mise √† jour !`);
                
                // ‚úÖ Recharger pour voir le nouveau calcul
                loadDashboard();
            } else {
                showError('Erreur lors de la mise √† jour');
            }
        }

        async function deleteEstablishmentItem(id) {
            const establishment = window.currentEstablishments.find(e => e.id === id);
            if (!establishment) return;
            
            if (!confirm(`√ätes-vous s√ªr de vouloir supprimer "${establishment.name}" ?`)) return;
            
            const success = await window.deleteEstablishment(id);
            if (success) {
                showSuccess('√âtablissement supprim√© !');
                loadDashboard();
            } else {
                showError('Erreur lors de la suppression');
            }
        }

        function filterEstablishments() {
            const query = document.getElementById('search-input').value.toLowerCase();
            
            if (currentTab === 'news') {
                const items = document.querySelectorAll('.news-item');
                items.forEach(item => {
                    const text = item.textContent.toLowerCase();
                    const visible = text.includes(query);
                    item.style.display = visible ? 'block' : 'none';
                });
            } else if (currentTab === 'reviews') {
                const items = document.querySelectorAll('.review-item');
                items.forEach(item => {
                    const text = item.textContent.toLowerCase();
                    const visible = text.includes(query);
                    item.style.display = visible ? 'block' : 'none';
                });
            } else {
                const items = document.querySelectorAll('.ranking-item');
                items.forEach(item => {
                    const text = item.textContent.toLowerCase();
                    const visible = text.includes(query);
                    item.style.display = visible ? 'block' : 'none';
                });
            }
        }

        function recalculateRankings() {
            if (!confirm('Recalculer automatiquement tous les classements ?')) return;
            
            showLoading(true);
            
            setTimeout(() => {
                showSuccess('Classements recalcul√©s !');
                loadDashboard();
            }, 2000);
        }

        function exportData() {
            if (currentTab === 'news') {
                exportNewsData();
                return;
            }
            
            if (currentTab === 'reviews') {
                exportReviewsData();
                return;
            }
            
            const data = {
                type: currentTab,
                establishments: window.currentEstablishments,
                exportDate: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `larevue-${currentTab}-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            showSuccess('Donn√©es export√©es !');
        }

        // ‚úÖ EVENT LISTENERS
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeModal();
                closeNewsModal();
                closeImportModal();
            }
        });

        // ‚úÖ GESTION AUTOMATIQUE DU FEATURED POUR √âTABLISSEMENTS
        document.getElementById('form-is-featured').addEventListener('change', function(e) {
            if (e.target.checked) {
                const type = document.getElementById('form-type').value;
                const typeName = type === 'hotel' ? 'h√¥tel' : type === 'restaurant' ? 'restaurant' : type === 'spa' ? 'spa' : '√©tablissement';
                
                if (!confirm(`‚ö†Ô∏è Attention : Un seul ${typeName} peut √™tre "Notre ${type === 'hotel' ? 'H√¥tel' : type === 'restaurant' ? 'Restaurant' : type === 'spa' ? 'Spa' : '√âtablissement'} Favori du Moment" √† la fois.\n\nEn activant cette option, tous les autres ${type}s perdront ce statut.\n\nContinuer ?`)) {
                    e.target.checked = false;
                    return;
                }
            }
        });

        // ‚úÖ FONCTION RAFRA√éCHISSEMENT FORC√â
        window.forceRefresh = async () => {
            const refreshBtn = event.target;
            const originalContent = refreshBtn.innerHTML;
            
            // Animation bouton
            refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Actualisation...';
            refreshBtn.disabled = true;
            
            try {
                // Vider le cache
                window.currentEstablishments = [];
                window.currentNews = [];
                window.currentReviews = [];
                
                // Recharger selon l'onglet
                if (currentTab === 'news') {
                    await loadNewsTab();
                } else if (currentTab === 'reviews') {
                    await loadReviewsTab();
                } else {
                    await loadDashboard();
                }
                
                showSuccess('‚úÖ Donn√©es actualis√©es !');
                
            } catch (error) {
                console.error('Erreur rafra√Æchissement:', error);
                showError('Erreur lors de l\'actualisation');
            } finally {
                // Restaurer le bouton
                setTimeout(() => {
                    refreshBtn.innerHTML = originalContent;
                    refreshBtn.disabled = false;
                }, 1000);
            }
        };

        // ‚úÖ INITIALISATION
        console.log('üéâ Dashboard La Revue avec calcul automatique des notes g√©n√©rales !');
        console.log('‚úÖ Nouvelles fonctionnalit√©s :');
        console.log('üßÆ Calcul automatique : Note G√©n√©rale = Moyenne(La Revue + Clients)');
        console.log('üìä Tri par notes corrig√© avec vraies moyennes');
        console.log('üîÑ Bouton recalcul global pour corriger les anciennes donn√©es');
        console.log('üì¶ Import JSON avec calcul automatique des notes');
        console.log('üì∞ Gestion compl√®te des actualit√©s');
        console.log('üí¨ Mod√©ration compl√®te des avis');

    </script>

</body>
</html>
