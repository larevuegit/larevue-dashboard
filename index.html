<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Admin - La Revue</title>
    
    <!-- Tailwind CSS -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js';
        import { getFirestore, collection, getDocs, doc, updateDoc, addDoc, deleteDoc, query, orderBy, where } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js';
        import { getStorage, ref, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-storage.js';

        // Configuration Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBjHNzW6i_d7HCZx_2K9Pv5JXIvafo1XNo",
            authDomain: "larevueapp-1f205.firebaseapp.com",
            projectId: "larevueapp-1f205",
            storageBucket: "larevueapp-1f205.firebasestorage.app",
            messagingSenderId: "248256257582",
            appId: "1:248256257582:web:a7b9281d0143e7ed35c9bf"
        };

        // Initialiser Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // Collections
        const COLLECTIONS = {
            ESTABLISHMENTS: 'establishments',
            USERS: 'users',
            REVIEWS: 'reviews',
            DEALS: 'deals'
        };

        // Variables globales
        window.firebaseApp = { db, storage, COLLECTIONS };
        window.firebaseModules = { updateDoc, doc, addDoc, deleteDoc, ref, uploadBytes, getDownloadURL, getDocs, collection, query, where };
        window.currentEstablishments = [];
        window.currentStats = { hotels: 0, restaurants: 0, spas: 0, totalReviews: 0 };

        // ✅ FONCTION UPLOAD IMAGES
        window.uploadImages = async (files) => {
            const urls = [];
            const uploadPromises = [];
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const timestamp = Date.now();
                const fileName = `${timestamp}_${i}_${file.name}`;
                const storageRef = ref(storage, `establishments/${fileName}`);
                
                uploadPromises.push(
                    uploadBytes(storageRef, file).then(async (snapshot) => {
                        const url = await getDownloadURL(snapshot.ref);
                        return url;
                    })
                );
            }
            
            try {
                const uploadedUrls = await Promise.all(uploadPromises);
                console.log('✅ Images uploadées:', uploadedUrls);
                return uploadedUrls;
            } catch (error) {
                console.error('❌ Erreur upload:', error);
                return [];
            }
        };

        // Fonctions Firebase existantes
        window.loadEstablishments = async (type = 'hotels') => {
            try {
                console.log(`🔥 Chargement des ${type}...`);
                const establishmentsRef = collection(db, COLLECTIONS.ESTABLISHMENTS);
                const snapshot = await getDocs(establishmentsRef);
                
                const establishments = [];
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    console.log('🔍 Document trouvé:', data);
                    
                    if (data.category === type) {
                        establishments.push({
                            id: doc.id,
                            name: data.name || 'Sans nom',
                            address: data.address || 'Sans adresse',
                            laRevueRating: data.rating || 7,
                            userRating: data.userRating || 7,
                            rank: data.topPosition || 1,
                            priceLevel: data.priceLevel || 3,
                            description: data.description || '',
                            category: data.category || type,
                            // ✅ RÉGION AJOUTÉE
                            region: data.region || 'ile-de-france',
                            // ✅ CODES PROMO
                            promoCode: data.promoCode || '',
                            promoDiscount: data.promoDiscount || '',
                            images: data.images || [],
                            // ✅ CHAMPS FEATURED
                            isFeatured: data.isFeatured || false,
                            reservationUrl: data.reservationUrl || '',
                            positiveReviews: data.positiveReviews || '89%',
                            negativeReviews: data.negativeReviews || '11%',
                            positiveReviewExample: data.positiveReviewExample || '',
                            negativeReviewExample: data.negativeReviewExample || ''
                        });
                    }
                });
                
                establishments.sort((a, b) => (a.rank || 999) - (b.rank || 999));
                window.currentEstablishments = establishments;
                console.log(`✅ ${establishments.length} établissements ${type} chargés`);
                return establishments;
            } catch (error) {
                console.error('❌ Erreur chargement:', error);
                return [];
            }
        };

        // Autres fonctions Firebase
        window.updateEstablishmentRank = async (id, newRank) => {
            try {
                const docRef = doc(db, COLLECTIONS.ESTABLISHMENTS, id);
                await updateDoc(docRef, { topPosition: newRank });
                console.log(`✅ Rang mis à jour pour ${id}`);
                return true;
            } catch (error) {
                console.error('❌ Erreur mise à jour rang:', error);
                return false;
            }
        };

        window.updateEstablishmentRating = async (id, rating, type = 'rating') => {
            try {
                const docRef = doc(db, COLLECTIONS.ESTABLISHMENTS, id);
                await updateDoc(docRef, { [type]: rating });
                console.log(`✅ Note ${type} mise à jour pour ${id}`);
                return true;
            } catch (error) {
                console.error('❌ Erreur mise à jour note:', error);
                return false;
            }
        };

        window.addNewEstablishment = async (data) => {
            try {
                console.log('🔥 Création nouvel établissement:', data);
                const docRef = await addDoc(collection(db, COLLECTIONS.ESTABLISHMENTS), {
                    ...data,
                    createdAt: new Date(),
                    topPosition: window.currentEstablishments.length + 1,
                    isActive: true
                });
                console.log(`✅ Nouvel établissement créé: ${docRef.id}`);
                return docRef.id;
            } catch (error) {
                console.error('❌ Erreur création:', error);
                return null;
            }
        };

        window.deleteEstablishment = async (id) => {
            try {
                await deleteDoc(doc(db, COLLECTIONS.ESTABLISHMENTS, id));
                console.log(`✅ Établissement supprimé: ${id}`);
                return true;
            } catch (error) {
                console.error('❌ Erreur suppression:', error);
                return false;
            }
        };

        // Initialisation
        document.addEventListener('DOMContentLoaded', () => {
            console.log('🔥 Firebase Dashboard initialized');
            loadDashboard();
        });
    </script>

    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
        }
        
        .card-hover {
            transition: all 0.3s ease;
        }
        
        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }

        .ranking-item {
            transition: all 0.3s ease;
        }

        .ranking-item:hover {
            background: linear-gradient(135deg, #374151 0%, #4B5563 100%);
        }

        .modal {
            backdrop-filter: blur(10px);
        }

        .spinner {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ✅ STYLES POUR IMAGES */
        .image-preview {
            position: relative;
            overflow: hidden;
            border-radius: 8px;
        }
        
        .image-preview img {
            width: 100%;
            height: 80px;
            object-fit: cover;
        }
        
        .image-preview .remove-btn {
            position: absolute;
            top: 4px;
            right: 4px;
            background: rgba(239, 68, 68, 0.9);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* ✅ STYLES FEATURED */
        .featured-badge {
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            border: 2px solid #fbbf24;
            box-shadow: 0 4px 12px rgba(251, 191, 36, 0.4);
        }

        .featured-item {
            border: 2px solid #fbbf24;
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.1), rgba(245, 158, 11, 0.05));
        }

        /* ✅ STYLES POUR LAYOUT FEATURED CORRIGÉ */
        .featured-scores-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1.5rem;
            margin-top: 1rem;
        }

        .score-item {
            text-align: center;
            padding: 0.75rem;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            border: 1px solid rgba(251, 191, 36, 0.3);
        }

        .score-label {
            font-size: 0.75rem;
            color: #9CA3AF;
            margin-bottom: 0.25rem;
        }

        .score-value {
            font-size: 1.25rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .score-edit-btn {
            font-size: 0.75rem;
            color: #6B7280;
            cursor: pointer;
            padding: 0.25rem;
            border-radius: 4px;
            transition: color 0.2s;
        }

        .score-edit-btn:hover {
            color: #FBBF24;
        }
    </style>
</head>

<body class="bg-gray-900 text-white min-h-screen">

    <!-- Header et Navigation identiques -->
    <header class="gradient-bg shadow-2xl border-b border-gray-700">
        <div class="max-w-7xl mx-auto px-6 py-8">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <div class="bg-yellow-500 p-3 rounded-xl">
                        <i class="fas fa-trophy text-black text-2xl"></i>
                    </div>
                    <div>
                        <h1 class="text-4xl font-bold text-yellow-400">Dashboard Admin - La Revue</h1>
                        <p class="text-gray-300 text-lg mt-1">Gestion du classement et des établissements</p>
                    </div>
                </div>
                
                <div class="flex items-center space-x-4">
                    <div class="bg-green-500 w-3 h-3 rounded-full animate-pulse"></div>
                    <span class="text-green-400 font-medium">En ligne</span>
                </div>
            </div>
        </div>
    </header>

    <nav class="bg-gray-800 border-b border-gray-700">
        <div class="max-w-7xl mx-auto px-6 py-4">
            <div class="flex space-x-8">
                <button onclick="switchTab('hotels')" id="tab-hotels" class="nav-tab px-6 py-3 rounded-lg font-medium transition-all duration-300 bg-blue-600 text-white">
                    <i class="fas fa-bed mr-2"></i>Hôtels
                </button>
                <button onclick="switchTab('restaurants')" id="tab-restaurants" class="nav-tab px-6 py-3 rounded-lg font-medium transition-all duration-300 bg-gray-700 text-gray-300 hover:bg-gray-600">
                    <i class="fas fa-utensils mr-2"></i>Restaurants
                </button>
                <button onclick="switchTab('spas')" id="tab-spas" class="nav-tab px-6 py-3 rounded-lg font-medium transition-all duration-300 bg-gray-700 text-gray-300 hover:bg-gray-600">
                    <i class="fas fa-spa mr-2"></i>Spas
                </button>
            </div>
        </div>
    </nav>

    <!-- Contenu Principal -->
    <main class="max-w-7xl mx-auto px-6 py-8">
        
        <!-- Statistiques (identiques) -->
        <section class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-12">
            <div class="bg-gray-800 p-6 rounded-xl border border-gray-700 card-hover">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-lg font-semibold text-yellow-400">Total</h3>
                        <p class="text-3xl font-bold" id="stat-total">0</p>
                    </div>
                    <div class="bg-yellow-500 p-3 rounded-lg">
                        <i class="fas fa-building text-black text-xl"></i>
                    </div>
                </div>
            </div>

            <div class="bg-gray-800 p-6 rounded-xl border border-gray-700 card-hover">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-lg font-semibold text-blue-400">Note Moyenne</h3>
                        <p class="text-3xl font-bold" id="stat-average">0.0</p>
                    </div>
                    <div class="bg-blue-500 p-3 rounded-lg">
                        <i class="fas fa-star text-white text-xl"></i>
                    </div>
                </div>
            </div>

            <div class="bg-gray-800 p-6 rounded-xl border border-gray-700 card-hover">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-lg font-semibold text-green-400">Top 3</h3>
                        <p class="text-3xl font-bold">🏆🥈🥉</p>
                    </div>
                    <div class="bg-green-500 p-3 rounded-lg">
                        <i class="fas fa-medal text-white text-xl"></i>
                    </div>
                </div>
            </div>

            <div class="bg-gray-800 p-6 rounded-xl border border-gray-700 card-hover">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-lg font-semibold text-purple-400">Firebase</h3>
                        <p class="text-2xl font-bold text-green-400">🟢 Connecté</p>
                    </div>
                    <div class="bg-purple-500 p-3 rounded-lg">
                        <i class="fas fa-database text-white text-xl"></i>
                    </div>
                </div>
            </div>
        </section>

        <!-- Actions rapides -->
        <section class="mb-8">
            <div class="flex flex-wrap gap-4">
                <button onclick="openAddModal()" class="bg-green-600 hover:bg-green-700 px-6 py-3 rounded-lg font-medium transition-colors">
                    <i class="fas fa-plus mr-2"></i>Ajouter un établissement
                </button>
                <button onclick="recalculateRankings()" class="bg-blue-600 hover:bg-blue-700 px-6 py-3 rounded-lg font-medium transition-colors">
                    <i class="fas fa-calculator mr-2"></i>Recalculer le classement
                </button>
                <button onclick="exportData()" class="bg-purple-600 hover:bg-purple-700 px-6 py-3 rounded-lg font-medium transition-colors">
                    <i class="fas fa-download mr-2"></i>Exporter les données
                </button>
            </div>
        </section>

        <!-- Liste des établissements -->
        <section class="bg-gray-800 rounded-xl border border-gray-700">
            <div class="p-6 border-b border-gray-700">
                <div class="flex items-center justify-between">
                    <h2 class="text-2xl font-bold" id="section-title">🏨 Classement des Hôtels</h2>
                    <div class="flex items-center space-x-4">
                        <input type="text" id="search-input" placeholder="Rechercher..." class="bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white" onkeyup="filterEstablishments()">
                        <button onclick="loadDashboard()" class="bg-gray-600 hover:bg-gray-500 p-2 rounded-lg">
                            <i class="fas fa-refresh"></i>
                        </button>
                    </div>
                </div>
                <p class="text-gray-400 mt-2">Glissez-déposez pour modifier le classement • Cliquez pour modifier</p>
            </div>
            
            <!-- Loading -->
            <div id="loading" class="p-12 text-center">
                <div class="spinner w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full mx-auto mb-4"></div>
                <p class="text-gray-400">Chargement des données Firebase...</p>
            </div>

            <!-- Liste -->
            <div id="establishments-list" class="hidden">
                <!-- Les établissements seront injectés ici par JavaScript -->
            </div>
        </section>
    </main>

    <!-- ✅ MODAL AVEC RÉGION AJOUTÉE -->
    <div id="edit-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 modal z-50 flex items-center justify-center p-4">
        <div class="bg-gray-800 rounded-xl border border-gray-700 max-w-4xl w-full max-h-screen overflow-y-auto">
            <div class="p-6 border-b border-gray-700">
                <div class="flex items-center justify-between">
                    <h3 class="text-xl font-bold" id="modal-title">Ajouter un établissement</h3>
                    <button onclick="closeModal()" class="text-gray-400 hover:text-white">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>
            
            <form id="establishment-form" class="p-6 space-y-6">
                <!-- Informations de base -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Nom *</label>
                        <input type="text" id="form-name" required class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Type *</label>
                        <select id="form-type" required class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white">
                            <option value="hotels">Hôtel</option>
                            <option value="restaurants">Restaurant</option>
                            <option value="spas">Spa</option>
                        </select>
                    </div>
                </div>

                <!-- ✅ ADRESSE ET RÉGION -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Adresse *</label>
                        <input type="text" id="form-address" required class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Région *</label>
                        <select id="form-region" required class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white">
                            <option value="ile-de-france">Île-de-France</option>
                            <option value="provence-alpes-cote-azur">Provence-Alpes-Côte d'Azur</option>
                            <option value="nouvelle-aquitaine">Nouvelle-Aquitaine</option>
                            <option value="occitanie">Occitanie</option>
                            <option value="auvergne-rhone-alpes">Auvergne-Rhône-Alpes</option>
                            <option value="normandie">Normandie</option>
                            <option value="bretagne">Bretagne</option>
                            <option value="pays-de-la-loire">Pays de la Loire</option>
                            <option value="centre-val-de-loire">Centre-Val de Loire</option>
                            <option value="bourgogne-franche-comte">Bourgogne-Franche-Comté</option>
                            <option value="grand-est">Grand Est</option>
                            <option value="hauts-de-france">Hauts-de-France</option>
                            <option value="corse">Corse</option>
                        </select>
                    </div>
                </div>

                <!-- Notes et prix -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Note La Revue (/10)</label>
                        <input type="number" id="form-larevue-rating" min="1" max="10" step="0.1" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Note Utilisateurs (/10)</label>
                        <input type="number" id="form-user-rating" min="1" max="10" step="0.1" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Niveau de prix</label>
                        <select id="form-price-level" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white">
                            <option value="1">€ (Économique)</option>
                            <option value="2">€€ (Modéré)</option>
                            <option value="3">€€€ (Cher)</option>
                            <option value="4">€€€€ (Très cher)</option>
                        </select>
                    </div>
                </div>

                <!-- ✅ SECTION FEATURED -->
                <div class="bg-yellow-500 bg-opacity-20 p-4 rounded-lg border-l-4 border-yellow-500">
                    <h4 class="text-lg font-semibold text-yellow-400 mb-4">
                        <i class="fas fa-star mr-2"></i>Notre Hôtel Favori du Moment
                    </h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">
                                <input type="checkbox" id="form-is-featured" class="mr-2">
                                Marquer comme "Notre Hôtel Favori du Moment"
                            </label>
                            <p class="text-xs text-gray-400">Cet établissement apparaîtra en premier dans l'app</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Lien de réservation</label>
                            <input type="url" id="form-reservation-url" class="w-full bg-gray-600 border border-gray-500 rounded-lg px-4 py-2 text-white" placeholder="https://...">
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Avis positifs (%)</label>
                            <input type="text" id="form-positive-reviews" class="w-full bg-gray-600 border border-gray-500 rounded-lg px-4 py-2 text-white" placeholder="89%">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Avis négatifs (%)</label>
                            <input type="text" id="form-negative-reviews" class="w-full bg-gray-600 border border-gray-500 rounded-lg px-4 py-2 text-white" placeholder="11%">
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Exemple d'avis positif</label>
                            <input type="text" id="form-positive-example" class="w-full bg-gray-600 border border-gray-500 rounded-lg px-4 py-2 text-white" placeholder="Service exceptionnel et vue magnifique">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Exemple d'avis négatif</label>
                            <input type="text" id="form-negative-example" class="w-full bg-gray-600 border border-gray-500 rounded-lg px-4 py-2 text-white" placeholder="Prix un peu élevé">
                        </div>
                    </div>
                </div>

                <!-- ✅ CODES PROMO PREMIUM -->
                <div class="bg-gray-700 p-4 rounded-lg border-l-4 border-yellow-500">
                    <h4 class="text-lg font-semibold text-yellow-400 mb-4">
                        <i class="fas fa-gift mr-2"></i>Codes Promo Premium
                    </h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Code Promo</label>
                            <input type="text" id="form-promo-code" class="w-full bg-gray-600 border border-gray-500 rounded-lg px-4 py-2 text-white" placeholder="HOTEL20">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Réduction</label>
                            <input type="text" id="form-promo-discount" class="w-full bg-gray-600 border border-gray-500 rounded-lg px-4 py-2 text-white" placeholder="20%">
                        </div>
                    </div>
                </div>

                <!-- ✅ UPLOAD D'IMAGES -->
                <div class="bg-gray-700 p-4 rounded-lg border-l-4 border-blue-500">
                    <h4 class="text-lg font-semibold text-blue-400 mb-4">
                        <i class="fas fa-camera mr-2"></i>Photos de l'établissement
                    </h4>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Sélectionner des images (max 8)</label>
                        <input type="file" id="form-images" multiple accept="image/*" class="w-full bg-gray-600 border border-gray-500 rounded-lg px-4 py-2 text-white">
                        <p class="text-xs text-gray-400 mt-2">Formats acceptés: JPG, PNG, WebP • Taille max: 5MB par image</p>
                    </div>
                    
                    <!-- Prévisualisation des images -->
                    <div id="images-preview" class="grid grid-cols-4 gap-4 mt-4"></div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Description</label>
                    <textarea id="form-description" rows="3" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white"></textarea>
                </div>

                <div class="flex justify-end space-x-4">
                    <button type="button" onclick="closeModal()" class="px-6 py-2 border border-gray-600 rounded-lg text-gray-300 hover:bg-gray-700">
                        Annuler
                    </button>
                    <button type="submit" class="px-6 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg text-white font-medium">
                        <span id="form-submit-text">Ajouter</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Variables globales
        let currentTab = 'hotels';
        let editingId = null;
        let selectedImages = [];

        // ✅ GESTION PRÉVISUALISATION IMAGES
        document.getElementById('form-images').addEventListener('change', function(e) {
            const files = Array.from(e.target.files);
            selectedImages = files;
            
            const previewContainer = document.getElementById('images-preview');
            previewContainer.innerHTML = '';
            
            files.forEach((file, index) => {
                if (index >= 8) return; // Max 8 images
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    const previewDiv = document.createElement('div');
                    previewDiv.className = 'image-preview';
                    previewDiv.innerHTML = `
                        <img src="${e.target.result}" alt="Preview ${index + 1}">
                        <button type="button" class="remove-btn" onclick="removeImage(${index})">
                            <i class="fas fa-times"></i>
                        </button>
                    `;
                    previewContainer.appendChild(previewDiv);
                };
                reader.readAsDataURL(file);
            });
        });

        // ✅ SUPPRIMER UNE IMAGE
        function removeImage(index) {
            selectedImages.splice(index, 1);
            
            // Recréer le FileList (simulation)
            const dt = new DataTransfer();
            selectedImages.forEach(file => dt.items.add(file));
            document.getElementById('form-images').files = dt.files;
            
            // Re-trigger l'événement change
            document.getElementById('form-images').dispatchEvent(new Event('change'));
        }

        // Fonctions Dashboard existantes
        async function loadDashboard() {
            showLoading(true);
            
            try {
                const establishments = await window.loadEstablishments(currentTab);
                updateStats(establishments);
                renderEstablishments(establishments);
            } catch (error) {
                console.error('Erreur chargement dashboard:', error);
                showError('Erreur de connexion Firebase');
            } finally {
                showLoading(false);
            }
        }

        function switchTab(tab) {
            currentTab = tab;
            
            document.querySelectorAll('.nav-tab').forEach(btn => {
                btn.className = 'nav-tab px-6 py-3 rounded-lg font-medium transition-all duration-300 bg-gray-700 text-gray-300 hover:bg-gray-600';
            });
            document.getElementById(`tab-${tab}`).className = 'nav-tab px-6 py-3 rounded-lg font-medium transition-all duration-300 bg-blue-600 text-white';
            
            const titles = {
                hotels: '🏨 Classement des Hôtels',
                restaurants: '🍽️ Classement des Restaurants',
                spas: '🧘 Classement des Spas'
            };
            document.getElementById('section-title').textContent = titles[tab];
            
            loadDashboard();
        }

        function showLoading(show) {
            document.getElementById('loading').classList.toggle('hidden', !show);
            document.getElementById('establishments-list').classList.toggle('hidden', show);
        }

        function updateStats(establishments) {
            const total = establishments.length;
            const average = total > 0 ? 
                (establishments.reduce((sum, est) => sum + (est.laRevueRating || 0), 0) / total).toFixed(1) : 
                '0.0';
            
            document.getElementById('stat-total').textContent = total;
            document.getElementById('stat-average').textContent = average;
        }

        function calculateScore(est) {
            const userRating = est.userRating || 7;
            const laRevueRating = est.laRevueRating || 7;
            const bonus = est.manualBonus || 0;
            return ((userRating * 0.6) + (laRevueRating * 0.4) + bonus).toFixed(1);
        }

        // ✅ RENDU LISTE CORRIGÉ AVEC AFFICHAGE FEATURED
        function renderEstablishments(establishments) {
            const container = document.getElementById('establishments-list');
            
            if (establishments.length === 0) {
                container.innerHTML = `
                    <div class="p-12 text-center">
                        <div class="text-6xl mb-4">🏗️</div>
                        <h3 class="text-xl font-bold text-gray-300 mb-2">Aucun établissement trouvé</h3>
                        <p class="text-gray-400 mb-6">Commencez par ajouter votre premier établissement</p>
                        <button onclick="openAddModal()" class="bg-blue-600 hover:bg-blue-700 px-6 py-3 rounded-lg font-medium">
                            <i class="fas fa-plus mr-2"></i>Ajouter un établissement
                        </button>
                    </div>
                `;
                return;
            }

            container.innerHTML = establishments.map((est, index) => `
                <div class="ranking-item p-6 border-b border-gray-700 last:border-b-0 ${est.isFeatured ? 'featured-item' : ''}" id="item-${est.id}">
                    ${est.isFeatured ? `
                        <div class="featured-badge px-4 py-2 rounded-full text-sm font-bold text-black mb-4 inline-flex items-center">
                            <i class="fas fa-star mr-2"></i>Notre Hôtel Favori du Moment
                        </div>
                    ` : ''}
                    
                    <div class="flex items-start justify-between">
                        <!-- Rang et info -->
                        <div class="flex items-start space-x-6 flex-1">
                            <div class="rank-badge w-16 h-16 rounded-xl flex items-center justify-center font-bold text-xl ${
                                est.isFeatured ? 'bg-gradient-to-r from-yellow-400 to-yellow-600 text-black' :
                                est.rank <= 3 ? 'bg-gradient-to-r from-yellow-400 to-yellow-600 text-black' : 'bg-gray-600 text-white'
                            }">
                                ${est.isFeatured ? '<i class="fas fa-star"></i>' : `#${est.rank || index + 1}`}
                            </div>
                            
                            <div class="flex-1">
                                <h3 class="text-xl font-semibold text-white mb-1">${est.name || 'Sans nom'}</h3>
                                <p class="text-gray-400 text-sm mb-2">
                                    <i class="fas fa-map-marker-alt mr-1"></i>
                                    ${est.address || 'Adresse non définie'}
                                </p>
                                
                                <!-- ✅ RÉGION AJOUTÉE -->
                                <p class="text-gray-500 text-xs mb-2">
                                    <i class="fas fa-globe-europe mr-1"></i>
                                    ${est.region ? est.region.split('-').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ') : 'Région non définie'}
                                </p>
                                
                                ${est.description ? `<p class="text-gray-300 text-sm mb-3">${est.description}</p>` : ''}
                                
                                <!-- ✅ AFFICHAGE CODES PROMO -->
                                ${est.promoCode ? `
                                    <div class="bg-yellow-500 bg-opacity-20 border border-yellow-500 rounded-lg p-2 mb-3 inline-block">
                                        <span class="text-yellow-400 text-sm font-bold">
                                            <i class="fas fa-gift mr-1"></i>
                                            ${est.promoCode} • -${est.promoDiscount || '0%'}
                                        </span>
                                    </div>
                                ` : ''}

                                <!-- ✅ LIEN RÉSERVATION -->
                                ${est.reservationUrl ? `
                                    <div class="mb-3">
                                        <a href="${est.reservationUrl}" target="_blank" class="text-blue-400 hover:text-blue-300 text-sm">
                                            <i class="fas fa-external-link-alt mr-1"></i>
                                            Lien de réservation
                                        </a>
                                    </div>
                                ` : ''}

                                <!-- ✅ AVIS POSITIFS/NÉGATIFS -->
                                ${est.positiveReviews || est.negativeReviews ? `
                                    <div class="mb-3 flex items-center space-x-4">
                                        ${est.positiveReviews ? `
                                            <span class="text-green-400 text-sm">
                                                <i class="fas fa-thumbs-up mr-1"></i>
                                                ${est.positiveReviews}
                                            </span>
                                        ` : ''}
                                        ${est.negativeReviews ? `
                                            <span class="text-red-400 text-sm">
                                                <i class="fas fa-thumbs-down mr-1"></i>
                                                ${est.negativeReviews}
                                            </span>
                                        ` : ''}
                                    </div>
                                ` : ''}

                                <!-- ✅ EXEMPLES D'AVIS -->
                                ${est.positiveReviewExample ? `
                                    <div class="mb-2">
                                        <p class="text-green-300 text-xs italic">
                                            <i class="fas fa-quote-left mr-1"></i>
                                            "${est.positiveReviewExample}"
                                        </p>
                                    </div>
                                ` : ''}
                                ${est.negativeReviewExample ? `
                                    <div class="mb-2">
                                        <p class="text-red-300 text-xs italic">
                                            <i class="fas fa-quote-left mr-1"></i>
                                            "${est.negativeReviewExample}"
                                        </p>
                                    </div>
                                ` : ''}
                                
                                <!-- ✅ AFFICHAGE IMAGES -->
                                ${est.images && est.images.length > 0 ? `
                                    <div class="flex space-x-2 mb-3">
                                        ${est.images.slice(0, 4).map(img => `
                                            <img src="${img}" alt="Photo" class="w-16 h-12 object-cover rounded border border-gray-600">
                                        `).join('')}
                                        ${est.images.length > 4 ? `
                                            <div class="w-16 h-12 bg-gray-600 rounded border border-gray-500 flex items-center justify-center">
                                                <span class="text-xs text-gray-300">+${est.images.length - 4}</span>
                                            </div>
                                        ` : ''}
                                    </div>
                                ` : ''}
                                
                                <!-- ✅ SCORES FEATURED CORRIGÉS -->
                                ${est.isFeatured ? `
                                    <div class="featured-scores-grid">
                                        <div class="score-item">
                                            <div class="score-label">Utilisateurs</div>
                                            <div class="score-value text-blue-400">
                                                <span>${(est.userRating || 0).toFixed(1)}</span>
                                                <button onclick="editRating('${est.id}', 'userRating', ${est.userRating || 7})" class="score-edit-btn">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                            </div>
                                        </div>
                                        
                                        <div class="score-item">
                                            <div class="score-label">La Revue</div>
                                            <div class="score-value text-yellow-400">
                                                <span>${(est.laRevueRating || 0).toFixed(1)}</span>
                                                <button onclick="editRating('${est.id}', 'rating', ${est.laRevueRating || 7})" class="score-edit-btn">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                            </div>
                                        </div>
                                        
                                        <div class="score-item">
                                            <div class="score-label">Score Final</div>
                                            <div class="score-value text-green-400">
                                                <span>${calculateScore(est)}</span>
                                            </div>
                                        </div>
                                        
                                        <div class="score-item">
                                            <div class="score-label">Prix</div>
                                            <div class="score-value text-purple-400">
                                                <span>${'€'.repeat(est.priceLevel || 2)}</span>
                                            </div>
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                        </div>

                        <!-- Actions et scores (pour les non-featured) -->
                        <div class="flex items-center space-x-6">
                            ${!est.isFeatured ? `
                                <!-- Scores normaux -->
                                <div class="grid grid-cols-3 gap-4 text-center">
                                    <div>
                                        <p class="text-xs text-gray-400 mb-1">Utilisateurs</p>
                                        <div class="flex items-center space-x-2">
                                            <span class="font-bold text-blue-400 text-lg">${(est.userRating || 0).toFixed(1)}</span>
                                            <button onclick="editRating('${est.id}', 'userRating', ${est.userRating || 7})" class="text-xs text-gray-500 hover:text-blue-400">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <p class="text-xs text-gray-400 mb-1">La Revue</p>
                                        <div class="flex items-center space-x-2">
                                            <span class="font-bold text-yellow-400 text-lg">${(est.laRevueRating || 0).toFixed(1)}</span>
                                            <button onclick="editRating('${est.id}', 'rating', ${est.laRevueRating || 7})" class="text-xs text-gray-500 hover:text-yellow-400">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <p class="text-xs text-gray-400 mb-1">Score Final</p>
                                        <span class="font-bold text-green-400 text-lg">${calculateScore(est)}</span>
                                    </div>
                                </div>

                                <!-- Prix -->
                                <div class="text-center">
                                    <p class="text-xs text-gray-400 mb-1">Prix</p>
                                    <span class="font-bold text-purple-400 text-lg">${'€'.repeat(est.priceLevel || 2)}</span>
                                </div>
                            ` : ''}

                            <!-- Actions -->
                            <div class="flex space-x-2">
                                ${!est.isFeatured ? `
                                    <button onclick="moveUp('${est.id}', ${est.rank || index + 1})" 
                                        ${(est.rank || index + 1) === 1 ? 'disabled' : ''} 
                                        class="px-3 py-2 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-600 disabled:cursor-not-allowed rounded-lg text-sm font-medium transition-colors">
                                        <i class="fas fa-arrow-up"></i>
                                    </button>
                                    <button onclick="moveDown('${est.id}', ${est.rank || index + 1})" 
                                        ${(est.rank || index + 1) === establishments.length ? 'disabled' : ''} 
                                        class="px-3 py-2 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-600 disabled:cursor-not-allowed rounded-lg text-sm font-medium transition-colors">
                                        <i class="fas fa-arrow-down"></i>
                                    </button>
                                ` : ''}
                                <button onclick="editEstablishment('${est.id}')" class="px-3 py-2 bg-yellow-600 hover:bg-yellow-700 rounded-lg text-sm font-medium transition-colors">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="deleteEstablishment('${est.id}')" class="px-3 py-2 bg-red-600 hover:bg-red-700 rounded-lg text-sm font-medium transition-colors">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Autres fonctions (moveUp, moveDown, editRating, etc.)
        async function moveUp(id, currentRank) {
            if (currentRank <= 1) return;
            
            const success = await window.updateEstablishmentRank(id, currentRank - 1);
            if (success) {
                showSuccess('Classement mis à jour !');
                loadDashboard();
            } else {
                showError('Erreur lors de la mise à jour');
            }
        }

        async function moveDown(id, currentRank) {
            const maxRank = window.currentEstablishments.length;
            if (currentRank >= maxRank) return;
            
            const success = await window.updateEstablishmentRank(id, currentRank + 1);
            if (success) {
                showSuccess('Classement mis à jour !');
                loadDashboard();
            } else {
                showError('Erreur lors de la mise à jour');
            }
        }

        async function editRating(id, type, currentValue) {
            const newValue = prompt(`Nouvelle note ${type === 'userRating' ? 'utilisateurs' : 'La Revue'} (/10):`, currentValue);
            
            if (newValue === null || newValue === '') return;
            
            const rating = parseFloat(newValue);
            if (isNaN(rating) || rating < 0 || rating > 10) {
                showError('La note doit être entre 0 et 10');
                return;
            }
            
            const success = await window.updateEstablishmentRating(id, rating, type);
            if (success) {
                showSuccess('Note mise à jour !');
                loadDashboard();
            } else {
                showError('Erreur lors de la mise à jour');
            }
        }

        function openAddModal() {
            editingId = null;
            selectedImages = [];
            document.getElementById('modal-title').textContent = 'Ajouter un établissement';
            document.getElementById('form-submit-text').textContent = 'Ajouter';
            document.getElementById('form-type').value = currentTab;
            document.getElementById('establishment-form').reset();
            document.getElementById('images-preview').innerHTML = '';
            // ✅ Reset champs featured
            document.getElementById('form-is-featured').checked = false;
            document.getElementById('form-reservation-url').value = '';
            document.getElementById('form-positive-reviews').value = '';
            document.getElementById('form-negative-reviews').value = '';
            document.getElementById('form-positive-example').value = '';
            document.getElementById('form-negative-example').value = '';
            // ✅ Reset région
            document.getElementById('form-region').value = 'ile-de-france';
            document.getElementById('edit-modal').classList.remove('hidden');
        }

        function editEstablishment(id) {
            const est = window.currentEstablishments.find(e => e.id === id);
            if (!est) return;
            
            editingId = id;
            selectedImages = [];
            document.getElementById('modal-title').textContent = 'Modifier l\'établissement';
            document.getElementById('form-submit-text').textContent = 'Modifier';
            
            // Remplir le formulaire
            document.getElementById('form-name').value = est.name || '';
            document.getElementById('form-type').value = est.category || currentTab;
            document.getElementById('form-address').value = est.address || '';
            document.getElementById('form-region').value = est.region || 'ile-de-france';
            document.getElementById('form-larevue-rating').value = est.laRevueRating || 7;
            document.getElementById('form-user-rating').value = est.userRating || 7;
            document.getElementById('form-price-level').value = est.priceLevel || 2;
            document.getElementById('form-description').value = est.description || '';
            
            // ✅ REMPLIR CODES PROMO
            document.getElementById('form-promo-code').value = est.promoCode || '';
            document.getElementById('form-promo-discount').value = est.promoDiscount || '';
            
            // ✅ REMPLIR CHAMPS FEATURED
            document.getElementById('form-is-featured').checked = est.isFeatured || false;
            document.getElementById('form-reservation-url').value = est.reservationUrl || '';
            document.getElementById('form-positive-reviews').value = est.positiveReviews || '';
            document.getElementById('form-negative-reviews').value = est.negativeReviews || '';
            document.getElementById('form-positive-example').value = est.positiveReviewExample || '';
            document.getElementById('form-negative-example').value = est.negativeReviewExample || '';
            
            // ✅ AFFICHER IMAGES EXISTANTES
            const previewContainer = document.getElementById('images-preview');
            previewContainer.innerHTML = '';
            if (est.images && est.images.length > 0) {
                est.images.forEach((imageUrl, index) => {
                    const previewDiv = document.createElement('div');
                    previewDiv.className = 'image-preview';
                    previewDiv.innerHTML = `
                        <img src="${imageUrl}" alt="Image existante ${index + 1}">
                        <button type="button" class="remove-btn" onclick="removeExistingImage('${est.id}', ${index})">
                            <i class="fas fa-times"></i>
                        </button>
                    `;
                    previewContainer.appendChild(previewDiv);
                });
            }
            
            document.getElementById('edit-modal').classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('edit-modal').classList.add('hidden');
            editingId = null;
            selectedImages = [];
        }

        // ✅ GESTION FORMULAIRE AVEC RÉGION
        document.getElementById('establishment-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const submitBtn = document.querySelector('#establishment-form button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Enregistrement...';
            submitBtn.disabled = true;
            
            try {
                // ✅ GESTION AUTOMATIQUE DU FEATURED
                const isFeatured = document.getElementById('form-is-featured').checked;
                
                // Si cet établissement devient featured, désactiver tous les autres
                if (isFeatured) {
                    console.log('🌟 Désactivation des autres établissements featured...');
                    
                    // Récupérer tous les établissements
                    const allEstablishments = await window.firebaseModules.getDocs(window.firebaseModules.collection(window.firebaseApp.db, window.firebaseApp.COLLECTIONS.ESTABLISHMENTS));
                    
                    // Désactiver tous les autres featured
                    const updatePromises = [];
                    allEstablishments.forEach((doc) => {
                        const data = doc.data();
                        if (data.isFeatured === true && doc.id !== editingId) {
                            console.log(`⚠️ Désactivation featured pour: ${data.name}`);
                            const docRef = window.firebaseModules.doc(window.firebaseApp.db, window.firebaseApp.COLLECTIONS.ESTABLISHMENTS, doc.id);
                            updatePromises.push(window.firebaseModules.updateDoc(docRef, { isFeatured: false }));
                        }
                    });
                    
                    // Attendre que tous soient désactivés
                    await Promise.all(updatePromises);
                    console.log('✅ Autres établissements désactivés');
                }
                
                // ✅ UPLOAD DES IMAGES
                let uploadedImageUrls = [];
                if (selectedImages.length > 0) {
                    console.log('📤 Upload de', selectedImages.length, 'images...');
                    uploadedImageUrls = await window.uploadImages(selectedImages);
                }
                
                // Récupérer images existantes si modification
                let existingImages = [];
                if (editingId) {
                    const existingEst = window.currentEstablishments.find(e => e.id === editingId);
                    existingImages = existingEst?.images || [];
                }
                
                const formData = {
                    name: document.getElementById('form-name').value,
                    category: document.getElementById('form-type').value,
                    address: document.getElementById('form-address').value,
                    region: document.getElementById('form-region').value, // ✅ RÉGION AJOUTÉE
                    rating: parseFloat(document.getElementById('form-larevue-rating').value) || 7,
                    userRating: parseFloat(document.getElementById('form-user-rating').value) || 7,
                    priceLevel: parseInt(document.getElementById('form-price-level').value) || 2,
                    description: document.getElementById('form-description').value,
                    // ✅ CODES PROMO
                    promoCode: document.getElementById('form-promo-code').value,
                    promoDiscount: document.getElementById('form-promo-discount').value,
                    // ✅ CHAMPS FEATURED - VALEURS EXPLICITES
                    isFeatured: isFeatured, // boolean explicite
                    reservationUrl: document.getElementById('form-reservation-url').value,
                    positiveReviews: document.getElementById('form-positive-reviews').value,
                    negativeReviews: document.getElementById('form-negative-reviews').value,
                    positiveReviewExample: document.getElementById('form-positive-example').value,
                    negativeReviewExample: document.getElementById('form-negative-example').value,
                    // ✅ IMAGES
                    images: [...existingImages, ...uploadedImageUrls],
                    // ✅ MÉTADONNÉES
                    updatedAt: new Date(),
                    city: 'Paris',
                    isActive: true,
                    averagePrice: 400,
                    priceRange: 'luxury'
                };
                
                console.log('📝 Données à sauvegarder:', formData);
                
                if (editingId) {
                    // MISE À JOUR
                    const docRef = window.firebaseModules.doc(window.firebaseApp.db, window.firebaseApp.COLLECTIONS.ESTABLISHMENTS, editingId);
                    await window.firebaseModules.updateDoc(docRef, formData);
                    showSuccess(`Établissement ${isFeatured ? '⭐ marqué comme favori' : 'modifié'} avec succès !`);
                } else {
                    // CRÉATION
                    const result = await window.addNewEstablishment(formData);
                    if (result) {
                        showSuccess(`Établissement ${isFeatured ? '⭐ créé et marqué comme favori' : 'créé'} avec succès !`);
                    } else {
                        showError('Erreur lors de la création');
                        return;
                    }
                }
                
                closeModal();
                loadDashboard();
                
            } catch (error) {
                console.error('❌ Erreur formulaire:', error);
                showError('Erreur lors de la sauvegarde: ' + error.message);
            } finally {
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        });

        // Autres fonctions utilitaires
        async function deleteEstablishment(id) {
            const est = window.currentEstablishments.find(e => e.id === id);
            if (!est) return;
            
            if (!confirm(`Êtes-vous sûr de vouloir supprimer "${est.name}" ?`)) return;
            
            const success = await window.deleteEstablishment(id);
            if (success) {
                showSuccess('Établissement supprimé !');
                loadDashboard();
            } else {
                showError('Erreur lors de la suppression');
            }
        }

        async function recalculateRankings() {
            if (!confirm('Recalculer automatiquement tous les classements ?')) return;
            
            showLoading(true);
            
            try {
                const sorted = [...window.currentEstablishments].sort((a, b) => {
                    const scoreA = parseFloat(calculateScore(a));
                    const scoreB = parseFloat(calculateScore(b));
                    return scoreB - scoreA;
                });
                
                for (let i = 0; i < sorted.length; i++) {
                    await window.updateEstablishmentRank(sorted[i].id, i + 1);
                }
                
                showSuccess('Classements recalculés !');
                loadDashboard();
            } catch (error) {
                showError('Erreur lors du recalcul');
            } finally {
                showLoading(false);
            }
        }

        function exportData() {
            const data = {
                type: currentTab,
                establishments: window.currentEstablishments,
                exportDate: new Date().toISOString(),
                stats: window.currentStats
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `larevue-${currentTab}-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            showSuccess('Données exportées !');
        }

        function filterEstablishments() {
            const query = document.getElementById('search-input').value.toLowerCase();
            const items = document.querySelectorAll('.ranking-item');
            
            items.forEach(item => {
                const text = item.textContent.toLowerCase();
                const visible = text.includes(query);
                item.style.display = visible ? 'block' : 'none';
            });
        }

        // ✅ FONCTION SUPPRIMER IMAGE EXISTANTE
        function removeExistingImage(establishmentId, imageIndex) {
            if (!confirm('Supprimer cette image ?')) return;
            
            const est = window.currentEstablishments.find(e => e.id === establishmentId);
            if (!est || !est.images) return;
            
            // Supprimer l'image de l'array
            est.images.splice(imageIndex, 1);
            
            // Mettre à jour en base
            const docRef = window.firebaseModules.doc(window.firebaseApp.db, window.firebaseApp.COLLECTIONS.ESTABLISHMENTS, establishmentId);
            window.firebaseModules.updateDoc(docRef, { images: est.images }).then(() => {
                showSuccess('Image supprimée !');
                // Recharger l'affichage des images dans le modal
                editEstablishment(establishmentId);
            }).catch(error => {
                console.error('❌ Erreur suppression image:', error);
                showError('Erreur lors de la suppression de l\'image');
            });
        }

        function showSuccess(message) {
            console.log('✅', message);
            // Notification moderne
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-green-600 text-white px-6 py-3 rounded-lg shadow-lg z-50 fade-in';
            notification.innerHTML = `<i class="fas fa-check mr-2"></i>${message}`;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        function showError(message) {
            console.error('❌', message);
            // Notification moderne
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-red-600 text-white px-6 py-3 rounded-lg shadow-lg z-50 fade-in';
            notification.innerHTML = `<i class="fas fa-exclamation-triangle mr-2"></i>${message}`;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 5000);
        }

        // Event listeners
        document.getElementById('edit-modal').addEventListener('click', (e) => {
            if (e.target === e.currentTarget) {
                closeModal();
            }
        });

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeModal();
            }
            if (e.ctrlKey || e.metaKey) {
                if (e.key === 'n') {
                    e.preventDefault();
                    openAddModal();
                }
                if (e.key === 'r') {
                    e.preventDefault();
                    loadDashboard();
                }
            }
        });

        // ✅ GESTION AUTOMATIQUE DU FEATURED
        document.getElementById('form-is-featured').addEventListener('change', function(e) {
            const featuredSections = document.querySelectorAll('.bg-yellow-500.bg-opacity-20');
            if (e.target.checked) {
                // Avertir l'utilisateur
                if (!confirm('⚠️ Attention : Un seul établissement peut être "Notre Hôtel Favori du Moment" à la fois.\n\nEn activant cette option, tous les autres établissements perdront ce statut.\n\nContinuer ?')) {
                    e.target.checked = false;
                    return;
                }
                
                // Afficher les champs supplémentaires comme requis
                featuredSections.forEach(section => {
                    const inputs = section.querySelectorAll('input');
                    inputs.forEach(input => {
                        if (input.type !== 'checkbox') {
                            input.required = true;
                        }
                    });
                });
            } else {
                // Retirer le required
                featuredSections.forEach(section => {
                    const inputs = section.querySelectorAll('input');
                    inputs.forEach(input => {
                        if (input.type !== 'checkbox') {
                            input.required = false;
                        }
                    });
                });
            }
        });

        // ✅ VALIDATION DYNAMIQUE DES NOTES
        document.getElementById('form-larevue-rating').addEventListener('input', function(e) {
            const value = parseFloat(e.target.value);
            if (value < 0 || value > 10) {
                e.target.setCustomValidity('La note doit être entre 0 et 10');
            } else {
                e.target.setCustomValidity('');
            }
        });

        document.getElementById('form-user-rating').addEventListener('input', function(e) {
            const value = parseFloat(e.target.value);
            if (value < 0 || value > 10) {
                e.target.setCustomValidity('La note doit être entre 0 et 10');
            } else {
                e.target.setCustomValidity('');
            }
        });

        // ✅ PREVIEW EN TEMPS RÉEL DU SCORE CALCULÉ
        function updateScorePreview() {
            const userRating = parseFloat(document.getElementById('form-user-rating').value) || 7;
            const laRevueRating = parseFloat(document.getElementById('form-larevue-rating').value) || 7;
            const calculatedScore = ((userRating * 0.6) + (laRevueRating * 0.4)).toFixed(1);
            
            // Créer ou mettre à jour l'affichage du score
            let scorePreview = document.getElementById('score-preview');
            if (!scorePreview) {
                scorePreview = document.createElement('div');
                scorePreview.id = 'score-preview';
                scorePreview.className = 'mt-4 p-4 bg-gray-700 rounded-lg border border-gray-600';
                scorePreview.innerHTML = `
                    <h5 class="text-sm font-semibold text-gray-300 mb-2">
                        <i class="fas fa-calculator mr-2"></i>Aperçu du score final
                    </h5>
                    <div class="text-2xl font-bold text-green-400" id="calculated-score">${calculatedScore}</div>
                    <p class="text-xs text-gray-400 mt-1">
                        Formule: (Note utilisateurs × 0.6) + (Note La Revue × 0.4)
                    </p>
                `;
                
                // Insérer après le grid des notes
                const notesGrid = document.getElementById('form-user-rating').closest('.grid');
                notesGrid.parentNode.insertBefore(scorePreview, notesGrid.nextSibling);
            } else {
                document.getElementById('calculated-score').textContent = calculatedScore;
            }
        }

        // Ajouter les listeners pour le calcul en temps réel
        document.getElementById('form-user-rating').addEventListener('input', updateScorePreview);
        document.getElementById('form-larevue-rating').addEventListener('input', updateScorePreview);

        // ✅ VALIDATION DES CODES PROMO
        document.getElementById('form-promo-code').addEventListener('input', function(e) {
            const value = e.target.value.toUpperCase();
            e.target.value = value;
            
            // Validation du format (lettres et chiffres seulement)
            if (value && !/^[A-Z0-9]+$/.test(value)) {
                e.target.setCustomValidity('Le code promo ne doit contenir que des lettres et des chiffres');
            } else {
                e.target.setCustomValidity('');
            }
        });

        document.getElementById('form-promo-discount').addEventListener('input', function(e) {
            const value = e.target.value;
            
            // Validation du format (nombre + % ou nombre + €)
            if (value && !/^\d+[%€]?$/.test(value)) {
                e.target.setCustomValidity('Format: "20%" ou "50€" ou "20"');
            } else {
                e.target.setCustomValidity('');
            }
        });

        // ✅ AUTO-GÉNÉRATION DU CODE PROMO
        document.getElementById('form-name').addEventListener('input', function(e) {
            const name = e.target.value;
            const promoCodeField = document.getElementById('form-promo-code');
            
            // Générer un code promo automatiquement si le champ est vide
            if (name && !promoCodeField.value) {
                const words = name.split(' ');
                let code = '';
                
                if (words.length >= 2) {
                    // Prendre les 3 premières lettres de chaque mot
                    code = words.slice(0, 2).map(word => word.slice(0, 3).toUpperCase()).join('');
                } else {
                    // Prendre les 6 premières lettres
                    code = name.slice(0, 6).toUpperCase();
                }
                
                // Ajouter un nombre aléatoire
                code += Math.floor(Math.random() * 90) + 10;
                
                promoCodeField.value = code;
            }
        });

        // ✅ INITIALISATION AU CHARGEMENT
        window.addEventListener('load', function() {
            console.log('🎉 Dashboard La Revue initialisé avec succès !');
            
            // Charger les données initiales
            loadDashboard();
            
            // Afficher un message de bienvenue
            setTimeout(() => {
                showSuccess('Dashboard connecté à Firebase ! 🔥');
            }, 1000);
        });

        // ✅ GESTION DES ERREURS GLOBALES
        window.addEventListener('error', function(e) {
            console.error('❌ Erreur globale:', e.error);
            showError('Une erreur inattendue s\'est produite');
        });

        // ✅ FONCTION UTILITAIRE POUR FORMATER LES RÉGIONS
        function formatRegion(region) {
            if (!region) return 'Région non définie';
            
            const regionNames = {
                'ile-de-france': 'Île-de-France',
                'provence-alpes-cote-azur': 'Provence-Alpes-Côte d\'Azur',
                'nouvelle-aquitaine': 'Nouvelle-Aquitaine',
                'occitanie': 'Occitanie',
                'auvergne-rhone-alpes': 'Auvergne-Rhône-Alpes',
                'normandie': 'Normandie',
                'bretagne': 'Bretagne',
                'pays-de-la-loire': 'Pays de la Loire',
                'centre-val-de-loire': 'Centre-Val de Loire',
                'bourgogne-franche-comte': 'Bourgogne-Franche-Comté',
                'grand-est': 'Grand Est',
                'hauts-de-france': 'Hauts-de-France',
                'corse': 'Corse'
            };
            
            return regionNames[region] || region.split('-').map(word => 
                word.charAt(0).toUpperCase() + word.slice(1)
            ).join(' ');
        }

        // ✅ FONCTION POUR COPIER LES DONNÉES D'UN ÉTABLISSEMENT
        function copyEstablishment(id) {
            const est = window.currentEstablishments.find(e => e.id === id);
            if (!est) return;
            
            const data = {
                name: est.name,
                category: est.category,
                address: est.address,
                region: est.region,
                description: est.description,
                promoCode: est.promoCode,
                promoDiscount: est.promoDiscount
            };
            
            navigator.clipboard.writeText(JSON.stringify(data, null, 2)).then(() => {
                showSuccess('Données copiées dans le presse-papiers !');
            }).catch(() => {
                showError('Erreur lors de la copie');
            });
        }

        // ✅ RACCOURCIS CLAVIER AVANCÉS
        document.addEventListener('keydown', function(e) {
            // Ctrl/Cmd + S pour sauvegarder (si modal ouvert)
            if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                e.preventDefault();
                const modal = document.getElementById('edit-modal');
                if (!modal.classList.contains('hidden')) {
                    document.getElementById('establishment-form').dispatchEvent(new Event('submit'));
                }
            }
            
            // Ctrl/Cmd + D pour dupliquer l'établissement sélectionné
            if ((e.ctrlKey || e.metaKey) && e.key === 'd') {
                e.preventDefault();
                const selected = document.querySelector('.ranking-item:hover');
                if (selected) {
                    const id = selected.id.replace('item-', '');
                    copyEstablishment(id);
                }
            }
            
            // F5 pour actualiser les données
            if (e.key === 'F5') {
                e.preventDefault();
                loadDashboard();
            }
        });

        console.log('✅ Dashboard Admin La Revue - Chargé avec succès !');
        console.log('🚀 Fonctionnalités disponibles:');
        console.log('   - Gestion complète des établissements');
        console.log('   - Section "Notre Hôtel Favori du Moment"');
        console.log('   - Upload d\'images multiples');
        console.log('   - Codes promo Premium');
        console.log('   - Filtres par région');
        console.log('   - Scores et classements automatiques');
        console.log('   - Synchronisation Firebase temps réel');
    </script>

</body>
</html>
